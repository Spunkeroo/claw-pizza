<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#E63946">
<meta name="description" content="Play free online claw machine games and win virtual prizes! Fun arcade gameplay, no download needed. Provably fair.">
<meta name="keywords" content="claw machine online, win prizes free, online arcade, claw game, grab prizes, free claw machine, claw pizza">
<meta property="og:title" content="Claw.Pizza - Grab Your Slice. Free Claw Machine Game.">
<meta property="og:description" content="Free online claw machine game. Play now - no download needed!">
<meta property="og:image" content="https://claw.pizza/og-image.png">
<meta property="og:url" content="https://claw.pizza/">
<meta property="og:type" content="website">
<meta property="og:site_name" content="Claw.Pizza">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@SpunkArt13">
<meta name="twitter:title" content="Claw.Pizza - Free Online Claw Machine Game">
<meta name="twitter:description" content="Grab plushies, toys & more in our free online claw machines. Provably fair, instant play!">
<meta name="twitter:image" content="https://claw.pizza/og-image.png">
<link rel="canonical" href="https://claw.pizza/">
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="/icons/icon-192.png">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçï</text></svg>">
<title>Claw.Pizza - Free Online Claw Machine Game</title>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "Claw.Pizza",
  "url": "https://claw.pizza/",
  "description": "Free online claw machine game - provably fair arcade fun",
  "applicationCategory": "GameApplication",
  "operatingSystem": "Any",
  "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD" },
  "author": { "@type": "Organization", "name": "Spunkeroo", "url": "https://spunk.codes" }
}
</script>
<style>
:root {
  --pepperoni: #E63946;
  --mozzarella: #FFB703;
  --basil: #2DC653;
  --bg: #0a0a0f;
  --surface: #1a1a2e;
  --text: #f0f0f0;
  --text-dim: #888;
  --radius: 12px;
  --radius-sm: 8px;
  --radius-lg: 20px;
  --shadow: 0 4px 24px rgba(0,0,0,0.4);
  --glass: rgba(26,26,46,0.7);
  --glass-border: rgba(255,255,255,0.08);
  --transition: 0.3s ease;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; -webkit-text-size-adjust: 100%; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  overflow-x: hidden;
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
}
::selection { background: var(--pepperoni); color: #fff; }
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--surface); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: #2a2a4e; }
a { color: var(--mozzarella); text-decoration: none; transition: color var(--transition); }
a:hover { color: var(--pepperoni); }
button { font-family: inherit; cursor: pointer; border: none; outline: none; }
button:focus-visible, a:focus-visible, input:focus-visible { outline: 2px solid var(--mozzarella); outline-offset: 2px; }
img { max-width: 100%; display: block; }
input, select, textarea {
  font-family: inherit; font-size: 1rem; background: var(--surface);
  color: var(--text); border: 1px solid var(--glass-border); border-radius: var(--radius-sm);
  padding: 0.75rem 1rem; transition: border-color var(--transition);
}
input:focus, select:focus, textarea:focus { border-color: var(--mozzarella); outline: none; }

/* ---- Animations ---- */
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.05); } }
@keyframes glow-pulse {
  0%,100% { box-shadow: 0 0 20px rgba(230,57,70,0.4); }
  50% { box-shadow: 0 0 40px rgba(230,57,70,0.7); }
}
@keyframes shimmer {
  0% { background-position: -200% center; }
  100% { background-position: 200% center; }
}
@keyframes float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
@keyframes slide-up { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
@keyframes slide-in-right { from { transform: translateX(120%); } to { transform: translateX(0); } }
@keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
@keyframes fade-out { from { opacity: 1; } to { opacity: 0; } }
@keyframes progress-fill { from { width: 0; } to { width: 100%; } }
@keyframes ticker-scroll { from { transform: translateY(0); } to { transform: translateY(-50%); } }
@keyframes grab-ready-pulse {
  0%,100% { transform: scale(1); box-shadow: 0 0 30px rgba(230,57,70,0.4); }
  50% { transform: scale(1.12); box-shadow: 0 0 50px rgba(230,57,70,0.8), 0 0 80px rgba(255,183,3,0.3); }
}
@keyframes crosshair-pulse {
  0%,100% { opacity: 0.7; transform: translate(-50%,-50%) scale(1); }
  50% { opacity: 1; transform: translate(-50%,-50%) scale(1.15); }
}
@keyframes target-pulse {
  0%,100% { box-shadow: 0 0 20px rgba(230,57,70,0.4), inset 0 0 10px rgba(230,57,70,0.2); transform: translate(-50%,-50%) scale(1); }
  50% { box-shadow: 0 0 40px rgba(230,57,70,0.7), inset 0 0 20px rgba(230,57,70,0.3); transform: translate(-50%,-50%) scale(1.08); }
}
@keyframes countdown-pop {
  0% { opacity: 0; transform: translate(-50%,-50%) scale(0.3); }
  40% { opacity: 1; transform: translate(-50%,-50%) scale(1.15); }
  100% { opacity: 0.9; transform: translate(-50%,-50%) scale(1); }
}
@keyframes countdown-fade {
  0% { opacity: 0.9; transform: translate(-50%,-50%) scale(1); }
  100% { opacity: 0; transform: translate(-50%,-50%) scale(0.8); }
}
@keyframes tap-instruction-float {
  0%,100% { transform: translateX(-50%) translateY(0); }
  50% { transform: translateX(-50%) translateY(-6px); }
}
@keyframes tutorial-hand-bounce {
  0%,100% { transform: translateY(0); }
  50% { transform: translateY(-12px); }
}
@keyframes tutorial-fade-in { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes card-lift { from { transform: translateY(0) scale(1); } to { transform: translateY(-4px) scale(1.02); } }
@keyframes confetti-border {
  0% { border-color: var(--pepperoni); }
  33% { border-color: var(--mozzarella); }
  66% { border-color: var(--basil); }
  100% { border-color: var(--pepperoni); }
}
@keyframes streak-glow {
  0%,100% { box-shadow: 0 0 4px var(--basil); }
  50% { box-shadow: 0 0 12px var(--basil); }
}
@keyframes tab-indicator { from { transform: scaleX(0); } to { transform: scaleX(1); } }
@keyframes counter-up { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* ---- Loading Screen ---- */
#loading-screen {
  position: fixed; inset: 0; z-index: 9999; background: var(--bg);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  transition: opacity 0.5s ease;
}
#loading-screen.loaded { opacity: 0; pointer-events: none; }
.loading-pizza {
  width: 80px; height: 80px; animation: spin 1.2s linear infinite;
}
.loading-pizza svg { width: 100%; height: 100%; }
.loading-tagline { font-size: 1.5rem; font-weight: 700; margin-top: 1.5rem;
  background: linear-gradient(90deg, var(--pepperoni), var(--mozzarella));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
}
.loading-bar-track { width: 200px; height: 4px; background: var(--surface); border-radius: 2px; margin-top: 1.5rem; overflow: hidden; }
.loading-bar-fill { height: 100%; background: linear-gradient(90deg, var(--pepperoni), var(--mozzarella)); border-radius: 2px; animation: progress-fill 2s ease forwards; }

/* ---- Top Nav ---- */
.top-nav {
  position: fixed; top: 0; left: 0; right: 0; z-index: 100;
  height: 64px; display: flex; align-items: center; justify-content: space-between;
  padding: 0 1.5rem;
  background: rgba(10,10,15,0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--glass-border);
}
.nav-logo { display: flex; align-items: center; gap: 0.5rem; font-weight: 800; font-size: 1.25rem; color: var(--text); }
.nav-logo svg { width: 36px; height: 36px; }
.nav-links { display: flex; gap: 1.5rem; list-style: none; }
.nav-links a { color: var(--text-dim); font-weight: 500; font-size: 0.9rem; transition: color var(--transition); position: relative; }
.nav-links a:hover, .nav-links a.active { color: var(--text); }
.nav-links a.active::after { content: ''; position: absolute; bottom: -4px; left: 0; right: 0; height: 2px; background: var(--pepperoni); border-radius: 1px; animation: tab-indicator 0.3s ease; }
.nav-right { display: flex; align-items: center; gap: 1rem; }
.credit-display {
  display: flex; align-items: center; gap: 0.4rem; background: var(--surface);
  padding: 0.4rem 0.8rem; border-radius: 20px; font-weight: 600; font-size: 0.9rem;
  border: 1px solid var(--glass-border);
}
.credit-display svg { width: 18px; height: 18px; }
.credit-display span { color: var(--mozzarella); }
.nav-profile { width: 36px; height: 36px; border-radius: 50%; background: var(--surface); border: 2px solid var(--glass-border); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: border-color var(--transition); }
.nav-profile:hover { border-color: var(--mozzarella); }
.nav-profile svg { width: 20px; height: 20px; color: var(--text-dim); }
.btn-buy-credits {
  background: var(--pepperoni); color: #fff; padding: 0.5rem 1.2rem;
  border-radius: 20px; font-weight: 700; font-size: 0.85rem;
  animation: glow-pulse 2s ease-in-out infinite;
  transition: transform var(--transition);
}
.btn-buy-credits:hover { transform: scale(1.05); }

/* ---- Bottom Tab Bar (mobile) ---- */
.bottom-tabs {
  display: none; position: fixed; bottom: 0; left: 0; right: 0; z-index: 100;
  background: rgba(10,10,15,0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  border-top: 1px solid var(--glass-border);
  padding-bottom: env(safe-area-inset-bottom, 0);
}
.bottom-tabs-inner { display: flex; justify-content: space-around; align-items: center; height: 56px; }
.tab-item {
  display: flex; flex-direction: column; align-items: center; gap: 2px;
  color: var(--text-dim); font-size: 0.65rem; font-weight: 500;
  padding: 0.25rem 0.5rem; transition: color var(--transition); background: none;
  -webkit-tap-highlight-color: transparent;
}
.tab-item svg { width: 24px; height: 24px; transition: color var(--transition); }
.tab-item.active, .tab-item.active svg { color: var(--pepperoni); }
.tab-item:active { transform: scale(0.95); }

/* ---- Main Content ---- */
.main-content { padding-top: 64px; min-height: 100vh; }
.page { display: none; }
.page.active { display: block; }
.container { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }
.section { padding: 3rem 0; }
.section-header { text-align: center; margin-bottom: 2rem; }
.section-title { font-size: 1.75rem; font-weight: 800; margin-bottom: 0.5rem; }
.section-subtitle { color: var(--text-dim); font-size: 1rem; }

/* ---- Buttons ---- */
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
  padding: 0.75rem 1.5rem; border-radius: var(--radius-sm); font-weight: 700;
  font-size: 0.95rem; transition: all var(--transition); transform: translateZ(0);
}
.btn-primary { background: var(--pepperoni); color: #fff; }
.btn-primary:hover { background: #d32f3f; transform: translateY(-2px); box-shadow: 0 8px 24px rgba(230,57,70,0.3); }
.btn-outline { background: transparent; color: var(--text); border: 2px solid var(--glass-border); }
.btn-outline:hover { border-color: var(--mozzarella); color: var(--mozzarella); }
.btn-secondary { background: var(--surface); color: var(--text); border: 1px solid var(--glass-border); }
.btn-secondary:hover { border-color: var(--text-dim); }
.btn-sm { padding: 0.5rem 1rem; font-size: 0.8rem; }
.btn-lg { padding: 1rem 2rem; font-size: 1.1rem; border-radius: var(--radius); }
.btn-glow { animation: glow-pulse 2s ease-in-out infinite; }

/* ---- Cards ---- */
.card {
  background: var(--glass); border: 1px solid var(--glass-border);
  border-radius: var(--radius); padding: 1.25rem;
  backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
  transition: transform var(--transition), box-shadow var(--transition);
}
.card:hover { transform: translateY(-4px); box-shadow: var(--shadow); }

/* ---- Badges ---- */
.badge { display: inline-flex; align-items: center; padding: 0.2rem 0.6rem; border-radius: 20px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
.badge-breadstick { background: rgba(255,183,3,0.15); color: var(--mozzarella); }
.badge-slice { background: rgba(230,57,70,0.15); color: var(--pepperoni); }
.badge-halfpie { background: rgba(45,198,83,0.15); color: var(--basil); }
.badge-fullpie { background: rgba(100,100,255,0.15); color: #8888ff; }
.badge-supreme { background: linear-gradient(135deg, rgba(230,57,70,0.2), rgba(255,183,3,0.2)); color: #fff; border: 1px solid rgba(255,183,3,0.3); }

/* ---- HERO ---- */
.hero { text-align: center; padding: 4rem 1rem 3rem; position: relative; overflow: hidden; }
.hero::before {
  content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
  background: radial-gradient(circle at 50% 50%, rgba(230,57,70,0.08) 0%, transparent 50%);
  pointer-events: none;
}
.hero-headline {
  font-size: clamp(2.5rem, 6vw, 4.5rem); font-weight: 900; line-height: 1.1;
  margin-bottom: 1rem;
  background: linear-gradient(135deg, var(--pepperoni), var(--mozzarella), var(--pepperoni));
  background-size: 200% auto;
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: shimmer 4s linear infinite;
}
.hero-subtitle { font-size: clamp(1rem, 2.5vw, 1.3rem); color: var(--text-dim); margin-bottom: 2rem; max-width: 500px; margin-left: auto; margin-right: auto; }
.hero-ctas { display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin-bottom: 3rem; }
.stats-row { display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; }
.stat-item { text-align: center; animation: counter-up 0.6s ease forwards; }
.stat-value { font-size: 1.75rem; font-weight: 800; color: var(--mozzarella); }
.stat-label { font-size: 0.8rem; color: var(--text-dim); }

/* ---- Featured Carousel ---- */
.carousel-section { padding: 2rem 0; }
.carousel-track {
  display: flex; gap: 1rem; overflow-x: auto; scroll-snap-type: x mandatory;
  padding: 1rem; -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
}
.carousel-track::-webkit-scrollbar { display: none; }
.machine-card-carousel {
  flex: 0 0 280px; scroll-snap-align: start;
  background: var(--glass); border: 1px solid var(--glass-border);
  border-radius: var(--radius); overflow: hidden;
  transition: transform var(--transition), box-shadow var(--transition);
}
.machine-card-carousel:hover { transform: translateY(-4px); box-shadow: var(--shadow); }
.machine-card-img {
  height: 180px; background: linear-gradient(135deg, var(--surface), #2a2a4e);
  display: flex; align-items: center; justify-content: center; position: relative;
}
.machine-card-img svg { width: 64px; height: 64px; opacity: 0.3; }
.machine-card-body { padding: 1rem; }
.machine-card-name { font-weight: 700; font-size: 1rem; margin-bottom: 0.25rem; }
.machine-card-cost { color: var(--text-dim); font-size: 0.85rem; margin-bottom: 0.75rem; }
.machine-card-btn { width: 100%; padding: 0.6rem; background: var(--pepperoni); color: #fff; border-radius: var(--radius-sm); font-weight: 700; font-size: 0.85rem; transition: background var(--transition); }
.machine-card-btn:hover { background: #d32f3f; }

/* ---- Live Feed ---- */
.live-feed { background: var(--surface); border-radius: var(--radius); border: 1px solid var(--glass-border); overflow: hidden; max-height: 320px; position: relative; }
.live-feed-header { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; border-bottom: 1px solid var(--glass-border); }
.live-indicator { display: flex; align-items: center; gap: 0.4rem; font-weight: 700; font-size: 0.85rem; color: var(--pepperoni); }
.live-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--pepperoni); animation: pulse 1.5s ease infinite; }
.live-feed-list { padding: 0.5rem; overflow: hidden; }
.live-feed-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; border-radius: var(--radius-sm); transition: background var(--transition); }
.live-feed-item:hover { background: rgba(255,255,255,0.03); }
.live-avatar { width: 36px; height: 36px; border-radius: 50%; flex-shrink: 0; }
.live-feed-info { flex: 1; min-width: 0; }
.live-feed-name { font-weight: 600; font-size: 0.85rem; }
.live-feed-prize { font-size: 0.8rem; color: var(--mozzarella); }
.live-feed-time { font-size: 0.7rem; color: var(--text-dim); flex-shrink: 0; }

/* ---- Auto-Update Live Sections ---- */
.live-bar {
  display: flex; align-items: center; justify-content: center; gap: 2rem; flex-wrap: wrap;
  background: linear-gradient(135deg, rgba(230,57,70,0.08), rgba(255,183,3,0.08));
  border: 1px solid var(--glass-border); border-radius: var(--radius);
  padding: 1rem 1.5rem; margin-bottom: 1rem;
}
.live-bar-item {
  display: flex; align-items: center; gap: 0.5rem; font-size: 0.95rem; font-weight: 600;
  white-space: nowrap;
}
.live-bar-value { color: var(--mozzarella); font-weight: 800; font-size: 1.1rem; }
.live-bar-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--basil); animation: pulse 1.5s ease infinite; }

.winners-ticker-wrap {
  overflow: hidden; position: relative;
  background: var(--surface); border: 1px solid var(--glass-border); border-radius: var(--radius);
  padding: 0.75rem 0; margin-bottom: 1.5rem;
}
.winners-ticker-track {
  display: flex; gap: 3rem; animation: ticker-h-scroll 30s linear infinite; white-space: nowrap;
}
.winners-ticker-item { font-size: 0.85rem; color: var(--text); flex-shrink: 0; }
.winners-ticker-item .winner-prize { color: var(--mozzarella); font-weight: 600; }
@keyframes ticker-h-scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }

.stats-counter-grid {
  display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;
}
.stats-counter-card {
  background: var(--glass); border: 1px solid var(--glass-border); border-radius: var(--radius);
  padding: 1.25rem; text-align: center; transition: transform var(--transition);
}
.stats-counter-card:hover { transform: translateY(-2px); }
.stats-counter-val { font-size: 1.6rem; font-weight: 800; color: var(--mozzarella); margin-bottom: 0.25rem; }
.stats-counter-label { font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }

.news-ticker-section { margin-bottom: 1.5rem; }
.news-ticker-header {
  display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;
  font-weight: 700; font-size: 0.9rem; color: var(--pepperoni);
}
.news-ticker-list {
  background: var(--surface); border: 1px solid var(--glass-border); border-radius: var(--radius);
  padding: 0.75rem 1rem; min-height: 44px; overflow: hidden; position: relative;
}
.news-ticker-item {
  display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem;
  animation: fade-in 0.4s ease;
}
.news-ticker-item .news-time { color: var(--text-dim); font-size: 0.75rem; flex-shrink: 0; }
.news-ticker-item .news-badge {
  background: var(--pepperoni); color: #fff; font-size: 0.65rem; font-weight: 700;
  padding: 2px 6px; border-radius: 4px; flex-shrink: 0; text-transform: uppercase;
}

.prize-pool-bar {
  display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;
  background: linear-gradient(135deg, rgba(45,198,83,0.08), rgba(255,183,3,0.08));
  border: 1px solid rgba(45,198,83,0.2); border-radius: var(--radius);
  padding: 1rem 1.5rem; margin-bottom: 1.5rem;
}
.prize-pool-count { font-size: 1.3rem; font-weight: 800; color: var(--basil); }
.prize-pool-timer { font-size: 0.8rem; color: var(--text-dim); }

@media (max-width: 768px) {
  .live-bar { gap: 1rem; padding: 0.75rem 1rem; flex-direction: column; }
  .stats-counter-grid { grid-template-columns: 1fr; }
}
@media (min-width: 768px) {
  .stats-counter-grid { grid-template-columns: repeat(3, 1fr); }
}

/* ---- Faucet Banner ---- */
.faucet-banner {
  background: linear-gradient(135deg, rgba(230,57,70,0.1), rgba(255,183,3,0.1));
  border: 1px solid rgba(255,183,3,0.2); border-radius: var(--radius);
  padding: 1.5rem; display: flex; align-items: center; justify-content: space-between;
  flex-wrap: wrap; gap: 1rem;
}
.faucet-text h3 { font-size: 1.1rem; font-weight: 700; }
.faucet-text p { color: var(--text-dim); font-size: 0.85rem; }
.faucet-timer { font-size: 1.5rem; font-weight: 800; font-variant-numeric: tabular-nums; color: var(--mozzarella); }

/* ---- Waitlist ---- */
.waitlist-section { text-align: center; padding: 3rem 1rem; }
.waitlist-form { display: flex; gap: 0.5rem; max-width: 420px; margin: 1.5rem auto 0; }
.waitlist-form input { flex: 1; }
.waitlist-form .btn { flex-shrink: 0; }

/* ---- Machines Page ---- */
.filter-tabs { display: flex; gap: 0.5rem; overflow-x: auto; padding-bottom: 0.5rem; margin-bottom: 1.5rem; scrollbar-width: none; }
.filter-tabs::-webkit-scrollbar { display: none; }
.filter-tab {
  padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600;
  background: var(--surface); color: var(--text-dim); border: 1px solid var(--glass-border);
  white-space: nowrap; transition: all var(--transition); cursor: pointer;
}
.filter-tab.active, .filter-tab:hover { background: var(--pepperoni); color: #fff; border-color: var(--pepperoni); }
.machine-grid { display: grid; grid-template-columns: 1fr; gap: 1.25rem; }
.machine-card {
  background: var(--glass); border: 1px solid var(--glass-border); border-radius: var(--radius);
  overflow: hidden; backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
  transition: transform var(--transition), box-shadow var(--transition);
}
.machine-card:hover { transform: translateY(-4px); box-shadow: var(--shadow); }
.machine-3d-container { height: 200px; background: linear-gradient(135deg, var(--surface), #2a2a4e); display: flex; align-items: center; justify-content: center; position: relative; }
.machine-3d-container svg { width: 72px; height: 72px; opacity: 0.25; }
.machine-card-content { padding: 1.25rem; }
.machine-meta { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem; }
.machine-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 0.5rem; }
.machine-stats { display: flex; gap: 1rem; margin-bottom: 1rem; }
.machine-stat { font-size: 0.8rem; color: var(--text-dim); }
.machine-stat strong { color: var(--text); }
.machine-card-actions { display: flex; gap: 0.5rem; align-items: center; }
.machine-card-actions .btn { flex: 1; }

/* ---- Play Page (Toreba-style 2-button) ---- */
#page-play { position: relative; }
.play-canvas-container {
  width: 100%; height: calc(100vh - 64px); background: #000;
  position: relative; overflow: hidden;
}
.play-canvas-container canvas { position: absolute; top: 0; left: 0; width: 100% !important; height: 100% !important; }
.play-canvas-container.crosshair-cursor canvas { cursor: crosshair; }

/* HUD overlay */
.play-hud {
  position: absolute; inset: 0; pointer-events: none;
  display: flex; flex-direction: column; justify-content: space-between;
  padding: 0.75rem; z-index: 10;
}
.hud-top {
  display: flex; justify-content: space-between; align-items: flex-start;
  pointer-events: auto; gap: 0.5rem;
}
.hud-top-left { display: flex; gap: 0.5rem; align-items: center; }
.hud-credits {
  background: var(--glass); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
  padding: 0.4rem 0.8rem; border-radius: 20px; font-weight: 700; font-size: 0.9rem;
  border: 1px solid var(--glass-border); display: flex; align-items: center; gap: 0.3rem;
}
.hud-machine-name {
  background: var(--glass); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
  padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.8rem;
  border: 1px solid var(--glass-border);
}
.hud-top-right { display: flex; gap: 0.5rem; align-items: center; }
.hud-win-rate {
  background: rgba(45,198,83,0.15); border: 1px solid rgba(45,198,83,0.3);
  padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;
  color: var(--basil); pointer-events: auto;
}
.hud-sound-btn {
  width: 36px; height: 36px; border-radius: 50%; background: var(--glass);
  backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
  border: 1px solid var(--glass-border); display: flex; align-items: center;
  justify-content: center; pointer-events: auto; color: var(--text); font-size: 1.1rem;
  transition: background var(--transition);
}
.hud-sound-btn:hover { background: rgba(255,255,255,0.1); }
.hud-sound-btn.muted { color: var(--text-dim); }

/* Center status area */
.hud-center {
  position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
  pointer-events: none; z-index: 15; text-align: center;
}
.hud-countdown {
  font-size: 4rem; font-weight: 900; color: var(--mozzarella);
  text-shadow: 0 0 30px rgba(255,183,3,0.6), 0 4px 8px rgba(0,0,0,0.8);
  opacity: 0; transition: opacity 0.2s ease; pointer-events: none;
}
.hud-countdown.visible { opacity: 1; animation: pulse 0.4s ease; }
.hud-phase-label {
  font-size: 1rem; font-weight: 700; color: #fff;
  text-shadow: 0 2px 8px rgba(0,0,0,0.8);
  margin-top: 0.5rem; opacity: 0; transition: opacity 0.3s ease;
}
.hud-phase-label.visible { opacity: 1; }

/* Bottom controls area */
.hud-bottom {
  display: flex; flex-direction: column; align-items: center; gap: 0.75rem;
  pointer-events: auto; padding-bottom: env(safe-area-inset-bottom, 0);
}

/* Toreba-style directional buttons */
.toreba-controls { display: flex; flex-direction: column; gap: 0.5rem; width: 100%; max-width: 400px; }

.toreba-btn {
  width: 100%; height: 80px; border-radius: 16px; font-weight: 800; font-size: 1.1rem;
  color: #fff; letter-spacing: 1px; text-transform: uppercase;
  display: flex; align-items: center; justify-content: center; gap: 0.75rem;
  transition: transform 0.1s ease, box-shadow 0.1s ease;
  -webkit-tap-highlight-color: transparent; touch-action: manipulation;
  user-select: none; -webkit-user-select: none;
  position: relative; overflow: hidden;
}
.toreba-btn:active { transform: scale(0.97); }

.toreba-btn-lr {
  background: linear-gradient(135deg, #2563eb, #3b82f6);
  box-shadow: 0 4px 20px rgba(37,99,235,0.4);
}
.toreba-btn-lr:active, .toreba-btn-lr.active {
  background: linear-gradient(135deg, #1d4ed8, #2563eb);
  box-shadow: 0 2px 30px rgba(37,99,235,0.7);
}

.toreba-btn-fb {
  background: linear-gradient(135deg, #7c3aed, #8b5cf6);
  box-shadow: 0 4px 20px rgba(124,58,237,0.4);
}
.toreba-btn-fb:active, .toreba-btn-fb.active {
  background: linear-gradient(135deg, #6d28d9, #7c3aed);
  box-shadow: 0 2px 30px rgba(124,58,237,0.7);
}

.toreba-btn-drop {
  background: linear-gradient(135deg, var(--pepperoni), #ff4444);
  box-shadow: 0 4px 20px rgba(230,57,70,0.5);
  animation: glow-pulse 1.5s ease infinite;
  height: 70px; font-size: 1.3rem;
}
.toreba-btn-drop:active {
  animation: none;
  box-shadow: 0 2px 30px rgba(230,57,70,0.8);
}

.toreba-btn-play {
  background: linear-gradient(135deg, var(--basil), #34d058);
  box-shadow: 0 4px 20px rgba(45,198,83,0.4);
  animation: glow-pulse 2s ease infinite;
  height: 80px; font-size: 1.4rem;
}
.toreba-btn-play:active {
  animation: none;
  transform: scale(0.97);
}

.toreba-btn .btn-arrows { font-size: 1.4rem; opacity: 0.9; }
.toreba-btn .btn-key-hint {
  position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
  font-size: 0.65rem; opacity: 0.5; font-weight: 500; letter-spacing: 0;
}

/* Timer bar under controls */
.toreba-timer-bar {
  width: 100%; max-width: 400px; height: 6px; background: rgba(255,255,255,0.1);
  border-radius: 3px; overflow: hidden;
}
.toreba-timer-fill {
  height: 100%; background: linear-gradient(90deg, var(--basil), var(--mozzarella));
  border-radius: 3px; transition: width 0.3s linear;
}
.toreba-timer-fill.low { background: linear-gradient(90deg, var(--pepperoni), #ff4444); }

/* Drop zone shadow */
.claw-drop-shadow {
  position: absolute; pointer-events: none; z-index: 4;
  width: 50px; height: 20px;
  background: radial-gradient(ellipse, rgba(230,57,70,0.6) 0%, transparent 70%);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  display: none;
}
.claw-drop-shadow.visible { display: block; }

/* Crosshair */
.claw-crosshair {
  position: absolute; pointer-events: none; z-index: 5;
  width: 64px; height: 64px;
  transform: translate(-50%, -50%);
  animation: crosshair-pulse 1.5s ease infinite;
  display: none;
}
.claw-crosshair svg { width: 100%; height: 100%; }
.claw-crosshair.visible { display: block; }

/* Tap-to-drop target indicator */
.tap-target-indicator {
  position: absolute; pointer-events: none; z-index: 6;
  width: 64px; height: 64px;
  border: 3px solid #E63946;
  border-radius: 50%;
  transform: translate(-50%, -50%);
  animation: target-pulse 1.5s ease infinite;
  display: none;
}
.tap-target-indicator::before {
  content: ''; position: absolute; inset: 6px;
  border: 2px dashed rgba(230,57,70,0.5);
  border-radius: 50%;
}
.tap-target-indicator::after {
  content: ''; position: absolute;
  top: 50%; left: 50%; width: 8px; height: 8px;
  background: #E63946; border-radius: 50%;
  transform: translate(-50%, -50%);
}
.tap-target-indicator.visible { display: block; }

/* Drop countdown overlay */
.drop-countdown {
  position: absolute; pointer-events: none; z-index: 30;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  font-size: 72px; font-weight: 900;
  color: #fff;
  text-shadow: 0 0 40px rgba(230,57,70,0.8), 0 4px 12px rgba(0,0,0,0.9);
  opacity: 0;
  display: none;
  font-family: var(--font);
  letter-spacing: -2px;
}
.drop-countdown.visible {
  display: block;
  animation: countdown-pop 0.35s ease forwards;
}
.drop-countdown.fade-out {
  animation: countdown-fade 0.15s ease forwards;
}

/* Hide joystick - tap-to-drop only */
.joystick-area { display: none !important; }

/* Tap instruction overlay */
.tap-instruction {
  position: absolute; pointer-events: none; z-index: 10;
  bottom: 15%; left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
  border: 1px solid rgba(230,57,70,0.4);
  border-radius: 24px;
  padding: 0.6rem 1.5rem;
  font-size: 0.95rem; font-weight: 700;
  color: #fff; white-space: nowrap;
  animation: tap-instruction-float 2.5s ease infinite;
  text-shadow: 0 2px 4px rgba(0,0,0,0.5);
}
.tap-instruction .accent { color: #E63946; }

/* Glide trail line from claw to target */
.claw-glide-trail {
  position: absolute; pointer-events: none; z-index: 3;
  border: none; height: 2px;
  background: linear-gradient(90deg, rgba(230,57,70,0.6), rgba(255,183,3,0.3));
  transform-origin: left center;
  display: none;
  opacity: 0.7;
}
.claw-glide-trail.visible { display: block; }

/* Dotted drop line */
.claw-drop-line {
  position: absolute; pointer-events: none; z-index: 3;
  width: 0; border-left: 2px dashed rgba(255,183,3,0.5);
  transform: translateX(-50%);
  display: none;
}
.claw-drop-line.visible { display: block; }

/* Mouse hover preview */
.claw-hover-preview {
  position: absolute; pointer-events: none; z-index: 4;
  width: 40px; height: 40px;
  border: 2px dashed rgba(255,255,255,0.3);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  display: none;
}
.claw-hover-preview.visible { display: block; }

/* Provably fair button */
.provably-fair-toggle {
  position: absolute; bottom: 1rem; right: 1rem; pointer-events: auto; z-index: 11;
}

/* Tutorial overlay (Toreba-style) */
.claw-tutorial-overlay {
  position: absolute; inset: 0; z-index: 50;
  background: rgba(0,0,0,0.88); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
  display: flex; align-items: center; justify-content: center;
  animation: fade-in 0.3s ease; pointer-events: auto;
}
.claw-tutorial-content {
  text-align: center; max-width: 340px; padding: 2rem 1.5rem;
  animation: tutorial-fade-in 0.5s ease;
}
.claw-tutorial-content h3 {
  font-size: 1.4rem; margin-bottom: 1.5rem; color: var(--mozzarella);
}
.claw-tutorial-steps {
  display: flex; flex-direction: column; gap: 1.25rem; margin-bottom: 2rem;
}
.claw-tutorial-step {
  display: flex; align-items: center; gap: 1rem; text-align: left;
}
.claw-tutorial-step .step-num {
  flex-shrink: 0; width: 40px; height: 40px; border-radius: 50%;
  background: var(--pepperoni); color: #fff; font-weight: 900; font-size: 1.1rem;
  display: flex; align-items: center; justify-content: center;
}
.claw-tutorial-step .step-text {
  font-size: 0.95rem; color: var(--text); line-height: 1.4;
}
.claw-tutorial-step .step-text strong { color: var(--mozzarella); }
.claw-tutorial-dismiss {
  background: var(--mozzarella); color: #000; border: none; border-radius: 24px;
  padding: 0.75rem 2.5rem; font-size: 1rem; font-weight: 700;
  cursor: pointer; transition: all 0.2s ease;
  min-height: 48px; min-width: 48px;
  -webkit-tap-highlight-color: transparent;
}
.claw-tutorial-dismiss:hover { transform: scale(1.05); background: #ffc933; }

/* Desktop: hide mobile controls */
@media (min-width: 769px) {
  .toreba-controls { max-width: 320px; }
  .toreba-btn { height: 64px; font-size: 1rem; }
  .toreba-btn-play { height: 64px; font-size: 1.2rem; }
  .toreba-btn-drop { height: 56px; font-size: 1.1rem; }
}

/* ---- Result Modal ---- */
.result-modal {
  position: fixed; inset: 0; z-index: 200; display: none; align-items: flex-end; justify-content: center;
  background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
}
.result-modal.active { display: flex; }
.result-content {
  background: var(--surface); border-radius: var(--radius-lg) var(--radius-lg) 0 0;
  width: 100%; max-width: 480px; padding: 2rem; text-align: center;
  animation: slide-up 0.4s ease;
  border: 1px solid var(--glass-border); border-bottom: none;
}
.result-content.win { border-top: 3px solid; animation: slide-up 0.4s ease, confetti-border 1s linear infinite; }
.result-icon { font-size: 3rem; margin-bottom: 1rem; }
.result-title { font-size: 1.5rem; font-weight: 800; margin-bottom: 0.5rem; }
.result-title.win-text { color: var(--mozzarella); }
.result-prize-img { width: 120px; height: 120px; border-radius: var(--radius); background: linear-gradient(135deg, var(--pepperoni), var(--mozzarella)); margin: 1rem auto; }
.result-prize-name { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; }
.result-actions { display: flex; gap: 0.75rem; justify-content: center; margin-top: 1.5rem; flex-wrap: wrap; }
.result-share-btns { display: flex; gap: 0.5rem; justify-content: center; margin-top: 1rem; }
.result-tips { color: var(--text-dim); font-size: 0.85rem; margin-top: 0.75rem; }

/* ---- Prizes Page ---- */
.prize-tabs { display: flex; gap: 0; margin-bottom: 1.5rem; background: var(--surface); border-radius: var(--radius-sm); overflow: hidden; border: 1px solid var(--glass-border); }
.prize-tab { flex: 1; padding: 0.75rem; text-align: center; font-weight: 600; font-size: 0.9rem; color: var(--text-dim); background: none; transition: all var(--transition); cursor: pointer; }
.prize-tab.active { background: var(--pepperoni); color: #fff; }
.prize-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 1.25rem; }
.prize-card {
  background: var(--glass); border: 1px solid var(--glass-border); border-radius: var(--radius);
  overflow: hidden; backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
  transition: transform var(--transition), box-shadow var(--transition);
}
.prize-card:hover { transform: translateY(-4px); box-shadow: var(--shadow); }
.prize-card-img { height: 160px; display: flex; align-items: center; justify-content: center; }
.prize-card-img.tier-breadstick { background: linear-gradient(135deg, #2a2520, #3a3530); }
.prize-card-img.tier-slice { background: linear-gradient(135deg, #2a1a1e, #3a2a2e); }
.prize-card-img.tier-halfpie { background: linear-gradient(135deg, #1a2a1e, #2a3a2e); }
.prize-card-img.tier-fullpie { background: linear-gradient(135deg, #1a1a2e, #2a2a3e); }
.prize-card-img.tier-supreme { background: linear-gradient(135deg, #2a1a2e, #3a2a1e); }
.prize-card-img svg { width: 48px; height: 48px; opacity: 0.3; }
.prize-card-body { padding: 1rem; }
.prize-card-name { font-weight: 700; margin-bottom: 0.25rem; }
.prize-card-value { color: var(--mozzarella); font-weight: 600; font-size: 0.9rem; margin-bottom: 0.75rem; }
.my-wins-list { display: flex; flex-direction: column; gap: 0.75rem; }
.my-win-item { display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--glass); border: 1px solid var(--glass-border); border-radius: var(--radius-sm); }
.my-win-img { width: 56px; height: 56px; border-radius: var(--radius-sm); background: linear-gradient(135deg, var(--surface), #2a2a4e); flex-shrink: 0; }
.my-win-info { flex: 1; }
.my-win-name { font-weight: 600; }
.my-win-date { font-size: 0.8rem; color: var(--text-dim); }
.claim-status { font-size: 0.75rem; font-weight: 600; padding: 0.25rem 0.6rem; border-radius: 20px; }
.claim-status.pending { background: rgba(255,183,3,0.15); color: var(--mozzarella); }
.claim-status.shipped { background: rgba(45,198,83,0.15); color: var(--basil); }
.claim-status.unclaimed { background: rgba(230,57,70,0.15); color: var(--pepperoni); }

/* ---- Claim Modal ---- */
.claim-modal { position: fixed; inset: 0; z-index: 200; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); }
.claim-modal.active { display: flex; }
.claim-modal-content { background: var(--surface); border-radius: var(--radius-lg); width: 90%; max-width: 480px; padding: 2rem; animation: slide-up 0.3s ease; border: 1px solid var(--glass-border); }
.claim-form { display: flex; flex-direction: column; gap: 0.75rem; margin-top: 1rem; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
.form-group { display: flex; flex-direction: column; gap: 0.25rem; }
.form-group label { font-size: 0.8rem; color: var(--text-dim); font-weight: 500; }

/* ---- Leaderboard ---- */
.time-filters { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
.time-filter { padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600; background: var(--surface); color: var(--text-dim); border: 1px solid var(--glass-border); cursor: pointer; transition: all var(--transition); }
.time-filter.active { background: var(--pepperoni); color: #fff; border-color: var(--pepperoni); }
.lb-table { width: 100%; border-collapse: collapse; }
.lb-table th { text-align: left; padding: 0.75rem 1rem; font-size: 0.8rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--glass-border); }
.lb-table td { padding: 0.75rem 1rem; border-bottom: 1px solid rgba(255,255,255,0.03); }
.lb-table tr:hover td { background: rgba(255,255,255,0.02); }
.lb-rank { font-weight: 800; width: 50px; }
.lb-rank.gold { color: #FFD700; }
.lb-rank.silver { color: #C0C0C0; }
.lb-rank.bronze { color: #CD7F32; }
.lb-player { display: flex; align-items: center; gap: 0.75rem; }
.lb-avatar { width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0; }
.lb-name { font-weight: 600; }
.lb-top-row { background: rgba(255,215,0,0.03); }
.your-rank-bar {
  position: sticky; bottom: 0; background: var(--surface); border-top: 1px solid var(--glass-border);
  padding: 0.75rem 1rem; display: flex; align-items: center; justify-content: space-between;
  border-radius: 0 0 var(--radius) var(--radius);
}

/* ---- Profile ---- */
.profile-stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 2rem; }
.profile-stat-card { background: var(--glass); border: 1px solid var(--glass-border); border-radius: var(--radius-sm); padding: 1.25rem; text-align: center; backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
.profile-stat-value { font-size: 1.75rem; font-weight: 800; }
.profile-stat-value.pepperoni { color: var(--pepperoni); }
.profile-stat-value.mozzarella { color: var(--mozzarella); }
.profile-stat-value.basil { color: var(--basil); }
.profile-stat-label { font-size: 0.8rem; color: var(--text-dim); margin-top: 0.25rem; }
.referral-section { background: var(--glass); border: 1px solid var(--glass-border); border-radius: var(--radius); padding: 1.5rem; margin-bottom: 2rem; backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
.referral-tier { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; }
.tier-icon { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
.tier-icon.bronze { background: linear-gradient(135deg, #CD7F32, #8B4513); }
.tier-icon.silver { background: linear-gradient(135deg, #C0C0C0, #808080); }
.tier-icon.gold { background: linear-gradient(135deg, #FFD700, #DAA520); }
.tier-icon.platinum { background: linear-gradient(135deg, #E5E4E2, #B0B0B0); }
.tier-icon.diamond { background: linear-gradient(135deg, #B9F2FF, #4FC3F7); }
.tier-name { font-weight: 700; font-size: 1.1rem; }
.tier-subtitle { font-size: 0.8rem; color: var(--text-dim); }
.progress-track { width: 100%; height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; margin-bottom: 0.5rem; overflow: hidden; }
.progress-fill { height: 100%; border-radius: 4px; background: linear-gradient(90deg, var(--pepperoni), var(--mozzarella)); transition: width 0.5s ease; }
.progress-label { font-size: 0.8rem; color: var(--text-dim); margin-bottom: 1rem; }
.referral-link-box { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
.referral-link-box input { flex: 1; font-size: 0.85rem; }
.referral-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; }
.ref-stat { text-align: center; }
.ref-stat-val { font-size: 1.25rem; font-weight: 700; color: var(--mozzarella); }
.ref-stat-label { font-size: 0.7rem; color: var(--text-dim); }
.streak-section { margin-bottom: 2rem; }
.streak-calendar { display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: center; margin-top: 1rem; }
.streak-dot { width: 32px; height: 32px; border-radius: 50%; background: var(--surface); border: 2px solid var(--glass-border); display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 600; color: var(--text-dim); }
.streak-dot.active { background: var(--basil); border-color: var(--basil); color: #fff; animation: streak-glow 2s ease infinite; }
.streak-dot.today { border-color: var(--mozzarella); }
.play-history { max-height: 300px; overflow-y: auto; }
.history-item { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.03); }
.history-machine { font-weight: 600; font-size: 0.9rem; }
.history-result { font-size: 0.8rem; }
.history-result.win { color: var(--basil); }
.history-result.loss { color: var(--text-dim); }
.history-time { font-size: 0.75rem; color: var(--text-dim); }
.settings-section { display: flex; flex-direction: column; gap: 1rem; }
.setting-row { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid rgba(255,255,255,0.03); }
.setting-label { font-weight: 500; }
.setting-label small { display: block; font-size: 0.75rem; color: var(--text-dim); font-weight: 400; }
.toggle { width: 48px; height: 26px; border-radius: 13px; background: var(--surface); border: 2px solid var(--glass-border); position: relative; cursor: pointer; transition: background var(--transition); }
.toggle.active { background: var(--basil); border-color: var(--basil); }
.toggle::after { content: ''; width: 18px; height: 18px; border-radius: 50%; background: #fff; position: absolute; top: 2px; left: 2px; transition: transform var(--transition); }
.toggle.active::after { transform: translateX(22px); }
.challenges-section { margin-top: 2rem; }
.challenge-card { display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--glass); border: 1px solid var(--glass-border); border-radius: var(--radius-sm); margin-bottom: 0.75rem; }
.challenge-icon { width: 40px; height: 40px; border-radius: 50%; background: var(--surface); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.challenge-info { flex: 1; }
.challenge-name { font-weight: 600; font-size: 0.9rem; }
.challenge-progress { font-size: 0.75rem; color: var(--text-dim); }
.challenge-reward { font-size: 0.8rem; font-weight: 700; color: var(--mozzarella); text-align: right; white-space: nowrap; }

/* ---- How It Works ---- */
.steps-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; margin-bottom: 3rem; }
.step-card { background: var(--glass); border: 1px solid var(--glass-border); border-radius: var(--radius); padding: 2rem; text-align: center; backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); position: relative; }
.step-number { width: 48px; height: 48px; border-radius: 50%; background: var(--pepperoni); color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 1.25rem; margin: 0 auto 1rem; }
.step-icon { margin-bottom: 1rem; }
.step-icon svg { width: 48px; height: 48px; margin: 0 auto; }
.step-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 0.5rem; }
.step-desc { color: var(--text-dim); font-size: 0.9rem; }
.fair-section { background: var(--glass); border: 1px solid var(--glass-border); border-radius: var(--radius); padding: 2rem; margin-bottom: 2rem; }
.code-block { background: #0d0d18; border-radius: var(--radius-sm); padding: 1rem; overflow-x: auto; margin: 1rem 0; font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace; font-size: 0.85rem; line-height: 1.6; color: var(--basil); border: 1px solid var(--glass-border); }
.faq-list { display: flex; flex-direction: column; gap: 0.75rem; }
.faq-item { background: var(--glass); border: 1px solid var(--glass-border); border-radius: var(--radius-sm); overflow: hidden; }
.faq-question { width: 100%; padding: 1rem 1.25rem; display: flex; align-items: center; justify-content: space-between; background: none; color: var(--text); font-weight: 600; font-size: 0.95rem; text-align: left; cursor: pointer; transition: color var(--transition); }
.faq-question:hover { color: var(--mozzarella); }
.faq-question svg { width: 20px; height: 20px; flex-shrink: 0; transition: transform var(--transition); color: var(--text-dim); }
.faq-item.open .faq-question svg { transform: rotate(180deg); }
.faq-answer { padding: 0 1.25rem; max-height: 0; overflow: hidden; transition: max-height 0.3s ease, padding 0.3s ease; }
.faq-item.open .faq-answer { max-height: 300px; padding: 0 1.25rem 1rem; }
.faq-answer p { color: var(--text-dim); font-size: 0.9rem; line-height: 1.7; }
.trust-badges { display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; margin-top: 2rem; }
.trust-badge { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; }
.trust-badge svg { width: 40px; height: 40px; color: var(--basil); }
.trust-badge span { font-size: 0.8rem; font-weight: 600; color: var(--text-dim); }

/* ---- Blog ---- */
.blog-grid { display: grid; grid-template-columns: 1fr; gap: 1.25rem; }
.blog-card { background: var(--glass); border: 1px solid var(--glass-border); border-radius: var(--radius); overflow: hidden; transition: transform var(--transition), box-shadow var(--transition); }
.blog-card:hover { transform: translateY(-4px); box-shadow: var(--shadow); }
.blog-card-img { height: 160px; background: linear-gradient(135deg, var(--surface), #2a2a4e); }
.blog-card-body { padding: 1.25rem; }
.blog-card-date { font-size: 0.75rem; color: var(--text-dim); margin-bottom: 0.5rem; }
.blog-card-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 0.5rem; }
.blog-card-excerpt { font-size: 0.9rem; color: var(--text-dim); margin-bottom: 1rem; }

/* ---- Admin ---- */
#page-admin { display: none; }
.admin-login { max-width: 360px; margin: 4rem auto; text-align: center; }
.admin-login h2 { margin-bottom: 1.5rem; }
.admin-login-form { display: flex; flex-direction: column; gap: 0.75rem; }
.admin-dashboard { display: none; }
.admin-tabs { display: flex; gap: 0; margin-bottom: 1.5rem; background: var(--surface); border-radius: var(--radius-sm); overflow: hidden; border: 1px solid var(--glass-border); overflow-x: auto; }
.admin-tab { padding: 0.75rem 1.25rem; font-weight: 600; font-size: 0.85rem; color: var(--text-dim); background: none; white-space: nowrap; cursor: pointer; transition: all var(--transition); }
.admin-tab.active { background: var(--pepperoni); color: #fff; }
.admin-stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
.admin-stat-card { background: var(--glass); border: 1px solid var(--glass-border); border-radius: var(--radius-sm); padding: 1.25rem; }
.admin-stat-label { font-size: 0.8rem; color: var(--text-dim); margin-bottom: 0.25rem; }
.admin-stat-value { font-size: 1.75rem; font-weight: 800; }
.admin-table-wrap { overflow-x: auto; }
.admin-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
.admin-table th { text-align: left; padding: 0.75rem; color: var(--text-dim); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--glass-border); }
.admin-table td { padding: 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.03); }
.admin-table tr:hover td { background: rgba(255,255,255,0.02); }
.admin-actions { display: flex; gap: 0.5rem; }
.admin-actions button { padding: 0.3rem 0.6rem; font-size: 0.75rem; border-radius: 4px; font-weight: 600; }
.btn-edit { background: rgba(255,183,3,0.15); color: var(--mozzarella); }
.btn-delete { background: rgba(230,57,70,0.15); color: var(--pepperoni); }
.fulfillment-item { display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: var(--glass); border: 1px solid var(--glass-border); border-radius: var(--radius-sm); margin-bottom: 0.75rem; }

/* ---- Modals ---- */
.modal-overlay {
  position: fixed; inset: 0; z-index: 300; display: none; align-items: center; justify-content: center;
  background: rgba(0,0,0,0.65); backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
}
.modal-overlay.active { display: flex; }
.modal {
  background: var(--surface); border: 1px solid var(--glass-border); border-radius: var(--radius-lg);
  width: 90%; max-width: 520px; max-height: 90vh; overflow-y: auto; padding: 2rem;
  animation: slide-up 0.3s ease;
}
.modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; }
.modal-title { font-size: 1.25rem; font-weight: 800; }
.modal-close { width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; color: var(--text-dim); cursor: pointer; transition: all var(--transition); }
.modal-close:hover { background: rgba(255,255,255,0.1); color: var(--text); }
.modal-close svg { width: 18px; height: 18px; }
.credit-packs { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; }
.credit-pack {
  background: var(--glass); border: 2px solid var(--glass-border); border-radius: var(--radius);
  padding: 1.25rem; text-align: center; cursor: pointer; transition: all var(--transition);
}
.credit-pack:hover { border-color: var(--mozzarella); transform: translateY(-2px); }
.credit-pack.popular { border-color: var(--pepperoni); position: relative; }
.credit-pack.popular::before { content: 'BEST VALUE'; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: var(--pepperoni); color: #fff; font-size: 0.6rem; font-weight: 800; padding: 0.15rem 0.5rem; border-radius: 20px; }
.pack-amount { font-size: 1.5rem; font-weight: 800; color: var(--mozzarella); }
.pack-credits { font-size: 0.8rem; color: var(--text-dim); margin: 0.25rem 0 0.5rem; }
.pack-price { font-weight: 700; }
.vip-tiers { display: flex; flex-direction: column; gap: 1rem; }
.vip-tier {
  background: var(--glass); border: 1px solid var(--glass-border); border-radius: var(--radius);
  padding: 1.25rem; transition: all var(--transition); cursor: pointer;
}
.vip-tier:hover { border-color: var(--mozzarella); }
.vip-tier-name { font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem; }
.vip-tier-price { color: var(--mozzarella); font-weight: 600; margin-bottom: 0.5rem; }
.vip-perks { list-style: none; }
.vip-perks li { font-size: 0.85rem; color: var(--text-dim); padding: 0.2rem 0; padding-left: 1.25rem; position: relative; }
.vip-perks li::before { content: ''; position: absolute; left: 0; top: 0.55rem; width: 6px; height: 6px; border-radius: 50%; background: var(--basil); }
.tip-modal-body { text-align: center; }
.tip-btc-address { background: #0d0d18; border: 1px solid var(--glass-border); border-radius: var(--radius-sm); padding: 0.75rem; font-family: monospace; font-size: 0.8rem; word-break: break-all; margin: 1rem 0; }
.tip-qr-placeholder { width: 160px; height: 160px; background: #fff; border-radius: var(--radius-sm); margin: 1rem auto; display: flex; align-items: center; justify-content: center; color: #000; font-size: 0.75rem; }
.share-preview { width: 100%; aspect-ratio: 16/9; background: linear-gradient(135deg, var(--pepperoni), var(--mozzarella)); border-radius: var(--radius); margin-bottom: 1rem; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 800; font-size: 1.5rem; }
.settings-modal-body { display: flex; flex-direction: column; gap: 1rem; }

/* ---- Toast ---- */
#toast-container { position: fixed; top: 80px; right: 1rem; z-index: 400; display: flex; flex-direction: column; gap: 0.5rem; pointer-events: none; }
.toast {
  background: var(--surface); border: 1px solid var(--glass-border); border-radius: var(--radius-sm);
  padding: 0.75rem 1.25rem; display: flex; align-items: center; gap: 0.75rem;
  box-shadow: var(--shadow); pointer-events: auto; animation: slide-in-right 0.3s ease;
  min-width: 280px; max-width: 400px;
}
.toast.success { border-left: 3px solid var(--basil); }
.toast.error { border-left: 3px solid var(--pepperoni); }
.toast.info { border-left: 3px solid var(--mozzarella); }
.toast-icon { flex-shrink: 0; }
.toast-icon svg { width: 20px; height: 20px; }
.toast-msg { font-size: 0.85rem; flex: 1; }
.toast-close { background: none; color: var(--text-dim); padding: 0.25rem; cursor: pointer; }

/* ---- Footer ---- */
.site-footer { background: var(--surface); border-top: 1px solid var(--glass-border); padding: 3rem 0 2rem; margin-top: 4rem; }
.footer-grid { display: grid; grid-template-columns: 1fr; gap: 2rem; margin-bottom: 2rem; }
.footer-brand .nav-logo { margin-bottom: 0.75rem; }
.footer-brand p { color: var(--text-dim); font-size: 0.85rem; max-width: 280px; }
.footer-col h4 { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-dim); margin-bottom: 0.75rem; }
.footer-links { list-style: none; display: flex; flex-direction: column; gap: 0.4rem; }
.footer-links a { color: var(--text-dim); font-size: 0.85rem; transition: color var(--transition); }
.footer-links a:hover { color: var(--text); }
.footer-social { display: flex; gap: 0.75rem; margin-top: 0.5rem; }
.footer-social a { width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; color: var(--text-dim); transition: all var(--transition); }
.footer-social a:hover { background: var(--pepperoni); color: #fff; }
.footer-social a svg { width: 18px; height: 18px; }
.footer-promo { background: var(--glass); border: 1px solid var(--glass-border); border-radius: var(--radius-sm); padding: 1rem; margin-bottom: 1.5rem; }
.footer-promo h4 { font-size: 0.85rem; margin-bottom: 0.5rem; }
.footer-promo-links { display: flex; gap: 1rem; flex-wrap: wrap; }
.footer-promo-links a { font-size: 0.8rem; color: var(--mozzarella); }
.footer-bottom { text-align: center; padding-top: 1.5rem; border-top: 1px solid var(--glass-border); }
.footer-bottom p { font-size: 0.75rem; color: var(--text-dim); }
.footer-affiliate { font-size: 0.7rem; color: var(--text-dim); margin-top: 0.5rem; font-style: italic; }

/* ---- Network Footer ---- */
.network-footer { background: linear-gradient(180deg, var(--surface) 0%, #0d0d14 100%); border-top: 2px solid var(--pepperoni); padding: 3rem 0 1.5rem; }
.network-footer .container { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }
.network-footer-brand { text-align: center; margin-bottom: 2rem; }
.network-footer-brand h3 { font-size: 1.1rem; color: var(--mozzarella); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 0.25rem; }
.network-footer-brand span { font-size: 0.75rem; color: var(--text-dim); letter-spacing: 2px; text-transform: uppercase; }
.network-section { margin-bottom: 1.5rem; }
.network-section-title { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1.5px; color: var(--pepperoni); margin-bottom: 0.6rem; padding-bottom: 0.3rem; border-bottom: 1px solid rgba(230,57,70,0.2); font-weight: 700; }
.network-links { display: flex; flex-wrap: wrap; gap: 0.4rem 0.75rem; }
.network-links a { font-size: 0.75rem; color: var(--text-dim); padding: 0.2rem 0.5rem; border-radius: 4px; background: rgba(255,255,255,0.03); border: 1px solid transparent; transition: all var(--transition); white-space: nowrap; }
.network-links a:hover { color: var(--mozzarella); background: rgba(255,183,3,0.08); border-color: rgba(255,183,3,0.2); }
.network-links a.highlight { color: var(--mozzarella); font-weight: 600; background: rgba(255,183,3,0.06); }
.network-footer-bottom { text-align: center; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--glass-border); }
.network-footer-bottom p { font-size: 0.7rem; color: var(--text-dim); margin-bottom: 0.3rem; }
.network-footer-bottom a { color: var(--mozzarella); }
.network-footer-bottom .twitter-link { display: inline-flex; align-items: center; gap: 0.3rem; color: var(--text-dim); font-size: 0.75rem; margin-bottom: 0.5rem; transition: color var(--transition); }
.network-footer-bottom .twitter-link:hover { color: var(--mozzarella); }
.network-footer-bottom .twitter-link svg { width: 14px; height: 14px; }
@media (min-width: 768px) {
  .network-sections-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem 2rem; }
}
@media (min-width: 1024px) {
  .network-sections-grid { grid-template-columns: 1fr 1fr 1fr 1fr; }
}

/* ---- Powered by Spunkeroo watermark ---- */
.spunkeroo-watermark { position: fixed; bottom: 8px; right: 12px; font-size: 0.6rem; color: rgba(255,255,255,0.12); letter-spacing: 1px; text-transform: uppercase; pointer-events: none; z-index: 1; font-weight: 600; }

/* ---- Responsive ---- */
@media (min-width: 480px) {
  .profile-stats-grid { grid-template-columns: repeat(4, 1fr); }
}
@media (min-width: 768px) {
  .machine-grid { grid-template-columns: repeat(2, 1fr); }
  .steps-grid { grid-template-columns: repeat(2, 1fr); }
  .blog-grid { grid-template-columns: repeat(2, 1fr); }
  .footer-grid { grid-template-columns: repeat(3, 1fr); }
  .form-row { grid-template-columns: 1fr 1fr; }
}
@media (min-width: 1024px) {
  .machine-grid { grid-template-columns: repeat(3, 1fr); }
  .steps-grid { grid-template-columns: repeat(4, 1fr); }
  .blog-grid { grid-template-columns: repeat(3, 1fr); }
  .footer-grid { grid-template-columns: 2fr 1fr 1fr 1fr; }
}
@media (max-width: 768px) {
  .top-nav .nav-links { display: none; }
  .top-nav .btn-buy-credits { display: none; }
  .bottom-tabs { display: block; }
  .main-content { padding-bottom: calc(56px + env(safe-area-inset-bottom, 0px)); }
  .hero { padding: 2.5rem 1rem 2rem; }
  .stats-row { gap: 1rem; }
  .stat-value { font-size: 1.25rem; }
  /* joystick removed ‚Äî tap-to-drop system */
  #toast-container { top: auto; bottom: calc(72px + env(safe-area-inset-bottom, 0px)); right: 0.5rem; left: 0.5rem; }
  .toast { min-width: auto; }
}
@media (min-width: 1440px) {
  .container { max-width: 1360px; }
}

/* ---- Cross-Promo Banner ---- */
.cross-promo-banner {
  background: linear-gradient(135deg, rgba(230,57,70,0.15), rgba(255,183,3,0.15));
  border: 1px solid var(--glass-border);
  border-radius: var(--radius);
  padding: 0.75rem 1.25rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.75rem;
  flex-wrap: wrap;
  margin: 0 auto 2rem;
  max-width: 900px;
  font-size: 0.9rem;
  animation: fade-in 0.5s ease;
}
.cross-promo-banner .promo-emoji { font-size: 1.2rem; }
.cross-promo-banner a { color: var(--mozzarella); font-weight: 600; text-decoration: underline; }
.cross-promo-banner a:hover { color: var(--pepperoni); }
.cross-promo-links { display: flex; gap: 0.5rem; flex-wrap: wrap; }
.cross-promo-links a { font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; background: rgba(255,255,255,0.05); text-decoration: none !important; }

/* ---- Prize Showcase (Amazon Affiliates) ---- */
.prize-showcase { padding: 3rem 0; }
.prize-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1.25rem;
  margin-top: 1.5rem;
}
@media (min-width: 768px) { .prize-grid { grid-template-columns: repeat(3, 1fr); } }
@media (min-width: 1024px) { .prize-grid { grid-template-columns: repeat(4, 1fr); } }
.prize-card {
  background: var(--glass);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius);
  overflow: hidden;
  transition: transform var(--transition), box-shadow var(--transition);
  display: flex;
  flex-direction: column;
}
.prize-card:hover { transform: translateY(-4px); box-shadow: 0 8px 32px rgba(230,57,70,0.2); }
.prize-card-img {
  width: 100%;
  aspect-ratio: 1;
  background: #1e1e2e;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 3rem;
  position: relative;
}
.prize-card-img .price-badge {
  position: absolute;
  top: 8px;
  right: 8px;
  background: var(--basil);
  color: #fff;
  font-size: 0.7rem;
  font-weight: 700;
  padding: 2px 8px;
  border-radius: 4px;
}
.prize-card-body {
  padding: 0.75rem;
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}
.prize-card-name { font-size: 0.85rem; font-weight: 600; line-height: 1.3; }
.prize-card-price { font-size: 0.8rem; color: var(--basil); font-weight: 700; }
.btn-amazon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.4rem;
  background: #FF9900;
  color: #111;
  font-size: 0.75rem;
  font-weight: 700;
  padding: 0.5rem 0.75rem;
  border-radius: var(--radius-sm);
  text-decoration: none;
  transition: background var(--transition), transform var(--transition);
  margin-top: auto;
}
.btn-amazon:hover { background: #e68a00; color: #111; transform: scale(1.03); }
.btn-amazon svg { width: 14px; height: 14px; }

/* ---- Tip Jar ---- */
.tip-jar-section { padding: 3rem 0; }
.tip-jar-card {
  background: linear-gradient(135deg, rgba(255,183,3,0.08), rgba(230,57,70,0.08));
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-lg);
  padding: 2rem;
  text-align: center;
  max-width: 600px;
  margin: 0 auto;
}
.tip-jar-card h3 { font-size: 1.5rem; margin-bottom: 0.5rem; }
.tip-jar-card p { color: var(--text-dim); font-size: 0.9rem; margin-bottom: 1.5rem; }
.tip-tiers {
  display: flex;
  justify-content: center;
  gap: 1rem;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
}
.tip-tier {
  background: var(--glass);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius);
  padding: 0.75rem 1.25rem;
  text-align: center;
  min-width: 100px;
  transition: border-color var(--transition), transform var(--transition);
}
.tip-tier:hover { border-color: var(--mozzarella); transform: translateY(-2px); }
.tip-tier-emoji { font-size: 1.5rem; margin-bottom: 0.25rem; }
.tip-tier-name { font-size: 0.8rem; font-weight: 600; }
.tip-tier-amount { font-size: 0.75rem; color: var(--text-dim); }
.tip-btc-address {
  background: var(--surface);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-sm);
  padding: 0.6rem 1rem;
  font-family: 'Courier New', monospace;
  font-size: 0.7rem;
  word-break: break-all;
  color: var(--text-dim);
  margin-bottom: 1rem;
  user-select: all;
}
.btn-tip {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  background: var(--mozzarella);
  color: #111;
  font-size: 0.95rem;
  font-weight: 700;
  padding: 0.75rem 2rem;
  border-radius: 50px;
  border: none;
  cursor: pointer;
  transition: all var(--transition);
}
.btn-tip:hover { background: var(--pepperoni); color: #fff; transform: scale(1.05); }

/* ---- Credit Packs ---- */
.credit-packs-section { padding: 3rem 0; }
.credit-packs-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1.25rem;
  margin-top: 1.5rem;
}
@media (min-width: 768px) { .credit-packs-grid { grid-template-columns: repeat(4, 1fr); } }
.credit-pack-card {
  background: var(--glass);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius);
  padding: 1.5rem 1rem;
  text-align: center;
  position: relative;
  overflow: hidden;
  transition: transform var(--transition), box-shadow var(--transition);
}
.credit-pack-card:hover { transform: translateY(-4px); box-shadow: 0 8px 32px rgba(255,183,3,0.15); }
.credit-pack-card.featured { border-color: var(--mozzarella); }
.credit-pack-card.featured::before {
  content: 'BEST VALUE';
  position: absolute;
  top: 12px;
  right: -30px;
  background: var(--pepperoni);
  color: #fff;
  font-size: 0.6rem;
  font-weight: 700;
  padding: 2px 32px;
  transform: rotate(45deg);
}
.credit-pack-badge {
  display: inline-block;
  background: rgba(255,183,3,0.15);
  color: var(--mozzarella);
  font-size: 0.65rem;
  font-weight: 700;
  padding: 3px 10px;
  border-radius: 50px;
  margin-bottom: 0.75rem;
  letter-spacing: 0.5px;
}
.credit-pack-emoji { font-size: 2.5rem; margin-bottom: 0.5rem; }
.credit-pack-name { font-size: 1rem; font-weight: 700; margin-bottom: 0.25rem; }
.credit-pack-amount { font-size: 0.85rem; color: var(--text-dim); margin-bottom: 0.75rem; }
.credit-pack-price { font-size: 1.5rem; font-weight: 800; color: var(--mozzarella); margin-bottom: 0.75rem; }
.btn-coming-soon {
  display: inline-block;
  background: rgba(255,255,255,0.08);
  color: var(--text-dim);
  font-size: 0.8rem;
  font-weight: 600;
  padding: 0.6rem 1.5rem;
  border-radius: 50px;
  border: 1px dashed var(--glass-border);
  cursor: default;
}

/* ---- Spin Wheel Modal ---- */
.spin-modal-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.8);
  z-index: 10000;
  align-items: center;
  justify-content: center;
  animation: fade-in 0.3s ease;
}
.spin-modal-overlay.active { display: flex; }
.spin-modal {
  background: var(--surface);
  border-radius: var(--radius-lg);
  padding: 2rem;
  text-align: center;
  max-width: 400px;
  width: 90%;
  position: relative;
  border: 1px solid var(--glass-border);
  box-shadow: var(--shadow);
}
.spin-modal h2 { margin-bottom: 0.5rem; font-size: 1.5rem; }
.spin-modal .spin-subtitle { color: var(--text-dim); margin-bottom: 1.5rem; font-size: 0.9rem; }
.spin-modal .spin-close {
  position: absolute; top: 12px; right: 16px;
  background: none; color: var(--text-dim); font-size: 1.5rem;
  cursor: pointer; line-height: 1;
}
.spin-modal .spin-close:hover { color: var(--text); }
.spin-wheel-container {
  position: relative;
  width: 300px; height: 300px;
  margin: 0 auto 1.5rem;
}
.spin-wheel {
  width: 300px; height: 300px;
  border-radius: 50%;
  position: relative;
  background: conic-gradient(
    #E63946 0deg 45deg,
    #FFB703 45deg 90deg,
    #D4451A 90deg 135deg,
    #F4A261 135deg 180deg,
    #8B4513 180deg 225deg,
    #FF6B35 225deg 270deg,
    #CC3300 270deg 315deg,
    #FFC857 315deg 360deg
  );
  border: 4px solid var(--mozzarella);
  box-shadow: 0 0 20px rgba(255,183,3,0.3);
  transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
}
.spin-wheel.spinning {
  transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
}
.spin-wheel-label {
  position: absolute;
  width: 50%;
  height: 0;
  top: 50%;
  left: 50%;
  transform-origin: 0% 0%;
  display: flex;
  align-items: center;
  justify-content: flex-end;
  padding-right: 18px;
  font-weight: 700;
  font-size: 0.85rem;
  color: #fff;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.6);
  pointer-events: none;
}
.spin-pointer {
  position: absolute;
  top: -18px;
  left: 50%;
  transform: translateX(-50%);
  width: 0; height: 0;
  border-left: 14px solid transparent;
  border-right: 14px solid transparent;
  border-top: 28px solid var(--pepperoni);
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
  z-index: 2;
}
.spin-center-btn {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  width: 70px; height: 70px;
  border-radius: 50%;
  background: var(--pepperoni);
  color: #fff;
  font-weight: 800;
  font-size: 1rem;
  border: 3px solid #fff;
  cursor: pointer;
  z-index: 3;
  transition: transform 0.2s, box-shadow 0.2s;
  box-shadow: 0 2px 12px rgba(230,57,70,0.5);
}
.spin-center-btn:hover { transform: translate(-50%, -50%) scale(1.08); box-shadow: 0 4px 20px rgba(230,57,70,0.7); }
.spin-center-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: translate(-50%, -50%); }
.spin-result {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--mozzarella);
  min-height: 2rem;
  margin-bottom: 0.5rem;
}
.spin-cooldown { color: var(--text-dim); font-size: 0.85rem; }
.daily-spin-btn {
  background: linear-gradient(135deg, var(--pepperoni), var(--mozzarella));
  color: #fff;
  font-weight: 700;
  font-size: 1rem;
  padding: 0.75rem 1.5rem;
  border-radius: 50px;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
  animation: pulse 2s ease infinite;
  border: none;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}
.daily-spin-btn:hover { transform: scale(1.05); box-shadow: 0 4px 20px rgba(230,57,70,0.5); }
</style>

<!-- Google Analytics GA4 -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GVNL11PEGP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-GVNL11PEGP');
</script>

</head>
<body>
<div id="sa-promo-bar" style="background:linear-gradient(90deg,#ff5f1f,#ff8c42);padding:12px 20px;text-align:center;font-family:-apple-system,BlinkMacSystemFont,sans-serif;position:relative;z-index:9999">
  <a href="https://spunk.codes" target="_blank" rel="noopener" style="color:#fff;text-decoration:none;font-size:14px;font-weight:600">
    75+ Free Tools for Founders & Developers ‚Äî No Signup Required ‚Üí SpunkArt.com
  </a>
  <span onclick="this.parentElement.style.display='none'" style="position:absolute;right:15px;top:50%;transform:translateY(-50%);color:#fff;cursor:pointer;font-size:18px">&times;</span>
</div>

<!-- Loading Screen -->
<div id="loading-screen">
  <div class="loading-pizza">
    <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M50 5 L95 90 L5 90 Z" fill="#FFB703" stroke="#E63946" stroke-width="3"/>
      <circle cx="40" cy="60" r="7" fill="#E63946"/>
      <circle cx="60" cy="55" r="6" fill="#E63946"/>
      <circle cx="50" cy="75" r="7" fill="#E63946"/>
      <circle cx="35" cy="45" r="5" fill="#2DC653" opacity="0.7"/>
      <circle cx="62" cy="72" r="4" fill="#2DC653" opacity="0.7"/>
    </svg>
  </div>
  <div class="loading-tagline">Grab Your Slice</div>
  <div class="loading-bar-track"><div class="loading-bar-fill"></div></div>
</div>

<!-- Top Navigation -->
<nav class="top-nav">
  <a href="#" class="nav-logo">
    <svg viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect x="12" y="0" width="4" height="10" rx="1" fill="#888"/>
      <rect x="20" y="0" width="4" height="10" rx="1" fill="#888"/>
      <path d="M8 8 L28 8 L30 14 L6 14 Z" fill="#aaa"/>
      <path d="M10 14 L26 14 L26 20 Q26 22 24 22 L12 22 Q10 22 10 20 Z" fill="#999"/>
      <path d="M14 22 L22 22 L22 26 L14 26 Z" fill="#888"/>
      <path d="M18 26 L30 38 L6 38 Z" fill="#FFB703"/>
      <circle cx="15" cy="33" r="2.5" fill="#E63946"/>
      <circle cx="21" cy="32" r="2" fill="#E63946"/>
      <circle cx="18" cy="36" r="2" fill="#E63946"/>
    </svg>
    claw.pizza
  </a>
  <ul class="nav-links">
    <li><a href="#" class="active" data-page="home">Home</a></li>
    <li><a href="#" data-page="machines">Machines</a></li>
    <li><a href="#" data-page="prizes">Prizes</a></li>
    <li><a href="#" data-page="leaderboard">Leaderboard</a></li>
    <li><a href="#" data-page="how">How It Works</a></li>
    <li><a href="#" onclick="ClawApp.showSpinWheel();return false;">Daily Spin</a></li>
  </ul>
  <div class="nav-right">
    <div class="credit-display">
      <svg viewBox="0 0 20 20" fill="none"><circle cx="10" cy="10" r="8" stroke="#FFB703" stroke-width="2"/><text x="10" y="14" text-anchor="middle" font-size="10" font-weight="bold" fill="#FFB703">C</text></svg>
      <span id="nav-credits">0</span>
    </div>
    <button class="nav-profile" data-page="profile" aria-label="Profile">
      <svg viewBox="0 0 20 20" fill="none"><circle cx="10" cy="7" r="4" stroke="currentColor" stroke-width="1.5"/><path d="M2 18 Q2 13 10 13 Q18 13 18 18" stroke="currentColor" stroke-width="1.5" fill="none"/></svg>
    </button>
    <button class="btn-buy-credits" id="btn-open-buy">Buy Credits</button>
  </div>
</nav>

<!-- Bottom Tab Bar (mobile) -->
<div class="bottom-tabs">
  <div class="bottom-tabs-inner">
    <button class="tab-item active" data-page="home" aria-label="Home">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12 L12 3 L21 12"/><path d="M5 10 V20 H19 V10"/></svg>
      <span>Home</span>
    </button>
    <button class="tab-item" data-page="machines" aria-label="Machines">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="4" width="16" height="16" rx="2"/><circle cx="12" cy="12" r="3"/><path d="M9 4 V2 M15 4 V2"/></svg>
      <span>Machines</span>
    </button>
    <button class="tab-item" data-page="prizes" aria-label="Prizes">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2 L15 8 L22 9 L17 14 L18 21 L12 18 L6 21 L7 14 L2 9 L9 8 Z"/></svg>
      <span>Prizes</span>
    </button>
    <button class="tab-item" data-page="leaderboard" aria-label="Leaderboard">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="12" width="4" height="8"/><rect x="10" y="6" width="4" height="14"/><rect x="16" y="9" width="4" height="11"/></svg>
      <span>Board</span>
    </button>
    <button class="tab-item" data-page="profile" aria-label="Profile">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M4 20 Q4 15 12 15 Q20 15 20 20"/></svg>
      <span>Profile</span>
    </button>
  </div>
</div>

<!-- Main Content -->
<div class="main-content">

<!-- ==================== HOME PAGE ==================== -->
<div class="page active" id="page-home">

  <!-- Hero -->
  <section class="hero">
    <h1 class="hero-headline">Grab Your Slice</h1>
    <p class="hero-subtitle">Virtual prizes. Provably fair. Play free.</p>
    <div class="hero-ctas">
      <button class="btn btn-primary btn-lg btn-glow" data-page="machines">Play Free</button>
      <button class="btn btn-outline btn-lg" data-page="how">How It Works</button>
    </div>
    <div style="margin-top:1rem;">
      <button class="daily-spin-btn" onclick="ClawApp.showSpinWheel()">&#x1F3B0; Daily Spin - Free Credits!</button>
    </div>
    <div class="stats-row">
      <div class="stat-item">
        <div class="stat-value">5</div>
        <div class="stat-label">prize tiers</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">40%</div>
        <div class="stat-label">top win rate</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">FREE</div>
        <div class="stat-label">to play daily</div>
      </div>
    </div>
  </section>

  <!-- Cross-Promotion Banner -->
  <div class="container">
    <div class="cross-promo-banner">
      <span class="promo-emoji">&#x1F3B0;</span>
      <span>Love claw games? Try our crypto casino at <a href="https://spunk.bet" target="_blank" rel="noopener" onclick="clawTrack('referral_click','spunk_bet')">spunk.bet</a> &mdash; Free daily SPUNK tokens!</span>
      <div class="cross-promo-links">
        <a href="https://predict.horse" target="_blank" rel="noopener" onclick="clawTrack('referral_click','predict_horse')">predict.horse</a>
        <a href="https://predict.pics" target="_blank" rel="noopener" onclick="clawTrack('referral_click','predict_pics')">predict.pics</a>
        <a href="https://predict.surf" target="_blank" rel="noopener" onclick="clawTrack('referral_click','predict_surf')">predict.surf</a>
      </div>
    </div>
  </div>

  <!-- Featured Machines Carousel -->
  <section class="carousel-section">
    <div class="container">
      <div class="section-header">
        <h2 class="section-title">Featured Machines</h2>
        <p class="section-subtitle">Hot drops and high win rates</p>
      </div>
      <div class="carousel-track">
        <div class="machine-card-carousel">
          <div class="machine-card-img">
            <svg viewBox="0 0 64 64" fill="none"><rect x="16" y="8" width="32" height="48" rx="4" stroke="#fff" stroke-width="2"/><circle cx="32" cy="32" r="8" stroke="#fff" stroke-width="2"/></svg>
            <span class="badge badge-supreme" style="position:absolute;top:8px;left:8px;">Supreme</span>
          </div>
          <div class="machine-card-body">
            <div class="machine-card-name">Pizza Paradise</div>
            <div class="machine-card-cost">5 credits per play</div>
            <button class="machine-card-btn" onclick="ClawApp.selectMachine('claw-5')">Play Now</button>
          </div>
        </div>
        <div class="machine-card-carousel">
          <div class="machine-card-img">
            <svg viewBox="0 0 64 64" fill="none"><rect x="16" y="8" width="32" height="48" rx="4" stroke="#fff" stroke-width="2"/><circle cx="32" cy="32" r="8" stroke="#fff" stroke-width="2"/></svg>
            <span class="badge badge-fullpie" style="position:absolute;top:8px;left:8px;">Full Pie</span>
          </div>
          <div class="machine-card-body">
            <div class="machine-card-name">Cheesy Grabber</div>
            <div class="machine-card-cost">3 credits per play</div>
            <button class="machine-card-btn" onclick="ClawApp.selectMachine('claw-4')">Play Now</button>
          </div>
        </div>
        <div class="machine-card-carousel">
          <div class="machine-card-img">
            <svg viewBox="0 0 64 64" fill="none"><rect x="16" y="8" width="32" height="48" rx="4" stroke="#fff" stroke-width="2"/><circle cx="32" cy="32" r="8" stroke="#fff" stroke-width="2"/></svg>
            <span class="badge badge-halfpie" style="position:absolute;top:8px;left:8px;">Half Pie</span>
          </div>
          <div class="machine-card-body">
            <div class="machine-card-name">Pepperoni Picker</div>
            <div class="machine-card-cost">2 credits per play</div>
            <button class="machine-card-btn" onclick="ClawApp.selectMachine('claw-3')">Play Now</button>
          </div>
        </div>
        <div class="machine-card-carousel">
          <div class="machine-card-img">
            <svg viewBox="0 0 64 64" fill="none"><rect x="16" y="8" width="32" height="48" rx="4" stroke="#fff" stroke-width="2"/><circle cx="32" cy="32" r="8" stroke="#fff" stroke-width="2"/></svg>
            <span class="badge badge-slice" style="position:absolute;top:8px;left:8px;">Slice</span>
          </div>
          <div class="machine-card-body">
            <div class="machine-card-name">Margherita Mix</div>
            <div class="machine-card-cost">1 credit per play</div>
            <button class="machine-card-btn" onclick="ClawApp.selectMachine('claw-2')">Play Now</button>
          </div>
        </div>
        <div class="machine-card-carousel">
          <div class="machine-card-img">
            <svg viewBox="0 0 64 64" fill="none"><rect x="16" y="8" width="32" height="48" rx="4" stroke="#fff" stroke-width="2"/><circle cx="32" cy="32" r="8" stroke="#fff" stroke-width="2"/></svg>
            <span class="badge badge-breadstick" style="position:absolute;top:8px;left:8px;">Breadstick</span>
          </div>
          <div class="machine-card-body">
            <div class="machine-card-name">Starter Oven</div>
            <div class="machine-card-cost">Free</div>
            <button class="machine-card-btn" onclick="ClawApp.selectMachine('claw-1')">Play Now</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Live Win Feed -->
  <section class="section">
    <div class="container">
      <div class="section-header">
        <h2 class="section-title">Live Wins</h2>
        <p class="section-subtitle">Watch prizes get grabbed in real time</p>
      </div>
      <div class="live-feed">
        <div class="live-feed-header">
          <div class="live-indicator"><div class="live-dot"></div> LIVE</div>
          <span style="font-size:0.8rem;color:var(--text-dim);">Updated just now</span>
        </div>
        <div class="live-feed-list" id="live-feed-list">
          <div class="live-feed-item">
            <svg class="live-avatar" viewBox="0 0 36 36"><rect width="36" height="36" rx="18" fill="#E63946"/><text x="18" y="22" text-anchor="middle" fill="#fff" font-size="14" font-weight="bold">P</text></svg>
            <div class="live-feed-info">
              <div class="live-feed-name">PizzaFan42</div>
              <div class="live-feed-prize">Won AirPods Pro ($249)</div>
            </div>
            <div class="live-feed-time">2m ago</div>
          </div>
          <div class="live-feed-item">
            <svg class="live-avatar" viewBox="0 0 36 36"><rect width="36" height="36" rx="18" fill="#2DC653"/><text x="18" y="22" text-anchor="middle" fill="#fff" font-size="14" font-weight="bold">S</text></svg>
            <div class="live-feed-info">
              <div class="live-feed-name">SliceKing</div>
              <div class="live-feed-prize">Won Nintendo Switch ($299)</div>
            </div>
            <div class="live-feed-time">5m ago</div>
          </div>
          <div class="live-feed-item">
            <svg class="live-avatar" viewBox="0 0 36 36"><rect width="36" height="36" rx="18" fill="#FFB703"/><text x="18" y="22" text-anchor="middle" fill="#fff" font-size="14" font-weight="bold">C</text></svg>
            <div class="live-feed-info">
              <div class="live-feed-name">CrustCrusher</div>
              <div class="live-feed-prize">Won $25 Amazon Gift Card</div>
            </div>
            <div class="live-feed-time">8m ago</div>
          </div>
          <div class="live-feed-item">
            <svg class="live-avatar" viewBox="0 0 36 36"><rect width="36" height="36" rx="18" fill="#8888ff"/><text x="18" y="22" text-anchor="middle" fill="#fff" font-size="14" font-weight="bold">M</text></svg>
            <div class="live-feed-info">
              <div class="live-feed-name">MozzarellaMax</div>
              <div class="live-feed-prize">Won Mechanical Keyboard ($89)</div>
            </div>
            <div class="live-feed-time">12m ago</div>
          </div>
          <div class="live-feed-item">
            <svg class="live-avatar" viewBox="0 0 36 36"><rect width="36" height="36" rx="18" fill="#CD7F32"/><text x="18" y="22" text-anchor="middle" fill="#fff" font-size="14" font-weight="bold">D</text></svg>
            <div class="live-feed-info">
              <div class="live-feed-name">DoughBoy99</div>
              <div class="live-feed-prize">Won LED Strip Lights ($15)</div>
            </div>
            <div class="live-feed-time">18m ago</div>
          </div>
          <div class="live-feed-item">
            <svg class="live-avatar" viewBox="0 0 36 36"><rect width="36" height="36" rx="18" fill="#E63946"/><text x="18" y="22" text-anchor="middle" fill="#fff" font-size="14" font-weight="bold">T</text></svg>
            <div class="live-feed-info">
              <div class="live-feed-name">ToppingTitan</div>
              <div class="live-feed-prize">Won Bluetooth Speaker ($45)</div>
            </div>
            <div class="live-feed-time">23m ago</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Daily Faucet Banner -->
  <section class="section" style="padding-top:0;">
    <div class="container">
      <div class="faucet-banner">
        <div class="faucet-text">
          <h3>Claim 5 Free Credits!</h3>
          <p>Daily faucet resets every 24 hours. No purchase needed.</p>
        </div>
        <div style="display:flex;align-items:center;gap:1rem;">
          <div class="faucet-timer" id="faucet-timer">23:59:42</div>
          <button class="btn btn-primary" id="btn-claim-faucet">Claim Now</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Waitlist -->
  <section class="waitlist-section">
    <div class="container">
      <h2 class="section-title">Be First in Line</h2>
      <p class="section-subtitle">Get early access, bonus credits, and exclusive prizes.</p>
      <form class="waitlist-form" id="waitlist-form">
        <input type="email" placeholder="your@email.com" required aria-label="Email address">
        <button type="submit" class="btn btn-primary">Get Early Access</button>
      </form>
    </div>
  </section>

</div>

<!-- ==================== MACHINES PAGE ==================== -->
<div class="page" id="page-machines">
  <section class="section">
    <div class="container">
      <div class="section-header">
        <h2 class="section-title">Claw Machines</h2>
        <p class="section-subtitle">Pick a machine, grab a prize</p>
      </div>

      <div class="filter-tabs">
        <button class="filter-tab active">All</button>
        <button class="filter-tab">Breadstick</button>
        <button class="filter-tab">Slice</button>
        <button class="filter-tab">Half Pie</button>
        <button class="filter-tab">Full Pie</button>
        <button class="filter-tab">Supreme</button>
      </div>

      <div class="machine-grid" id="machine-grid">
        <!-- Machine 1 -->
        <div class="machine-card" data-tier="breadstick">
          <div class="machine-3d-container">
            <svg viewBox="0 0 72 72" fill="none"><rect x="16" y="8" width="40" height="56" rx="4" stroke="#fff" stroke-width="2"/><circle cx="36" cy="36" r="10" stroke="#fff" stroke-width="2"/></svg>
          </div>
          <div class="machine-card-content">
            <div class="machine-meta">
              <span class="badge badge-breadstick">Breadstick</span>
              <span style="font-size:0.8rem;color:var(--text-dim);">12 prizes</span>
            </div>
            <h3 class="machine-title">Starter Oven</h3>
            <div class="machine-stats">
              <span class="machine-stat">Prizes: <strong>$5 - $25</strong></span>
              <span class="machine-stat">Win rate: <strong>1 in 8</strong></span>
            </div>
            <div class="machine-card-actions">
              <button class="btn btn-primary btn-sm">Play Now - Free</button>
            </div>
          </div>
        </div>
        <!-- Machine 2 -->
        <div class="machine-card" data-tier="slice">
          <div class="machine-3d-container">
            <svg viewBox="0 0 72 72" fill="none"><rect x="16" y="8" width="40" height="56" rx="4" stroke="#fff" stroke-width="2"/><circle cx="36" cy="36" r="10" stroke="#fff" stroke-width="2"/></svg>
          </div>
          <div class="machine-card-content">
            <div class="machine-meta">
              <span class="badge badge-slice">Slice</span>
              <span style="font-size:0.8rem;color:var(--text-dim);">18 prizes</span>
            </div>
            <h3 class="machine-title">Margherita Mix</h3>
            <div class="machine-stats">
              <span class="machine-stat">Prizes: <strong>$10 - $50</strong></span>
              <span class="machine-stat">Win rate: <strong>1 in 12</strong></span>
            </div>
            <div class="machine-card-actions">
              <button class="btn btn-primary btn-sm">Play Now - 1 Credit</button>
            </div>
          </div>
        </div>
        <!-- Machine 3 -->
        <div class="machine-card" data-tier="slice">
          <div class="machine-3d-container">
            <svg viewBox="0 0 72 72" fill="none"><rect x="16" y="8" width="40" height="56" rx="4" stroke="#fff" stroke-width="2"/><circle cx="36" cy="36" r="10" stroke="#fff" stroke-width="2"/></svg>
          </div>
          <div class="machine-card-content">
            <div class="machine-meta">
              <span class="badge badge-slice">Slice</span>
              <span style="font-size:0.8rem;color:var(--text-dim);">15 prizes</span>
            </div>
            <h3 class="machine-title">Pepperoni Picker</h3>
            <div class="machine-stats">
              <span class="machine-stat">Prizes: <strong>$10 - $75</strong></span>
              <span class="machine-stat">Win rate: <strong>1 in 10</strong></span>
            </div>
            <div class="machine-card-actions">
              <button class="btn btn-primary btn-sm">Play Now - 1 Credit</button>
            </div>
          </div>
        </div>
        <!-- Machine 4 -->
        <div class="machine-card" data-tier="halfpie">
          <div class="machine-3d-container">
            <svg viewBox="0 0 72 72" fill="none"><rect x="16" y="8" width="40" height="56" rx="4" stroke="#fff" stroke-width="2"/><circle cx="36" cy="36" r="10" stroke="#fff" stroke-width="2"/></svg>
          </div>
          <div class="machine-card-content">
            <div class="machine-meta">
              <span class="badge badge-halfpie">Half Pie</span>
              <span style="font-size:0.8rem;color:var(--text-dim);">10 prizes</span>
            </div>
            <h3 class="machine-title">Cheesy Grabber</h3>
            <div class="machine-stats">
              <span class="machine-stat">Prizes: <strong>$25 - $150</strong></span>
              <span class="machine-stat">Win rate: <strong>1 in 15</strong></span>
            </div>
            <div class="machine-card-actions">
              <button class="btn btn-primary btn-sm">Play Now - 2 Credits</button>
            </div>
          </div>
        </div>
        <!-- Machine 5 -->
        <div class="machine-card" data-tier="fullpie">
          <div class="machine-3d-container">
            <svg viewBox="0 0 72 72" fill="none"><rect x="16" y="8" width="40" height="56" rx="4" stroke="#fff" stroke-width="2"/><circle cx="36" cy="36" r="10" stroke="#fff" stroke-width="2"/></svg>
          </div>
          <div class="machine-card-content">
            <div class="machine-meta">
              <span class="badge badge-fullpie">Full Pie</span>
              <span style="font-size:0.8rem;color:var(--text-dim);">8 prizes</span>
            </div>
            <h3 class="machine-title">Deep Dish Deluxe</h3>
            <div class="machine-stats">
              <span class="machine-stat">Prizes: <strong>$50 - $300</strong></span>
              <span class="machine-stat">Win rate: <strong>1 in 20</strong></span>
            </div>
            <div class="machine-card-actions">
              <button class="btn btn-primary btn-sm">Play Now - 3 Credits</button>
            </div>
          </div>
        </div>
        <!-- Machine 6 -->
        <div class="machine-card" data-tier="supreme">
          <div class="machine-3d-container">
            <svg viewBox="0 0 72 72" fill="none"><rect x="16" y="8" width="40" height="56" rx="4" stroke="#fff" stroke-width="2"/><circle cx="36" cy="36" r="10" stroke="#fff" stroke-width="2"/></svg>
          </div>
          <div class="machine-card-content">
            <div class="machine-meta">
              <span class="badge badge-supreme">Supreme</span>
              <span style="font-size:0.8rem;color:var(--text-dim);">5 prizes</span>
            </div>
            <h3 class="machine-title">Pizza Paradise</h3>
            <div class="machine-stats">
              <span class="machine-stat">Prizes: <strong>$100 - $500</strong></span>
              <span class="machine-stat">Win rate: <strong>1 in 25</strong></span>
            </div>
            <div class="machine-card-actions">
              <button class="btn btn-primary btn-sm">Play Now - 5 Credits</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- ==================== PLAY PAGE ==================== -->
<div class="page" id="page-play">
  <div class="play-canvas-container" id="play-canvas">
    <!-- Crosshair target indicator -->
    <div class="claw-crosshair" id="claw-crosshair">
      <svg viewBox="0 0 64 64" fill="none" stroke="#E63946" stroke-width="2.5">
        <circle cx="32" cy="32" r="20" stroke-dasharray="5 3" opacity="0.8"/>
        <line x1="32" y1="4" x2="32" y2="20" opacity="0.6"/>
        <line x1="32" y1="44" x2="32" y2="60" opacity="0.6"/>
        <line x1="4" y1="32" x2="20" y2="32" opacity="0.6"/>
        <line x1="44" y1="32" x2="60" y2="32" opacity="0.6"/>
        <circle cx="32" cy="32" r="4" fill="#E63946" opacity="0.9"/>
      </svg>
    </div>
    <!-- Drop zone shadow -->
    <div class="claw-drop-shadow" id="claw-drop-shadow"></div>
    <!-- Position line -->
    <div class="claw-position-line" id="claw-position-line"></div>
    <!-- Tap hint -->
    <div class="tap-hint" id="claw-tap-hint">TAP WHERE YOU WANT THE CLAW TO DROP</div>
    <div class="play-hud">
      <div class="hud-top">
        <div class="hud-credits">
          <svg style="width:16px;height:16px;display:inline;vertical-align:middle;" viewBox="0 0 20 20" fill="none"><circle cx="10" cy="10" r="8" stroke="#FFB703" stroke-width="2"/><text x="10" y="14" text-anchor="middle" font-size="10" font-weight="bold" fill="#FFB703">C</text></svg>
          <span id="hud-credit-count">5</span>
        </div>
        <div class="hud-machine-name" id="hud-machine-name">Pizza Paradise</div>
        <div class="hud-timer" id="hud-timer">0:30</div>
      </div>
      <div class="hud-bottom" id="hud-bottom">
        <div class="tap-instruction" id="tap-instruction">TAP WHERE YOU WANT THE CLAW TO <span class="accent">DROP</span></div>
      </div>
    </div>
    <!-- Joystick removed ‚Äî tap-to-drop system -->
    <div class="drop-countdown" id="drop-countdown"></div>
    <button class="btn btn-sm btn-secondary provably-fair-toggle" id="btn-pf-toggle">Provably Fair</button>
    <!-- Tutorial overlay (first time) -->
    <div class="claw-tutorial-overlay" id="claw-tutorial" style="display:none;">
      <div class="claw-tutorial-content">
        <h3>TAP TO PLAY</h3>
        <div class="claw-tutorial-steps">
          <div class="claw-tutorial-step">
            <div class="step-num" style="font-size:1.5rem;">&#9759;</div>
            <div class="step-text"><strong>Tap</strong> where you want the claw to go</div>
          </div>
          <div class="claw-tutorial-step">
            <div class="step-num">3</div>
            <div class="step-text">Watch the <strong>3-2-1 countdown</strong></div>
          </div>
          <div class="claw-tutorial-step">
            <div class="step-num" style="font-size:1.3rem;">&#127942;</div>
            <div class="step-text">The claw <strong>auto-drops &amp; grabs!</strong></div>
          </div>
        </div>
        <div style="margin-top:1rem;animation:tutorial-hand-bounce 1.5s ease infinite;font-size:2.5rem;">&#9759;</div>
        <p style="color:var(--text-dim);font-size:0.85rem;margin:0.5rem 0 1.5rem;">Tap anywhere on the machine</p>
        <button class="claw-tutorial-dismiss" id="claw-tutorial-dismiss">Got it!</button>
      </div>
    </div>
  </div>
</div>

<!-- Result Modal -->
<div class="result-modal" id="result-modal">
  <!-- Win State -->
  <div class="result-content win" id="result-win" style="display:none;">
    <div class="result-icon">&#127881;</div>
    <div class="result-title win-text">YOU WON!</div>
    <div class="result-prize-img"></div>
    <div class="result-prize-name" id="win-prize-name">AirPods Pro</div>
    <p style="color:var(--text-dim);font-size:0.9rem;">Value: <strong style="color:var(--mozzarella);">$249</strong></p>
    <div class="result-share-btns">
      <button class="btn btn-sm btn-secondary" onclick="(function(){var p=document.getElementById('win-prize-name').textContent;var t=encodeURIComponent('I just won '+p+' on CLAW.PIZZA! \uD83C\uDF55\uD83C\uDFAF\n\nFree online claw machine with virtual prizes!\n\n@SpunkArt13 #ClawPizza #GrabYourSlice #WinPrizes #FreePrizes');var u=encodeURIComponent('https://spunkeroo.github.io/claw-pizza/');window.open('https://twitter.com/intent/tweet?text='+t+'&url='+u,'_blank','width=600,height=400')})()">
        <svg style="width:16px;height:16px;" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
        Share on X
      </button>
      <button class="btn btn-sm btn-secondary" id="btn-claim-prize">Claim Prize</button>
    </div>
    <div class="result-actions">
      <button class="btn btn-primary" id="btn-play-again-win">Play Again</button>
      <button class="btn btn-outline" id="btn-close-result-win">Close</button>
    </div>
  </div>
  <!-- Loss State -->
  <div class="result-content" id="result-loss" style="display:none;">
    <div class="result-icon">&#128148;</div>
    <div class="result-title">So Close!</div>
    <p class="result-tips">Tip: Try positioning the claw slightly behind the prize for a better grip.</p>
    <div class="result-actions">
      <button class="btn btn-primary btn-glow" id="btn-play-again-loss">Try Again</button>
      <button class="btn btn-outline" id="btn-close-result-loss">Back to Machines</button>
    </div>
  </div>
</div>

<!-- ==================== PRIZES PAGE ==================== -->
<div class="page" id="page-prizes">
  <section class="section">
    <div class="container">
      <div class="section-header">
        <h2 class="section-title">Prize Gallery</h2>
        <p class="section-subtitle">Virtual prizes you can win in-game</p>
      </div>

      <div class="prize-tabs">
        <button class="prize-tab active" data-prize-tab="available">Available Prizes</button>
        <button class="prize-tab" data-prize-tab="my-wins">My Wins</button>
      </div>

      <!-- Available Prizes -->
      <div id="prizes-available">
        <div class="prize-grid">
          <div class="prize-card">
            <div class="prize-card-img tier-supreme"><svg viewBox="0 0 48 48" fill="none"><rect x="8" y="8" width="32" height="32" rx="4" stroke="#fff" stroke-width="1.5"/></svg></div>
            <div class="prize-card-body">
              <span class="badge badge-supreme" style="margin-bottom:0.5rem;">Supreme</span>
              <div class="prize-card-name">PlayStation 5 Digital</div>
              <div class="prize-card-value">$449</div>
              <button class="btn btn-primary btn-sm" style="width:100%;">Win This!</button>
            </div>
          </div>
          <div class="prize-card">
            <div class="prize-card-img tier-fullpie"><svg viewBox="0 0 48 48" fill="none"><rect x="8" y="8" width="32" height="32" rx="4" stroke="#fff" stroke-width="1.5"/></svg></div>
            <div class="prize-card-body">
              <span class="badge badge-fullpie" style="margin-bottom:0.5rem;">Full Pie</span>
              <div class="prize-card-name">Nintendo Switch OLED</div>
              <div class="prize-card-value">$349</div>
              <button class="btn btn-primary btn-sm" style="width:100%;">Win This!</button>
            </div>
          </div>
          <div class="prize-card">
            <div class="prize-card-img tier-fullpie"><svg viewBox="0 0 48 48" fill="none"><rect x="8" y="8" width="32" height="32" rx="4" stroke="#fff" stroke-width="1.5"/></svg></div>
            <div class="prize-card-body">
              <span class="badge badge-fullpie" style="margin-bottom:0.5rem;">Full Pie</span>
              <div class="prize-card-name">AirPods Pro 2</div>
              <div class="prize-card-value">$249</div>
              <button class="btn btn-primary btn-sm" style="width:100%;">Win This!</button>
            </div>
          </div>
          <div class="prize-card">
            <div class="prize-card-img tier-halfpie"><svg viewBox="0 0 48 48" fill="none"><rect x="8" y="8" width="32" height="32" rx="4" stroke="#fff" stroke-width="1.5"/></svg></div>
            <div class="prize-card-body">
              <span class="badge badge-halfpie" style="margin-bottom:0.5rem;">Half Pie</span>
              <div class="prize-card-name">Mechanical Keyboard</div>
              <div class="prize-card-value">$89</div>
              <button class="btn btn-primary btn-sm" style="width:100%;">Win This!</button>
            </div>
          </div>
          <div class="prize-card">
            <div class="prize-card-img tier-slice"><svg viewBox="0 0 48 48" fill="none"><rect x="8" y="8" width="32" height="32" rx="4" stroke="#fff" stroke-width="1.5"/></svg></div>
            <div class="prize-card-body">
              <span class="badge badge-slice" style="margin-bottom:0.5rem;">Slice</span>
              <div class="prize-card-name">$50 Amazon Gift Card</div>
              <div class="prize-card-value">$50</div>
              <button class="btn btn-primary btn-sm" style="width:100%;">Win This!</button>
            </div>
          </div>
          <div class="prize-card">
            <div class="prize-card-img tier-slice"><svg viewBox="0 0 48 48" fill="none"><rect x="8" y="8" width="32" height="32" rx="4" stroke="#fff" stroke-width="1.5"/></svg></div>
            <div class="prize-card-body">
              <span class="badge badge-slice" style="margin-bottom:0.5rem;">Slice</span>
              <div class="prize-card-name">Bluetooth Speaker</div>
              <div class="prize-card-value">$45</div>
              <button class="btn btn-primary btn-sm" style="width:100%;">Win This!</button>
            </div>
          </div>
          <div class="prize-card">
            <div class="prize-card-img tier-breadstick"><svg viewBox="0 0 48 48" fill="none"><rect x="8" y="8" width="32" height="32" rx="4" stroke="#fff" stroke-width="1.5"/></svg></div>
            <div class="prize-card-body">
              <span class="badge badge-breadstick" style="margin-bottom:0.5rem;">Breadstick</span>
              <div class="prize-card-name">$25 Gift Card</div>
              <div class="prize-card-value">$25</div>
              <button class="btn btn-primary btn-sm" style="width:100%;">Win This!</button>
            </div>
          </div>
          <div class="prize-card">
            <div class="prize-card-img tier-breadstick"><svg viewBox="0 0 48 48" fill="none"><rect x="8" y="8" width="32" height="32" rx="4" stroke="#fff" stroke-width="1.5"/></svg></div>
            <div class="prize-card-body">
              <span class="badge badge-breadstick" style="margin-bottom:0.5rem;">Breadstick</span>
              <div class="prize-card-name">LED Strip Lights</div>
              <div class="prize-card-value">$15</div>
              <button class="btn btn-primary btn-sm" style="width:100%;">Win This!</button>
            </div>
          </div>
        </div>
      </div>

      <!-- My Wins -->
      <div id="prizes-my-wins" style="display:none;">
        <div class="my-wins-list">
          <div class="my-win-item">
            <div class="my-win-img"></div>
            <div class="my-win-info">
              <div class="my-win-name">$25 Amazon Gift Card</div>
              <div class="my-win-date">Won Feb 19, 2026</div>
            </div>
            <span class="claim-status shipped">Claimed</span>
          </div>
          <div class="my-win-item">
            <div class="my-win-img"></div>
            <div class="my-win-info">
              <div class="my-win-name">LED Strip Lights</div>
              <div class="my-win-date">Won Feb 20, 2026</div>
            </div>
            <span class="claim-status pending">Pending</span>
          </div>
          <div class="my-win-item">
            <div class="my-win-img"></div>
            <div class="my-win-info">
              <div class="my-win-name">Bluetooth Speaker</div>
              <div class="my-win-date">Won Feb 21, 2026</div>
            </div>
            <span class="claim-status unclaimed">Unclaimed</span>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Prize Claim Modal -->
<div class="claim-modal" id="claim-modal">
  <div class="claim-modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Claim Your Prize</h3>
      <button class="modal-close" id="btn-close-claim"><svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4 L14 14 M14 4 L4 14"/></svg></button>
    </div>
    <p style="color:var(--text-dim);font-size:0.9rem;margin-bottom:0.5rem;">Enter your details to claim your virtual prize.</p>
    <form class="claim-form" id="claim-form">
      <div class="form-group">
        <label for="claim-name">Full Name</label>
        <input type="text" id="claim-name" placeholder="John Doe" required>
      </div>
      <div class="form-group">
        <label for="claim-email">Email</label>
        <input type="email" id="claim-email" placeholder="john@example.com" required>
      </div>
      <button type="submit" class="btn btn-primary" style="width:100%;margin-top:0.5rem;">Submit Claim</button>
    </form>
  </div>
</div>

<!-- ==================== LEADERBOARD PAGE ==================== -->
<div class="page" id="page-leaderboard">
  <section class="section">
    <div class="container">
      <div class="section-header">
        <h2 class="section-title">Leaderboard</h2>
        <p class="section-subtitle">Top grabbers on claw.pizza</p>
      </div>

      <div class="time-filters">
        <button class="time-filter active">Today</button>
        <button class="time-filter">This Week</button>
        <button class="time-filter">All Time</button>
      </div>

      <div class="filter-tabs" style="margin-bottom:1rem;">
        <button class="filter-tab active">Most Wins</button>
        <button class="filter-tab">Biggest Win</button>
        <button class="filter-tab">Most Plays</button>
      </div>

      <div class="card" style="padding:0;overflow:hidden;">
        <table class="lb-table">
          <thead>
            <tr><th>Rank</th><th>Player</th><th>Wins</th><th>Tier</th></tr>
          </thead>
          <tbody>
            <tr class="lb-top-row">
              <td class="lb-rank gold">1</td>
              <td><div class="lb-player"><svg class="lb-avatar" viewBox="0 0 32 32"><rect width="32" height="32" rx="16" fill="#FFD700"/><text x="16" y="21" text-anchor="middle" fill="#fff" font-size="13" font-weight="bold">S</text></svg><span class="lb-name">SliceKing</span></div></td>
              <td><strong>47</strong></td>
              <td><span class="badge badge-supreme">Supreme</span></td>
            </tr>
            <tr class="lb-top-row">
              <td class="lb-rank silver">2</td>
              <td><div class="lb-player"><svg class="lb-avatar" viewBox="0 0 32 32"><rect width="32" height="32" rx="16" fill="#C0C0C0"/><text x="16" y="21" text-anchor="middle" fill="#fff" font-size="13" font-weight="bold">P</text></svg><span class="lb-name">PizzaFan42</span></div></td>
              <td><strong>38</strong></td>
              <td><span class="badge badge-fullpie">Full Pie</span></td>
            </tr>
            <tr class="lb-top-row">
              <td class="lb-rank bronze">3</td>
              <td><div class="lb-player"><svg class="lb-avatar" viewBox="0 0 32 32"><rect width="32" height="32" rx="16" fill="#CD7F32"/><text x="16" y="21" text-anchor="middle" fill="#fff" font-size="13" font-weight="bold">C</text></svg><span class="lb-name">CrustCrusher</span></div></td>
              <td><strong>31</strong></td>
              <td><span class="badge badge-fullpie">Full Pie</span></td>
            </tr>
            <tr>
              <td class="lb-rank">4</td>
              <td><div class="lb-player"><svg class="lb-avatar" viewBox="0 0 32 32"><rect width="32" height="32" rx="16" fill="#8888ff"/><text x="16" y="21" text-anchor="middle" fill="#fff" font-size="13" font-weight="bold">M</text></svg><span class="lb-name">MozzarellaMax</span></div></td>
              <td><strong>24</strong></td>
              <td><span class="badge badge-halfpie">Half Pie</span></td>
            </tr>
            <tr>
              <td class="lb-rank">5</td>
              <td><div class="lb-player"><svg class="lb-avatar" viewBox="0 0 32 32"><rect width="32" height="32" rx="16" fill="#E63946"/><text x="16" y="21" text-anchor="middle" fill="#fff" font-size="13" font-weight="bold">D</text></svg><span class="lb-name">DoughBoy99</span></div></td>
              <td><strong>19</strong></td>
              <td><span class="badge badge-halfpie">Half Pie</span></td>
            </tr>
            <tr>
              <td class="lb-rank">6</td>
              <td><div class="lb-player"><svg class="lb-avatar" viewBox="0 0 32 32"><rect width="32" height="32" rx="16" fill="#2DC653"/><text x="16" y="21" text-anchor="middle" fill="#fff" font-size="13" font-weight="bold">T</text></svg><span class="lb-name">ToppingTitan</span></div></td>
              <td><strong>15</strong></td>
              <td><span class="badge badge-slice">Slice</span></td>
            </tr>
            <tr>
              <td class="lb-rank">7</td>
              <td><div class="lb-player"><svg class="lb-avatar" viewBox="0 0 32 32"><rect width="32" height="32" rx="16" fill="#FFB703"/><text x="16" y="21" text-anchor="middle" fill="#fff" font-size="13" font-weight="bold">O</text></svg><span class="lb-name">OvenMaster</span></div></td>
              <td><strong>12</strong></td>
              <td><span class="badge badge-slice">Slice</span></td>
            </tr>
            <tr>
              <td class="lb-rank">8</td>
              <td><div class="lb-player"><svg class="lb-avatar" viewBox="0 0 32 32"><rect width="32" height="32" rx="16" fill="#555"/><text x="16" y="21" text-anchor="middle" fill="#fff" font-size="13" font-weight="bold">G</text></svg><span class="lb-name">GrabNGo</span></div></td>
              <td><strong>9</strong></td>
              <td><span class="badge badge-breadstick">Breadstick</span></td>
            </tr>
          </tbody>
        </table>
        <div class="your-rank-bar">
          <div class="lb-player">
            <svg class="lb-avatar" viewBox="0 0 32 32"><rect width="32" height="32" rx="16" fill="var(--pepperoni)"/><text x="16" y="21" text-anchor="middle" fill="#fff" font-size="13" font-weight="bold">Y</text></svg>
            <span class="lb-name">You</span>
          </div>
          <div>
            <span style="color:var(--text-dim);font-size:0.85rem;">Rank </span>
            <strong style="color:var(--mozzarella);">#42</strong>
            <span style="color:var(--text-dim);font-size:0.85rem;margin-left:1rem;">3 wins</span>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- ==================== PROFILE PAGE ==================== -->
<div class="page" id="page-profile">
  <section class="section">
    <div class="container">
      <div class="section-header">
        <h2 class="section-title">Your Profile</h2>
      </div>

      <!-- Stats -->
      <div class="profile-stats-grid">
        <div class="profile-stat-card">
          <div class="profile-stat-value mozzarella" id="profile-plays">142</div>
          <div class="profile-stat-label">Total Plays</div>
        </div>
        <div class="profile-stat-card">
          <div class="profile-stat-value basil" id="profile-wins">12</div>
          <div class="profile-stat-label">Wins</div>
        </div>
        <div class="profile-stat-card">
          <div class="profile-stat-value pepperoni" id="profile-rate">8.4%</div>
          <div class="profile-stat-label">Win Rate</div>
        </div>
        <div class="profile-stat-card">
          <div class="profile-stat-value mozzarella" id="profile-credits">5</div>
          <div class="profile-stat-label">Credits</div>
        </div>
      </div>

      <!-- Referrals -->
      <div class="referral-section">
        <h3 style="font-size:1.1rem;font-weight:700;margin-bottom:1rem;">Referral Program</h3>
        <div class="referral-tier">
          <div class="tier-icon bronze">&#127942;</div>
          <div>
            <div class="tier-name">Bronze</div>
            <div class="tier-subtitle">Invite 5 more friends for Silver</div>
          </div>
        </div>
        <div class="progress-track">
          <div class="progress-fill" style="width:30%;"></div>
        </div>
        <div class="progress-label">3 / 10 referrals to Silver</div>
        <div class="referral-link-box">
          <input type="text" value="https://claw.pizza/?ref=user123" readonly id="referral-link" aria-label="Referral link">
          <button class="btn btn-secondary btn-sm" id="btn-copy-ref">Copy</button>
          <button class="btn btn-sm" style="background:#000;color:#fff;" id="btn-share-x" onclick="(function(){var ref=document.getElementById('referral-link').value;var t=encodeURIComponent('Play CLAW.PIZZA - the free online claw machine with virtual prizes! \uD83C\uDF55\uD83C\uDFAE\n\nGrab plushies, gift cards & more. No catch!\n\n@SpunkArt13 #ClawPizza #GrabYourSlice #WinPrizes #FreePrizes');window.open('https://twitter.com/intent/tweet?text='+t+'&url='+encodeURIComponent(ref),'_blank','width=600,height=400')})()">
            <svg style="width:16px;height:16px;" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
            Share
          </button>
        </div>
        <div class="referral-stats">
          <div class="ref-stat">
            <div class="ref-stat-val">3</div>
            <div class="ref-stat-label">Signups</div>
          </div>
          <div class="ref-stat">
            <div class="ref-stat-val">18</div>
            <div class="ref-stat-label">Plays from Refs</div>
          </div>
          <div class="ref-stat">
            <div class="ref-stat-val">9</div>
            <div class="ref-stat-label">Credits Earned</div>
          </div>
        </div>
      </div>

      <!-- Daily Streak -->
      <div class="streak-section">
        <h3 style="font-size:1.1rem;font-weight:700;">Daily Streak</h3>
        <p style="color:var(--text-dim);font-size:0.85rem;">Play every day for bonus credits</p>
        <div class="streak-calendar">
          <div class="streak-dot active">M</div>
          <div class="streak-dot active">T</div>
          <div class="streak-dot active">W</div>
          <div class="streak-dot active">T</div>
          <div class="streak-dot today">F</div>
          <div class="streak-dot">S</div>
          <div class="streak-dot">S</div>
        </div>
        <p style="text-align:center;margin-top:0.75rem;font-size:0.85rem;color:var(--mozzarella);font-weight:600;">4-day streak! Play today for 5x bonus.</p>
      </div>

      <!-- Play History -->
      <div class="card" style="margin-bottom:2rem;">
        <h3 style="font-size:1.1rem;font-weight:700;margin-bottom:1rem;">Play History</h3>
        <div class="play-history">
          <div class="history-item">
            <div>
              <div class="history-machine">Pizza Paradise</div>
              <div class="history-time">Today, 2:34 PM</div>
            </div>
            <span class="history-result win">Won - AirPods Pro</span>
          </div>
          <div class="history-item">
            <div>
              <div class="history-machine">Cheesy Grabber</div>
              <div class="history-time">Today, 2:12 PM</div>
            </div>
            <span class="history-result loss">No grab</span>
          </div>
          <div class="history-item">
            <div>
              <div class="history-machine">Margherita Mix</div>
              <div class="history-time">Today, 1:58 PM</div>
            </div>
            <span class="history-result loss">No grab</span>
          </div>
          <div class="history-item">
            <div>
              <div class="history-machine">Starter Oven</div>
              <div class="history-time">Yesterday, 11:20 PM</div>
            </div>
            <span class="history-result win">Won - $25 Gift Card</span>
          </div>
          <div class="history-item">
            <div>
              <div class="history-machine">Deep Dish Deluxe</div>
              <div class="history-time">Yesterday, 10:45 PM</div>
            </div>
            <span class="history-result loss">No grab</span>
          </div>
        </div>
      </div>

      <!-- Settings -->
      <div class="card" style="margin-bottom:2rem;">
        <h3 style="font-size:1.1rem;font-weight:700;margin-bottom:1rem;">Settings</h3>
        <div class="settings-section">
          <div class="setting-row">
            <div class="setting-label">
              Client Seed
              <small>Change your seed for provably fair verification</small>
            </div>
            <input type="text" value="my-custom-seed-42" style="width:180px;font-size:0.8rem;" id="client-seed" aria-label="Client seed">
          </div>
          <div class="setting-row">
            <div class="setting-label">
              Sound Effects
              <small>Toggle game audio on or off</small>
            </div>
            <button class="toggle active" id="toggle-sound" aria-label="Toggle sound"></button>
          </div>
          <div class="setting-row">
            <div class="setting-label">
              Notifications
              <small>Get alerts for free credits and wins</small>
            </div>
            <button class="toggle" id="toggle-notifs" aria-label="Toggle notifications"></button>
          </div>
        </div>
      </div>

      <!-- Active Challenges -->
      <div class="challenges-section">
        <h3 style="font-size:1.1rem;font-weight:700;margin-bottom:1rem;">Active Challenges</h3>
        <div class="challenge-card">
          <div class="challenge-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="var(--mozzarella)" stroke-width="2" style="width:20px;height:20px;"><circle cx="12" cy="12" r="10"/><path d="M12 6 V12 L16 14"/></svg>
          </div>
          <div class="challenge-info">
            <div class="challenge-name">First Timer</div>
            <div class="challenge-progress">Play 5 games (3/5)</div>
          </div>
          <div class="challenge-reward">+5 credits</div>
        </div>
        <div class="challenge-card">
          <div class="challenge-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="var(--basil)" stroke-width="2" style="width:20px;height:20px;"><path d="M12 2 L15 8 L22 9 L17 14 L18 21 L12 18 L6 21 L7 14 L2 9 L9 8 Z"/></svg>
          </div>
          <div class="challenge-info">
            <div class="challenge-name">Lucky Streak</div>
            <div class="challenge-progress">Win 3 times in a row (1/3)</div>
          </div>
          <div class="challenge-reward">+15 credits</div>
        </div>
        <div class="challenge-card">
          <div class="challenge-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="var(--pepperoni)" stroke-width="2" style="width:20px;height:20px;"><path d="M17 21 V19 Q17 15 12 15 Q7 15 7 19 V21"/><circle cx="12" cy="9" r="4"/></svg>
          </div>
          <div class="challenge-info">
            <div class="challenge-name">Social Butterfly</div>
            <div class="challenge-progress">Refer 3 friends (1/3)</div>
          </div>
          <div class="challenge-reward">+10 credits</div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- ==================== HOW IT WORKS PAGE ==================== -->
<div class="page" id="page-how">
  <section class="section">
    <div class="container">
      <div class="section-header">
        <h2 class="section-title">How It Works</h2>
        <p class="section-subtitle">Four steps to playing</p>
      </div>

      <div class="steps-grid">
        <div class="step-card">
          <div class="step-number">1</div>
          <div class="step-icon">
            <svg viewBox="0 0 48 48" fill="none" stroke="var(--mozzarella)" stroke-width="2"><rect x="8" y="4" width="32" height="40" rx="4"/><circle cx="24" cy="24" r="8"/><path d="M20 16 h8"/></svg>
          </div>
          <h3 class="step-title">Choose a Machine</h3>
          <p class="step-desc">Browse machines by tier from free Breadstick to premium Supreme. Each has unique prizes inside.</p>
        </div>
        <div class="step-card">
          <div class="step-number">2</div>
          <div class="step-icon">
            <svg viewBox="0 0 48 48" fill="none" stroke="var(--pepperoni)" stroke-width="2"><path d="M24 8 V20"/><path d="M16 14 L24 22 L32 14"/><path d="M12 22 Q12 34 24 38 Q36 34 36 22"/></svg>
          </div>
          <h3 class="step-title">Position the Claw</h3>
          <p class="step-desc">Tap or click where you want the claw to go. It glides smoothly to your target. You can also use WASD or swipe to fine-tune.</p>
        </div>
        <div class="step-card">
          <div class="step-number">3</div>
          <div class="step-icon">
            <svg viewBox="0 0 48 48" fill="none" stroke="var(--basil)" stroke-width="2"><path d="M24 8 V28"/><path d="M14 18 L24 28 L34 18"/><circle cx="24" cy="38" r="6"/></svg>
          </div>
          <h3 class="step-title">Drop &amp; Grab</h3>
          <p class="step-desc">Hit the grab button and watch the claw descend. The grip strength is determined by a provably fair algorithm.</p>
        </div>
        <div class="step-card">
          <div class="step-number">4</div>
          <div class="step-icon">
            <svg viewBox="0 0 48 48" fill="none" stroke="var(--mozzarella)" stroke-width="2"><path d="M24 4 L28 16 L40 18 L32 26 L34 38 L24 32 L14 38 L16 26 L8 18 L20 16 Z"/></svg>
          </div>
          <h3 class="step-title">Win Prizes</h3>
          <p class="step-desc">If you grab a prize, it gets added to your collection. Track all your wins in the Prize Gallery.</p>
        </div>
      </div>

      <!-- Provably Fair -->
      <div class="fair-section">
        <h3 style="font-size:1.25rem;font-weight:700;margin-bottom:0.5rem;">Provably Fair</h3>
        <p style="color:var(--text-dim);font-size:0.9rem;margin-bottom:1rem;">Every grab outcome is determined by a combination of the server seed, your client seed, and the nonce. You can verify any result independently.</p>
        <div class="code-block">
<pre>// Provably fair verification
const crypto = require('crypto');

function getOutcome(serverSeed, clientSeed, nonce) {
  const hash = crypto
    .createHmac('sha256', serverSeed)
    .update(`${clientSeed}:${nonce}`)
    .digest('hex');

  const roll = parseInt(hash.slice(0, 8), 16);
  return roll % 10000; // 0-9999
}</pre>
        </div>
        <p style="color:var(--text-dim);font-size:0.85rem;">The server seed is hashed before each session. After your session, the unhashed seed is revealed so you can verify the result.</p>
      </div>

      <!-- FAQ -->
      <div style="margin-top:2rem;">
        <h3 style="font-size:1.25rem;font-weight:700;margin-bottom:1rem;">Frequently Asked Questions</h3>
        <div class="faq-list">
          <div class="faq-item open">
            <button class="faq-question">
              Is this rigged?
              <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 8 L10 13 L15 8"/></svg>
            </button>
            <div class="faq-answer">
              <p>No. Every outcome is determined by a provably fair algorithm using cryptographic hashing. You can verify any result using your client seed, the server seed (revealed after your session), and the nonce. The math is open and auditable. We cannot manipulate outcomes.</p>
            </div>
          </div>
          <div class="faq-item">
            <button class="faq-question">
              How do I get free plays?
              <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 8 L10 13 L15 8"/></svg>
            </button>
            <div class="faq-answer">
              <p>You get 5 free credits every 24 hours from the daily faucet. You also earn credits by referring friends (3 credits per referral who plays), completing daily challenges, and maintaining play streaks. The Breadstick tier machines are always free to play.</p>
            </div>
          </div>
          <div class="faq-item">
            <button class="faq-question">
              What happens when I win?
              <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 8 L10 13 L15 8"/></svg>
            </button>
            <div class="faq-answer">
              <p>Virtual prizes are added to your collection in the Prize Gallery. You can view all your wins in the 'My Wins' tab anytime.</p>
            </div>
          </div>
          <div class="faq-item">
            <button class="faq-question">
              What payment methods are accepted?
              <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 8 L10 13 L15 8"/></svg>
            </button>
            <div class="faq-answer">
              <p>You can play for free every day with credits from the daily faucet and referral program. Optional credit packs are also available if you want more plays.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Trust Badges -->
      <div class="trust-badges">
        <div class="trust-badge">
          <svg viewBox="0 0 40 40" fill="none" stroke="var(--basil)" stroke-width="2"><path d="M20 4 L36 12 V24 C36 32 28 38 20 40 C12 38 4 32 4 24 V12 Z"/><path d="M14 20 L18 24 L26 16"/></svg>
          <span>Provably Fair</span>
        </div>
        <div class="trust-badge">
          <svg viewBox="0 0 40 40" fill="none" stroke="var(--basil)" stroke-width="2"><circle cx="20" cy="20" r="16"/><path d="M12 20 L18 26 L28 14"/></svg>
          <span>Instant Play</span>
        </div>
        <div class="trust-badge">
          <svg viewBox="0 0 40 40" fill="none" stroke="var(--basil)" stroke-width="2"><rect x="6" y="8" width="28" height="24" rx="3"/><path d="M6 16 H34"/><path d="M12 24 H22"/></svg>
          <span>Free to Play</span>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- ==================== BLOG PAGE ==================== -->
<div class="page" id="page-blog">
  <section class="section">
    <div class="container">
      <div class="section-header">
        <h2 class="section-title">Blog</h2>
        <p class="section-subtitle">Tips, news, and winner stories</p>
      </div>
      <div class="blog-grid">
        <div class="blog-card">
          <div class="blog-card-img"></div>
          <div class="blog-card-body">
            <div class="blog-card-date">Feb 20, 2026</div>
            <h3 class="blog-card-title">5 Tips to Master the Claw</h3>
            <p class="blog-card-excerpt">Learn positioning, timing, and strategy secrets from our top players who consistently win big prizes.</p>
            <a href="#" class="btn btn-sm btn-outline">Read More</a>
          </div>
        </div>
        <div class="blog-card">
          <div class="blog-card-img"></div>
          <div class="blog-card-body">
            <div class="blog-card-date">Feb 18, 2026</div>
            <h3 class="blog-card-title">New Supreme Machine: Pizza Paradise</h3>
            <p class="blog-card-excerpt">Our biggest machine yet is live with prizes worth up to $500. Here is everything you need to know.</p>
            <a href="#" class="btn btn-sm btn-outline">Read More</a>
          </div>
        </div>
        <div class="blog-card">
          <div class="blog-card-img"></div>
          <div class="blog-card-body">
            <div class="blog-card-date">Feb 15, 2026</div>
            <h3 class="blog-card-title">Winner Spotlight: SliceKing</h3>
            <p class="blog-card-excerpt">Meet the player who has won 47 prizes in a single month, including a PS5 and three pairs of AirPods.</p>
            <a href="#" class="btn btn-sm btn-outline">Read More</a>
          </div>
        </div>
        <div class="blog-card">
          <div class="blog-card-img"></div>
          <div class="blog-card-body">
            <div class="blog-card-date">Feb 12, 2026</div>
            <h3 class="blog-card-title">How Provably Fair Works</h3>
            <p class="blog-card-excerpt">A deep dive into our cryptographic fairness system and why every outcome is verifiable and tamper-proof.</p>
            <a href="#" class="btn btn-sm btn-outline">Read More</a>
          </div>
        </div>
        <div class="blog-card">
          <div class="blog-card-img"></div>
          <div class="blog-card-body">
            <div class="blog-card-date">Feb 10, 2026</div>
            <h3 class="blog-card-title">Referral Program Launched</h3>
            <p class="blog-card-excerpt">Earn free credits every time a friend signs up and plays. Climb tiers from Bronze to Diamond for bonus perks.</p>
            <a href="#" class="btn btn-sm btn-outline">Read More</a>
          </div>
        </div>
        <div class="blog-card">
          <div class="blog-card-img"></div>
          <div class="blog-card-body">
            <div class="blog-card-date">Feb 8, 2026</div>
            <h3 class="blog-card-title">February Prize Drop Preview</h3>
            <p class="blog-card-excerpt">Over $5,000 in new prizes added this month including gaming consoles, headphones, and gift cards.</p>
            <a href="#" class="btn btn-sm btn-outline">Read More</a>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- ==================== ADMIN PAGE ==================== -->
<div class="page" id="page-admin">
  <section class="section">
    <div class="container">
      <!-- Admin Login -->
      <div class="admin-login" id="admin-login">
        <h2>Admin Access</h2>
        <form class="admin-login-form" id="admin-login-form">
          <input type="password" placeholder="Enter admin password" id="admin-password" aria-label="Admin password">
          <button type="submit" class="btn btn-primary" style="width:100%;">Login</button>
        </form>
      </div>

      <!-- Admin Dashboard -->
      <div class="admin-dashboard" id="admin-dashboard">
        <h2 style="margin-bottom:1.5rem;">Admin Dashboard</h2>

        <div class="admin-tabs">
          <button class="admin-tab active">Overview</button>
          <button class="admin-tab">Prizes</button>
          <button class="admin-tab">Users</button>
          <button class="admin-tab">Revenue</button>
          <button class="admin-tab">Machines</button>
        </div>

        <!-- Overview Stats -->
        <div class="admin-stats-grid">
          <div class="admin-stat-card">
            <div class="admin-stat-label">Revenue (Today)</div>
            <div class="admin-stat-value" style="color:var(--basil);">$1,247</div>
          </div>
          <div class="admin-stat-card">
            <div class="admin-stat-label">Total Plays (Today)</div>
            <div class="admin-stat-value" style="color:var(--mozzarella);">5,812</div>
          </div>
          <div class="admin-stat-card">
            <div class="admin-stat-label">Active Users</div>
            <div class="admin-stat-value" style="color:var(--pepperoni);">389</div>
          </div>
          <div class="admin-stat-card">
            <div class="admin-stat-label">Prizes Claimed</div>
            <div class="admin-stat-value">47</div>
          </div>
        </div>

        <!-- Prize Management -->
        <div class="card" style="margin-bottom:2rem;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;">
            <h3 style="font-weight:700;">Prize Management</h3>
            <button class="btn btn-primary btn-sm">+ Add Prize</button>
          </div>
          <div class="admin-table-wrap">
            <table class="admin-table">
              <thead>
                <tr><th>Prize</th><th>Value</th><th>Machine</th><th>Stock</th><th>Actions</th></tr>
              </thead>
              <tbody>
                <tr>
                  <td>PlayStation 5 Digital</td><td>$449</td><td>Pizza Paradise</td><td>2</td>
                  <td><div class="admin-actions"><button class="btn-edit">Edit</button><button class="btn-delete">Delete</button></div></td>
                </tr>
                <tr>
                  <td>AirPods Pro 2</td><td>$249</td><td>Deep Dish Deluxe</td><td>5</td>
                  <td><div class="admin-actions"><button class="btn-edit">Edit</button><button class="btn-delete">Delete</button></div></td>
                </tr>
                <tr>
                  <td>Nintendo Switch OLED</td><td>$349</td><td>Pizza Paradise</td><td>1</td>
                  <td><div class="admin-actions"><button class="btn-edit">Edit</button><button class="btn-delete">Delete</button></div></td>
                </tr>
                <tr>
                  <td>$50 Amazon Gift Card</td><td>$50</td><td>Margherita Mix</td><td>20</td>
                  <td><div class="admin-actions"><button class="btn-edit">Edit</button><button class="btn-delete">Delete</button></div></td>
                </tr>
                <tr>
                  <td>Mechanical Keyboard</td><td>$89</td><td>Cheesy Grabber</td><td>8</td>
                  <td><div class="admin-actions"><button class="btn-edit">Edit</button><button class="btn-delete">Delete</button></div></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Fulfillment Queue -->
        <div class="card">
          <h3 style="font-weight:700;margin-bottom:1rem;">Fulfillment Queue</h3>
          <div class="fulfillment-item">
            <div>
              <div style="font-weight:600;">AirPods Pro 2</div>
              <div style="font-size:0.8rem;color:var(--text-dim);">Won by PizzaFan42 - Feb 21, 2026</div>
            </div>
            <div style="display:flex;gap:0.5rem;">
              <button class="btn btn-sm btn-secondary">View Details</button>
              <button class="btn btn-sm btn-primary">Mark Claimed</button>
            </div>
          </div>
          <div class="fulfillment-item">
            <div>
              <div style="font-weight:600;">LED Strip Lights</div>
              <div style="font-size:0.8rem;color:var(--text-dim);">Won by DoughBoy99 - Feb 20, 2026</div>
            </div>
            <div style="display:flex;gap:0.5rem;">
              <button class="btn btn-sm btn-secondary">View Details</button>
              <button class="btn btn-sm btn-primary">Mark Claimed</button>
            </div>
          </div>
          <div class="fulfillment-item">
            <div>
              <div style="font-weight:600;">Bluetooth Speaker</div>
              <div style="font-size:0.8rem;color:var(--text-dim);">Won by CrustCrusher - Feb 20, 2026</div>
            </div>
            <div style="display:flex;gap:0.5rem;">
              <button class="btn btn-sm btn-secondary">View Details</button>
              <button class="btn btn-sm btn-primary">Mark Claimed</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

</div><!-- end .main-content -->

<!-- ==================== MODALS ==================== -->

<!-- Buy Credits Modal -->
<div class="modal-overlay" id="modal-buy">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">Buy Credits</h3>
      <button class="modal-close" data-close="modal-buy"><svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4 L14 14 M14 4 L4 14"/></svg></button>
    </div>
    <div class="credit-packs">
      <div class="credit-pack">
        <div class="pack-amount">10</div>
        <div class="pack-credits">credits</div>
        <div class="pack-price">$4.99</div>
      </div>
      <div class="credit-pack popular">
        <div class="pack-amount">30</div>
        <div class="pack-credits">credits</div>
        <div class="pack-price">$9.99</div>
      </div>
      <div class="credit-pack">
        <div class="pack-amount">75</div>
        <div class="pack-credits">credits</div>
        <div class="pack-price">$19.99</div>
      </div>
      <div class="credit-pack">
        <div class="pack-amount">200</div>
        <div class="pack-credits">credits</div>
        <div class="pack-price">$39.99</div>
      </div>
    </div>
    <div style="text-align:center;margin-top:1.25rem;">
      <p style="color:var(--text-dim);font-size:0.8rem;">Secure checkout via Stripe. BTC/ETH also accepted.</p>
    </div>
  </div>
</div>

<!-- VIP Modal -->
<div class="modal-overlay" id="modal-vip">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">VIP Membership</h3>
      <button class="modal-close" data-close="modal-vip"><svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4 L14 14 M14 4 L4 14"/></svg></button>
    </div>
    <div class="vip-tiers">
      <div class="vip-tier">
        <div class="vip-tier-name">Silver VIP</div>
        <div class="vip-tier-price">$9.99/month</div>
        <ul class="vip-perks">
          <li>10 bonus credits daily</li>
          <li>5% better grip strength</li>
          <li>Exclusive Silver badge</li>
          <li>Priority prize claims</li>
        </ul>
      </div>
      <div class="vip-tier" style="border-color:var(--mozzarella);">
        <div class="vip-tier-name" style="color:var(--mozzarella);">Gold VIP</div>
        <div class="vip-tier-price">$24.99/month</div>
        <ul class="vip-perks">
          <li>25 bonus credits daily</li>
          <li>10% better grip strength</li>
          <li>Access to Gold-only machines</li>
          <li>Exclusive Gold badge + profile border</li>
          <li>Free re-grabs (2 per day)</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Tip/Donate Modal -->
<div class="modal-overlay" id="modal-tip">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">Support Claw.Pizza</h3>
      <button class="modal-close" data-close="modal-tip"><svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4 L14 14 M14 4 L4 14"/></svg></button>
    </div>
    <div class="tip-modal-body">
      <p style="color:var(--text-dim);font-size:0.9rem;margin-bottom:1rem;">Love claw.pizza? Tips help us add bigger prizes and keep the faucet running.</p>
      <h4 style="font-size:0.9rem;margin-bottom:0.5rem;">Bitcoin (BTC)</h4>
      <div class="tip-btc-address">bc1pkepg42ctsvsxk499qu02qqyyz88gwjchnjpsu22wmng9rhpfv3jqw2t2hm</div>
      <div class="tip-qr-placeholder">QR Code</div>
      <button class="btn btn-secondary btn-sm" id="btn-copy-btc">Copy Address</button>
    </div>
  </div>
</div>

<!-- Win Share Modal -->
<div class="modal-overlay" id="modal-share">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">Share Your Win</h3>
      <button class="modal-close" data-close="modal-share"><svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4 L14 14 M14 4 L4 14"/></svg></button>
    </div>
    <div class="share-preview">YOUR WIN IMAGE</div>
    <div style="display:flex;gap:0.75rem;justify-content:center;">
      <button class="btn btn-sm" style="background:#000;color:#fff;" onclick="(function(){var t=encodeURIComponent('I just won a prize on CLAW.PIZZA! \uD83C\uDF55\uD83C\uDFAF\n\nFree online claw machine with virtual prizes. Play now!\n\n@SpunkArt13 #ClawPizza #GrabYourSlice #WinPrizes #FreePrizes');var u=encodeURIComponent('https://spunkeroo.github.io/claw-pizza/');window.open('https://twitter.com/intent/tweet?text='+t+'&url='+u,'_blank','width=600,height=400')})()">
        <svg style="width:16px;height:16px;" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
        Share on X
      </button>
      <button class="btn btn-sm btn-secondary" onclick="(function(){if(typeof ClawApp!=='undefined'&&ClawApp.shareWin)ClawApp.shareWin('Prize','0','classic')})()">Download Image</button>
      <button class="btn btn-sm btn-secondary" onclick="navigator.clipboard.writeText('https://spunkeroo.github.io/claw-pizza/').then(function(){alert('Link copied!')})">Copy Link</button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="modal-settings">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">Settings</h3>
      <button class="modal-close" data-close="modal-settings"><svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4 L14 14 M14 4 L4 14"/></svg></button>
    </div>
    <div class="settings-modal-body">
      <div class="form-group">
        <label>Display Name</label>
        <input type="text" placeholder="Anonymous" value="Player42" aria-label="Display name">
      </div>
      <div class="form-group">
        <label>Email (for notifications)</label>
        <input type="email" placeholder="your@email.com" aria-label="Email">
      </div>
      <div class="setting-row">
        <div class="setting-label">Dark Mode</div>
        <button class="toggle active" aria-label="Toggle dark mode"></button>
      </div>
      <div class="setting-row">
        <div class="setting-label">Animations</div>
        <button class="toggle active" aria-label="Toggle animations"></button>
      </div>
      <button class="btn btn-primary" style="width:100%;margin-top:0.5rem;">Save Settings</button>
    </div>
  </div>
</div>

<!-- ==================== TOAST CONTAINER ==================== -->
<div id="toast-container">
  <div class="toast success" style="display:none;">
    <div class="toast-icon"><svg viewBox="0 0 20 20" fill="none" stroke="var(--basil)" stroke-width="2"><circle cx="10" cy="10" r="8"/><path d="M6 10 L9 13 L14 7"/></svg></div>
    <div class="toast-msg">Credits claimed successfully!</div>
    <button class="toast-close"><svg viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3 L11 11 M11 3 L3 11"/></svg></button>
  </div>
  <div class="toast error" style="display:none;">
    <div class="toast-icon"><svg viewBox="0 0 20 20" fill="none" stroke="var(--pepperoni)" stroke-width="2"><circle cx="10" cy="10" r="8"/><path d="M7 7 L13 13 M13 7 L7 13"/></svg></div>
    <div class="toast-msg">Not enough credits!</div>
    <button class="toast-close"><svg viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3 L11 11 M11 3 L3 11"/></svg></button>
  </div>
  <div class="toast info" style="display:none;">
    <div class="toast-icon"><svg viewBox="0 0 20 20" fill="none" stroke="var(--mozzarella)" stroke-width="2"><circle cx="10" cy="10" r="8"/><path d="M10 9 V14"/><circle cx="10" cy="6.5" r="0.5" fill="var(--mozzarella)"/></svg></div>
    <div class="toast-msg">New machine added!</div>
    <button class="toast-close"><svg viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3 L11 11 M11 3 L3 11"/></svg></button>
  </div>
</div>

<!-- ==================== FOOTER ==================== -->
<footer class="site-footer">
  <div class="container">
    <div class="footer-grid">
      <div class="footer-brand">
        <a href="#" class="nav-logo">
          <svg viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg" style="width:28px;height:28px;">
            <rect x="12" y="0" width="4" height="10" rx="1" fill="#888"/>
            <rect x="20" y="0" width="4" height="10" rx="1" fill="#888"/>
            <path d="M8 8 L28 8 L30 14 L6 14 Z" fill="#aaa"/>
            <path d="M10 14 L26 14 L26 20 Q26 22 24 22 L12 22 Q10 22 10 20 Z" fill="#999"/>
            <path d="M14 22 L22 22 L22 26 L14 26 Z" fill="#888"/>
            <path d="M18 26 L30 38 L6 38 Z" fill="#FFB703"/>
            <circle cx="15" cy="33" r="2.5" fill="#E63946"/>
            <circle cx="21" cy="32" r="2" fill="#E63946"/>
          </svg>
          claw.pizza
        </a>
        <p>Grab your slice. Win virtual prizes with provably fair claw machines. Free to play, every day.</p>
        <div class="footer-social">
          <a href="https://x.com/ClawPizza" target="_blank" rel="noopener" aria-label="Follow on X">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
          </a>
        </div>
      </div>
      <div class="footer-col">
        <h4>Play</h4>
        <ul class="footer-links">
          <li><a href="#" data-page="machines">All Machines</a></li>
          <li><a href="#" data-page="prizes">Prizes</a></li>
          <li><a href="#" data-page="leaderboard">Leaderboard</a></li>
          <li><a href="#" data-page="blog">Blog</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <h4>Info</h4>
        <ul class="footer-links">
          <li><a href="#" data-page="how">How It Works</a></li>
          <li><a href="#">Provably Fair</a></li>
          <li><a href="#">About</a></li>
          <li><a href="#">Contact</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <h4>Legal</h4>
        <ul class="footer-links">
          <li><a href="#">Privacy Policy</a></li>
          <li><a href="#">Terms of Service</a></li>
          <li><a href="#">Cookie Policy</a></li>
        </ul>
      </div>
    </div>

    <div style="text-align:center;padding:20px 0;border-top:1px solid rgba(255,255,255,0.08);margin-bottom:16px;">
      <h4 style="margin-bottom:10px;color:#E5E4E2;">Get Exclusive Deals & Updates</h4>
      <p style="font-size:0.85rem;color:rgba(255,255,255,0.6);margin-bottom:12px;">Join our newsletter for new machines, prizes, and insider content.</p>
      <iframe src="https://embeds.beehiiv.com/6831d05b-f121-4e0d-951b-16f88ddd9ec3?slim=true" height="52" frameborder="0" scrolling="no" style="margin:0;border-radius:8px;background-color:transparent;width:100%;max-width:400px;"></iframe>
      <p style="margin-top:8px;font-size:0.7rem;color:rgba(255,255,255,0.4);">No spam. Unsubscribe anytime.</p>
    </div>

    <div class="footer-promo">
      <h4>More from our network</h4>
      <div class="footer-promo-links">
        <a href="https://spunk.bet" target="_blank" rel="noopener">Spunk.Bet</a>
        <a href="https://spunk.codes" target="_blank" rel="noopener">SpunkArt.com</a>
        <a href="https://predict.horse" target="_blank" rel="noopener">Predict.Horse</a>
      </div>
    </div>

    <div style="margin-top:1.5rem;padding-top:1rem;border-top:1px solid rgba(255,255,255,0.06);text-align:center;">
      <div style="font-size:0.6rem;font-weight:700;color:var(--mozzarella, #FFB703);text-transform:uppercase;letter-spacing:1px;margin-bottom:0.6rem;">Partners & Affiliates</div>
      <div style="display:flex;justify-content:center;gap:1.2rem;flex-wrap:wrap;">
        <a href="https://stake.com/?c=MyXSehCn" target="_blank" rel="noopener sponsored" style="color:#1475e1;font-size:0.65rem;font-weight:700;text-decoration:none;">Stake.com</a>
        <a href="https://stake.us/?c=L2a8nG6c" target="_blank" rel="noopener sponsored" style="color:#00c74d;font-size:0.65rem;font-weight:700;text-decoration:none;">Stake.us</a>
        <a href="https://shuffle.com/?r=q94atl9m05" target="_blank" rel="noopener sponsored" style="color:#7c3aed;font-size:0.65rem;font-weight:700;text-decoration:none;">Shuffle</a>
        <a href="https://coinbase.com/join/YAGES3X?src=referral-link" target="_blank" rel="noopener sponsored" style="color:#0052ff;font-size:0.65rem;font-weight:700;text-decoration:none;">Buy Crypto</a>
        <a href="https://shop.ledger.com/?r=0553c9ea1441" target="_blank" rel="noopener sponsored" style="color:#ff5500;font-size:0.65rem;font-weight:700;text-decoration:none;">Secure Your Crypto</a>
        <a href="https://kalshi.com/sign-up/?referral=6b723b42-d0c9-4421-9b4e-5af4b4c6c42c" target="_blank" rel="noopener sponsored" style="color:#00d084;font-size:0.65rem;font-weight:700;text-decoration:none;">Trade on Kalshi</a>
        <a href="https://winna.com/?r=Spunkeroo" target="_blank" rel="noopener sponsored" style="color:#ff5f1f;font-size:0.65rem;font-weight:700;text-decoration:none;">Winna.com</a>
        <a href="https://everyx.io/?ref=AYHl4YqvjcaX" target="_blank" rel="noopener sponsored" style="color:#a855f7;font-size:0.65rem;font-weight:700;text-decoration:none;">EveryX Markets</a>
        <a href="https://customgpt.ai/?fpr=spunk" target="_blank" rel="noopener sponsored" style="color:#06b6d4;font-size:0.65rem;font-weight:700;text-decoration:none;">CustomGPT</a>
        <a href="https://spunk.codes" target="_blank" rel="noopener noreferrer" style="color:#8888a0;font-size:0.65rem;font-weight:600;text-decoration:none;">SpunkArt Store</a>
        <a href="https://spunk.codes/ebook" target="_blank" rel="noopener noreferrer" style="color:#8888a0;font-size:0.65rem;font-weight:600;text-decoration:none;">SpunkArt Ebook</a>
      </div>
    </div>

    <div class="footer-bottom">
      <p>&copy; 2026 claw.pizza. All rights reserved.</p>
      <p class="footer-affiliate">As an Amazon Associate, we earn from qualifying purchases. Prize selections may include affiliate products.</p>
    </div>
  </div>
<div style="max-width:600px;margin:40px auto;padding:30px;background:#111;border:1px solid #ff5f1f;border-radius:12px;text-align:center;font-family:-apple-system,BlinkMacSystemFont,sans-serif">
  <h3 style="color:#ff5f1f;margin:0 0 10px;font-size:20px">Free Tools for Solo Founders</h3>
  <p style="color:#ccc;margin:0 0 15px;font-size:14px;line-height:1.5">75+ browser-based tools. No signup, no fees, 100% free.</p>
  <a href="https://spunk.codes" target="_blank" rel="noopener" style="display:inline-block;background:#ff5f1f;color:#fff;padding:12px 30px;border-radius:8px;text-decoration:none;font-weight:700;font-size:15px">Browse Free Tools ‚Üí</a>
  <p style="color:#888;margin:12px 0 0;font-size:12px">Or get the <a href="https://monkeyshine40.gumroad.com/l/mhmzrz" target="_blank" rel="noopener" style="color:#ff5f1f;text-decoration:none">complete offline bundle for $9.99</a> ¬∑ <a href="https://monkeyshine40.gumroad.com/l/wtunlc" target="_blank" rel="noopener" style="color:#10b981;text-decoration:none">Resell for unlimited profit</a></p>
</div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
<script>
// Claw Pizza - 3D Claw Machine Engine
// Uses THREE (Three.js) and CANNON (cannon.js) as globals from CDN
(function () {
  'use strict';

  // ‚îÄ‚îÄ‚îÄ TIER DEFINITIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const TIERS = {
    breadstick: { color: '#2DC653', grip: 0.70, cost: 0.50, label: 'Breadstick' },
    slice:      { color: '#FFB703', grip: 0.55, cost: 1.00, label: 'Slice' },
    halfpie:    { color: '#FF8C00', grip: 0.40, cost: 2.00, label: 'Half Pie' },
    fullpie:    { color: '#E63946', grip: 0.30, cost: 5.00, label: 'Full Pie' },
    supreme:    { color: '#FFD700', grip: 0.20, cost: 10.00, label: 'Supreme' }
  };

  // ‚îÄ‚îÄ‚îÄ STATE MACHINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const STATES = {
    IDLE: 'IDLE',
    MOVING: 'MOVING',
    DROPPING: 'DROPPING',
    GRABBING: 'GRABBING',
    LIFTING: 'LIFTING',
    RETURNING: 'RETURNING',
    RELEASING: 'RELEASING',
    RESULT: 'RESULT'
  };

  // ‚îÄ‚îÄ‚îÄ MACHINE DIMENSIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const MACHINE = {
    width: 4,
    depth: 4,
    height: 5,
    wallThickness: 0.08,
    glassOpacity: 0.15,
    pitHeight: 1.8,
    railY: 4.2,
    homeX: 0,
    homeZ: -0.5,
    dropZoneX: 2.8,
    dropZoneZ: 0,
    moveSpeed: 3.5,
    dropSpeed: 3.0,
    liftSpeed: 1.8,
    returnSpeed: 2.2,
    moveTimeLimit: 45,
    clawOpenAngle: Math.PI / 5,
    clawClosedAngle: Math.PI / 14,
    cableMinLen: 0.3,
    cableMaxLen: 3.0
  };

  // ‚îÄ‚îÄ‚îÄ PRIZE COLORS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const PRIZE_COLORS = [
    '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7',
    '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9',
    '#F0B27A', '#82E0AA', '#F1948A', '#AED6F1', '#D7BDE2'
  ];

  const PRIZE_NAMES = [
    'Pepperoni Slice', 'Cheese Pull', 'Golden Crust', 'Margherita Dream',
    'Supreme Stack', 'Stuffed Crust', 'Pizza Gem', 'Dough Ball',
    'Calzone Roll', 'Deep Dish', 'Thin Crust Special', 'BBQ Chicken',
    'Hawaiian Treat', 'Truffle Oil', 'Sausage Ring'
  ];

  // ‚îÄ‚îÄ‚îÄ ENGINE STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let scene, camera, renderer, world, container;
  let currentTier = null;
  let state = STATES.IDLE;
  let onResultCallback = null;
  let animationFrameId = null;
  let clock = null;

  // Claw components
  let clawGroup, carriageGroup, cableGroup;
  let clawFingers = [];
  let cableMesh = null;
  let clawX = MACHINE.homeX;
  let clawZ = MACHINE.homeZ;
  let clawY = MACHINE.railY;
  let cableLength = MACHINE.cableMinLen;
  let fingerAngle = MACHINE.clawOpenAngle;
  let targetFingerAngle = MACHINE.clawOpenAngle;

  // Movement input
  let moveInput = { x: 0, z: 0 };
  let moveTimer = MACHINE.moveTimeLimit;
  let moveTimerInterval = null;

  // Physics bodies
  let groundBody, prizeBodies = [], prizeConstraint = null;
  let wallBodies = [];
  let grabbedPrizeIndex = -1;

  // Prize meshes
  let prizeMeshes = [];
  let prizeData = [];

  // Provably fair
  let serverSeed = '';
  let serverSeedHash = '';
  let clientSeed = '';
  let nonce = 0;
  let lastRollResult = null;

  // Particles
  let confettiParticles = [];
  let confettiGroup = null;

  // Timer display element
  let timerEl = null;

  // Virtual joystick state
  let joystick = { active: false, el: null, knob: null, startX: 0, startY: 0, dx: 0, dy: 0 };
  let grabButton = null;

  // Click-to-position state
  let targetClawX = null;  // null = no target, use keyboard/joystick
  let targetClawZ = null;
  let smoothMoveSpeed = 7.0;  // speed for smooth glide to target
  let crosshairEl = null;
  let dropShadowEl = null;
  let positionLineEl = null;
  let tapHintEl = null;
  let tutorialShown = false;
  let raycaster = null;
  let raycastPlane = null;  // invisible plane at rail height for click projection

  // LED strips
  let ledStrips = [];
  let ledTime = 0;

  // Camera shake
  let cameraShake = { active: false, intensity: 0, decay: 0.92 };
  let cameraBasePos = new THREE.Vector3();

  // Desktop improvements state
  let quickPlayEnabled = false;
  let quickPlayTimer = null;
  let mouseHoverPreviewEl = null;
  let keyboardOverlayEl = null;
  let gridLinesGroup = null;
  let cameraZoom = 1.0;
  const CAMERA_ZOOM_MIN = 0.7;
  const CAMERA_ZOOM_MAX = 1.4;
  const CAMERA_ZOOM_STEP = 0.05;
  // Smooth WASD acceleration
  let keyAccel = { x: 0, z: 0 };
  const KEY_ACCEL_RATE = 6.0;   // how fast speed ramps up (units/s^2)
  const KEY_ACCEL_MAX = 1.0;    // max multiplier
  const KEY_DECEL_RATE = 8.0;   // how fast it decelerates when released

  // ‚îÄ‚îÄ‚îÄ PROVABLY FAIR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  async function hmacSha256(key, message) {
    const enc = new TextEncoder();
    const cryptoKey = await crypto.subtle.importKey(
      'raw', enc.encode(key), { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']
    );
    const sig = await crypto.subtle.sign('HMAC', cryptoKey, enc.encode(message));
    return Array.from(new Uint8Array(sig)).map(b => b.toString(16).padStart(2, '0')).join('');
  }

  async function sha256(message) {
    const enc = new TextEncoder();
    const hash = await crypto.subtle.digest('SHA-256', enc.encode(message));
    return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
  }

  function hexToFloat(hex8) {
    return parseInt(hex8, 16) / 0xFFFFFFFF;
  }

  async function generateServerSeedInternal() {
    const arr = new Uint8Array(32);
    crypto.getRandomValues(arr);
    serverSeed = Array.from(arr).map(b => b.toString(16).padStart(2, '0')).join('');
    serverSeedHash = await sha256(serverSeed);
    return serverSeedHash;
  }

  function generateClientSeed() {
    const arr = new Uint8Array(16);
    crypto.getRandomValues(arr);
    return Array.from(arr).map(b => b.toString(16).padStart(2, '0')).join('');
  }

  async function computeRoll(sSeed, cSeed, n) {
    const hmac = await hmacSha256(sSeed, cSeed + ':' + n);
    const first8 = hmac.substring(0, 8);
    return hexToFloat(first8);
  }

  // ‚îÄ‚îÄ‚îÄ CREDIT SYSTEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  // Credit system delegates to ClawApp when available, falls back to localStorage
  function getCredits() {
    if (window.ClawApp && window.ClawApp.getCredits) return window.ClawApp.getCredits();
    try {
      const v = localStorage.getItem('claw_credits');
      if (v !== null) return JSON.parse(v);
      localStorage.setItem('claw_credits', JSON.stringify(3));
      return 3;
    } catch { return 0; }
  }

  function spendCredits(amount) {
    if (window.ClawApp && window.ClawApp.spendCredits) return window.ClawApp.spendCredits(amount);
    const cur = getCredits();
    if (cur < amount) return false;
    try { localStorage.setItem('claw_credits', JSON.stringify(cur - amount)); } catch {}
    return true;
  }

  function addCredits(amount) {
    if (window.ClawApp && window.ClawApp.addCredits) return window.ClawApp.addCredits(amount);
    try { localStorage.setItem('claw_credits', JSON.stringify(getCredits() + amount)); } catch {}
  }

  function updateCreditDisplay() {
    if (window.ClawApp && window.ClawApp.updateCreditDisplays) {
      window.ClawApp.updateCreditDisplays();
    }
  }

  // ‚îÄ‚îÄ‚îÄ THREE.JS SCENE SETUP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function initScene(containerId) {
    container = document.getElementById(containerId);
    if (!container) throw new Error('Container not found: ' + containerId);

    // Scene
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0a0a0f);
    scene.fog = new THREE.FogExp2(0x0a0a0f, 0.04);

    // Camera
    camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 100);
    camera.position.set(0, 4, 7.5);
    camera.lookAt(0, 2, 0);
    cameraBasePos.copy(camera.position);

    // Renderer
    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.2;
    container.appendChild(renderer.domElement);

    // Lights
    const ambient = new THREE.AmbientLight(0x404060, 0.6);
    scene.add(ambient);

    const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
    dirLight.position.set(3, 8, 5);
    dirLight.castShadow = true;
    dirLight.shadow.mapSize.set(1024, 1024);
    dirLight.shadow.camera.near = 0.5;
    dirLight.shadow.camera.far = 20;
    dirLight.shadow.camera.left = -5;
    dirLight.shadow.camera.right = 5;
    dirLight.shadow.camera.top = 8;
    dirLight.shadow.camera.bottom = -2;
    scene.add(dirLight);

    const pointLight1 = new THREE.PointLight(0x4488ff, 0.5, 10);
    pointLight1.position.set(-2, 5, 3);
    scene.add(pointLight1);

    const pointLight2 = new THREE.PointLight(0xff4488, 0.4, 10);
    pointLight2.position.set(2, 3, -2);
    scene.add(pointLight2);

    // Resize
    window.addEventListener('resize', onResize);

    clock = new THREE.Clock();
  }

  function onResize() {
    if (!container || !camera || !renderer) return;
    camera.aspect = container.clientWidth / container.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(container.clientWidth, container.clientHeight);
  }

  // ‚îÄ‚îÄ‚îÄ CANNON-ES PHYSICS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function initPhysics() {
    world = new CANNON.World();
    world.gravity.set(0, -9.82, 0);
    world.broadphase = new CANNON.NaiveBroadphase();
    world.solver.iterations = 10;
    world.allowSleep = true;

    // Materials
    const groundMat = new CANNON.Material('ground');
    const wallMat = new CANNON.Material('wall');
    const prizeMat = new CANNON.Material('prize');
    const clawMat = new CANNON.Material('claw');

    world.addContactMaterial(new CANNON.ContactMaterial(prizeMat, groundMat, {
      friction: 0.6, restitution: 0.3
    }));
    world.addContactMaterial(new CANNON.ContactMaterial(prizeMat, wallMat, {
      friction: 0.4, restitution: 0.2
    }));
    world.addContactMaterial(new CANNON.ContactMaterial(clawMat, prizeMat, {
      friction: 0.9, restitution: 0.05
    }));
    world.addContactMaterial(new CANNON.ContactMaterial(prizeMat, prizeMat, {
      friction: 0.5, restitution: 0.25
    }));

    // Ground plane (pit floor)
    groundBody = new CANNON.Body({
      mass: 0,
      shape: new CANNON.Plane(),
      material: groundMat
    });
    groundBody.quaternion.setFromEuler(-Math.PI / 2, 0, 0);
    groundBody.position.set(0, 0.1, 0);
    world.addBody(groundBody);

    // Glass walls for prize pit
    const hw = MACHINE.width / 2;
    const hd = MACHINE.depth / 2;
    const wh = MACHINE.pitHeight;
    const wt = MACHINE.wallThickness;

    const wallPositions = [
      { pos: [0, wh / 2, -hd], size: [hw, wh / 2, wt / 2] },  // Back
      { pos: [0, wh / 2, hd], size: [hw, wh / 2, wt / 2] },   // Front
      { pos: [-hw, wh / 2, 0], size: [wt / 2, wh / 2, hd] },  // Left
      { pos: [hw, wh / 2, 0], size: [wt / 2, wh / 2, hd] },   // Right
    ];

    wallPositions.forEach(w => {
      const body = new CANNON.Body({
        mass: 0,
        shape: new CANNON.Box(new CANNON.Vec3(w.size[0], w.size[1], w.size[2])),
        material: wallMat
      });
      body.position.set(w.pos[0], w.pos[1], w.pos[2]);
      world.addBody(body);
      wallBodies.push(body);
    });
  }

  // ‚îÄ‚îÄ‚îÄ BUILD MACHINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function buildMachine(tier) {
    const t = TIERS[tier];
    const tierColor = new THREE.Color(t.color);

    // Floor / base
    const floorGeo = new THREE.BoxGeometry(MACHINE.width + 0.4, 0.2, MACHINE.depth + 0.4);
    const floorMat = new THREE.MeshStandardMaterial({ color: 0x1a1a2e, metalness: 0.7, roughness: 0.3 });
    const floor = new THREE.Mesh(floorGeo, floorMat);
    floor.position.set(0, 0, 0);
    floor.receiveShadow = true;
    scene.add(floor);

    // Pit floor (felt surface)
    const pitFloorGeo = new THREE.BoxGeometry(MACHINE.width - 0.1, 0.05, MACHINE.depth - 0.1);
    const pitFloorMat = new THREE.MeshStandardMaterial({ color: 0x1a1a3e, roughness: 0.9 });
    const pitFloor = new THREE.Mesh(pitFloorGeo, pitFloorMat);
    pitFloor.position.set(0, 0.12, 0);
    pitFloor.receiveShadow = true;
    scene.add(pitFloor);

    // Housing frame posts (4 vertical posts)
    const hw = MACHINE.width / 2;
    const hd = MACHINE.depth / 2;
    const postGeo = new THREE.BoxGeometry(0.15, MACHINE.height, 0.15);
    const postMat = new THREE.MeshStandardMaterial({ color: 0x2a2a3e, metalness: 0.8, roughness: 0.2 });
    const postPositions = [
      [-hw, MACHINE.height / 2, -hd],
      [hw, MACHINE.height / 2, -hd],
      [-hw, MACHINE.height / 2, hd],
      [hw, MACHINE.height / 2, hd]
    ];
    postPositions.forEach(p => {
      const post = new THREE.Mesh(postGeo, postMat);
      post.position.set(p[0], p[1], p[2]);
      post.castShadow = true;
      scene.add(post);
    });

    // Top panel
    const topGeo = new THREE.BoxGeometry(MACHINE.width + 0.2, 0.15, MACHINE.depth + 0.2);
    const topMat = new THREE.MeshStandardMaterial({ color: 0x2a2a3e, metalness: 0.7, roughness: 0.3 });
    const top = new THREE.Mesh(topGeo, topMat);
    top.position.set(0, MACHINE.height, 0);
    top.castShadow = true;
    scene.add(top);

    // Back panel (opaque)
    const backGeo = new THREE.BoxGeometry(MACHINE.width, MACHINE.height - 0.2, 0.08);
    const backMat = new THREE.MeshStandardMaterial({ color: 0x1a1a2e, metalness: 0.5, roughness: 0.5 });
    const back = new THREE.Mesh(backGeo, backMat);
    back.position.set(0, MACHINE.height / 2, -hd);
    scene.add(back);

    // Glass panels (front, left, right)
    const glassMat = new THREE.MeshPhysicalMaterial({
      color: 0xaaddff,
      transparent: true,
      opacity: MACHINE.glassOpacity,
      roughness: 0.05,
      metalness: 0.0,
      transmission: 0.9,
      thickness: 0.1,
      side: THREE.DoubleSide
    });

    // Front glass
    const frontGlassGeo = new THREE.BoxGeometry(MACHINE.width, MACHINE.height - 0.4, 0.04);
    const frontGlass = new THREE.Mesh(frontGlassGeo, glassMat);
    frontGlass.position.set(0, MACHINE.height / 2, hd);
    scene.add(frontGlass);

    // Side glasses
    const sideGlassGeo = new THREE.BoxGeometry(0.04, MACHINE.height - 0.4, MACHINE.depth);
    const leftGlass = new THREE.Mesh(sideGlassGeo, glassMat);
    leftGlass.position.set(-hw, MACHINE.height / 2, 0);
    scene.add(leftGlass);

    const rightGlass = new THREE.Mesh(sideGlassGeo, glassMat);
    rightGlass.position.set(hw, MACHINE.height / 2, 0);
    scene.add(rightGlass);

    // LED border strips around pit top
    buildLEDStrips(tierColor, hw, hd);

    // Prize chute on right side
    buildPrizeChute(tierColor);

    // Machine tier badge on top front
    buildTierBadge(tier, tierColor);

    // Rail at top
    buildRailSystem(tierColor);

    // Decorative base lights
    const baseLightGeo = new THREE.BoxGeometry(MACHINE.width + 0.3, 0.05, MACHINE.depth + 0.3);
    const baseLightMat = new THREE.MeshStandardMaterial({
      color: tierColor,
      emissive: tierColor,
      emissiveIntensity: 0.5
    });
    const baseLight = new THREE.Mesh(baseLightGeo, baseLightMat);
    baseLight.position.set(0, 0.11, 0);
    scene.add(baseLight);
  }

  function buildLEDStrips(color, hw, hd) {
    const ledMat = new THREE.MeshStandardMaterial({
      color: color,
      emissive: color,
      emissiveIntensity: 1.0
    });

    const stripH = 0.06;
    const stripD = 0.06;
    const y = MACHINE.pitHeight + 0.1;

    // Front strip
    const frontStripGeo = new THREE.BoxGeometry(MACHINE.width, stripH, stripD);
    const frontStrip = new THREE.Mesh(frontStripGeo, ledMat.clone());
    frontStrip.position.set(0, y, hd - 0.05);
    scene.add(frontStrip);
    ledStrips.push(frontStrip);

    // Back strip
    const backStrip = new THREE.Mesh(frontStripGeo, ledMat.clone());
    backStrip.position.set(0, y, -hd + 0.05);
    scene.add(backStrip);
    ledStrips.push(backStrip);

    // Side strips
    const sideStripGeo = new THREE.BoxGeometry(stripD, stripH, MACHINE.depth);
    const leftStrip = new THREE.Mesh(sideStripGeo, ledMat.clone());
    leftStrip.position.set(-hw + 0.05, y, 0);
    scene.add(leftStrip);
    ledStrips.push(leftStrip);

    const rightStrip = new THREE.Mesh(sideStripGeo, ledMat.clone());
    rightStrip.position.set(hw - 0.05, y, 0);
    scene.add(rightStrip);
    ledStrips.push(rightStrip);

    // Vertical LED strips on front posts
    const vertGeo = new THREE.BoxGeometry(0.04, MACHINE.height, 0.04);
    [[-hw + 0.05, MACHINE.height / 2, hd - 0.05], [hw - 0.05, MACHINE.height / 2, hd - 0.05]].forEach(p => {
      const strip = new THREE.Mesh(vertGeo, ledMat.clone());
      strip.position.set(p[0], p[1], p[2]);
      scene.add(strip);
      ledStrips.push(strip);
    });
  }

  function buildPrizeChute(color) {
    const chuteGroup = new THREE.Group();

    // Chute walls
    const chuteMat = new THREE.MeshStandardMaterial({ color: 0x2a2a3e, metalness: 0.6, roughness: 0.4 });
    const chuteInnerMat = new THREE.MeshStandardMaterial({
      color: color,
      emissive: color,
      emissiveIntensity: 0.3
    });

    // Chute box (open top, attached to right side)
    const chuteBack = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1.2, 0.06), chuteMat);
    chuteBack.position.set(MACHINE.width / 2 + 0.4, 0.6, -0.4);
    chuteGroup.add(chuteBack);

    const chuteFront = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.6, 0.06), chuteMat);
    chuteFront.position.set(MACHINE.width / 2 + 0.4, 0.3, 0.4);
    chuteGroup.add(chuteFront);

    const chuteBottom = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.06, 0.8), chuteInnerMat);
    chuteBottom.position.set(MACHINE.width / 2 + 0.4, 0.1, 0);
    chuteGroup.add(chuteBottom);

    const chuteSide = new THREE.Mesh(new THREE.BoxGeometry(0.06, 1.2, 0.8), chuteMat);
    chuteSide.position.set(MACHINE.width / 2 + 0.8, 0.6, 0);
    chuteGroup.add(chuteSide);

    // Chute opening label glow
    const labelGeo = new THREE.BoxGeometry(0.6, 0.08, 0.08);
    const labelMat = new THREE.MeshStandardMaterial({
      color: color,
      emissive: color,
      emissiveIntensity: 1.5
    });
    const label = new THREE.Mesh(labelGeo, labelMat);
    label.position.set(MACHINE.width / 2 + 0.4, 1.22, 0);
    chuteGroup.add(label);

    scene.add(chuteGroup);
  }

  function buildTierBadge(tier, color) {
    const t = TIERS[tier];

    // Badge backing plate
    const badgeGeo = new THREE.BoxGeometry(1.6, 0.5, 0.06);
    const badgeMat = new THREE.MeshStandardMaterial({
      color: 0x1a1a2e,
      metalness: 0.8,
      roughness: 0.2
    });
    const badge = new THREE.Mesh(badgeGeo, badgeMat);
    badge.position.set(0, MACHINE.height + 0.4, MACHINE.depth / 2 - 0.02);
    scene.add(badge);

    // Badge border glow
    const borderGeo = new THREE.BoxGeometry(1.7, 0.6, 0.04);
    const borderMat = new THREE.MeshStandardMaterial({
      color: color,
      emissive: color,
      emissiveIntensity: 1.0
    });
    const border = new THREE.Mesh(borderGeo, borderMat);
    border.position.set(0, MACHINE.height + 0.4, MACHINE.depth / 2 - 0.04);
    scene.add(border);

    // Point light for badge
    const badgeLight = new THREE.PointLight(color, 0.6, 3);
    badgeLight.position.set(0, MACHINE.height + 0.5, MACHINE.depth / 2 + 0.3);
    scene.add(badgeLight);
  }

  function buildRailSystem(color) {
    // Horizontal rails at top (X-axis rail)
    const railMat = new THREE.MeshStandardMaterial({ color: 0x555577, metalness: 0.9, roughness: 0.1 });

    // X-axis rail (front-back pair)
    const xRailGeo = new THREE.BoxGeometry(MACHINE.width - 0.3, 0.08, 0.08);
    const xRail1 = new THREE.Mesh(xRailGeo, railMat);
    xRail1.position.set(0, MACHINE.railY, -MACHINE.depth / 2 + 0.3);
    scene.add(xRail1);

    const xRail2 = new THREE.Mesh(xRailGeo, railMat);
    xRail2.position.set(0, MACHINE.railY, MACHINE.depth / 2 - 0.3);
    scene.add(xRail2);

    // Z-axis rail (the carriage moves along this)
    const zRailGeo = new THREE.BoxGeometry(0.08, 0.08, MACHINE.depth - 0.3);

    carriageGroup = new THREE.Group();
    carriageGroup.position.set(clawX, MACHINE.railY, clawZ);

    const zRail = new THREE.Mesh(zRailGeo, railMat);
    zRail.position.set(0, 0, 0);
    carriageGroup.add(zRail);

    // Carriage block
    const carriageGeo = new THREE.BoxGeometry(0.25, 0.15, 0.25);
    const carriageMat = new THREE.MeshStandardMaterial({
      color: color,
      emissive: color,
      emissiveIntensity: 0.3,
      metalness: 0.7,
      roughness: 0.3
    });
    const carriage = new THREE.Mesh(carriageGeo, carriageMat);
    carriage.position.set(0, -0.08, 0);
    carriageGroup.add(carriage);

    scene.add(carriageGroup);
  }

  // ‚îÄ‚îÄ‚îÄ BUILD CLAW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function buildClaw(color) {
    clawGroup = new THREE.Group();

    // Cable
    cableGroup = new THREE.Group();
    const cableGeo = new THREE.CylinderGeometry(0.015, 0.015, 1, 8);
    const cableMat = new THREE.MeshStandardMaterial({ color: 0x888888, metalness: 0.9, roughness: 0.1 });
    cableMesh = new THREE.Mesh(cableGeo, cableMat);
    cableMesh.position.set(0, -0.5, 0);
    cableGroup.add(cableMesh);
    clawGroup.add(cableGroup);

    // Claw hub (central piece)
    const hubGeo = new THREE.CylinderGeometry(0.1, 0.12, 0.15, 12);
    const hubMat = new THREE.MeshStandardMaterial({
      color: color,
      emissive: color,
      emissiveIntensity: 0.2,
      metalness: 0.8,
      roughness: 0.2
    });
    const hub = new THREE.Mesh(hubGeo, hubMat);
    hub.castShadow = true;
    clawGroup.add(hub);

    // Hub ring
    const ringGeo = new THREE.TorusGeometry(0.13, 0.02, 8, 16);
    const ringMat = new THREE.MeshStandardMaterial({ color: 0xaaaacc, metalness: 0.9, roughness: 0.1 });
    const ring = new THREE.Mesh(ringGeo, ringMat);
    ring.rotation.x = Math.PI / 2;
    ring.position.y = -0.05;
    clawGroup.add(ring);

    // 3 claw fingers
    clawFingers = [];
    for (let i = 0; i < 3; i++) {
      const fingerGroup = new THREE.Group();
      const angle = (i / 3) * Math.PI * 2;
      fingerGroup.position.set(
        Math.cos(angle) * 0.08,
        -0.1,
        Math.sin(angle) * 0.08
      );
      fingerGroup.userData.baseAngleY = angle;

      // Upper finger segment
      const upperGeo = new THREE.CylinderGeometry(0.025, 0.02, 0.25, 8);
      const fingerMat = new THREE.MeshStandardMaterial({
        color: 0xccccdd,
        metalness: 0.85,
        roughness: 0.15
      });
      const upper = new THREE.Mesh(upperGeo, fingerMat);
      upper.position.set(0, -0.12, 0);
      upper.castShadow = true;
      fingerGroup.add(upper);

      // Lower finger segment (curved tip)
      const lowerGeo = new THREE.CylinderGeometry(0.018, 0.012, 0.18, 8);
      const lowerMat = new THREE.MeshStandardMaterial({
        color: color,
        emissive: color,
        emissiveIntensity: 0.15,
        metalness: 0.7,
        roughness: 0.3
      });
      const lower = new THREE.Mesh(lowerGeo, lowerMat);
      lower.position.set(0, -0.33, 0);
      lower.castShadow = true;
      fingerGroup.add(lower);

      // Finger tip (small sphere)
      const tipGeo = new THREE.SphereGeometry(0.018, 8, 8);
      const tip = new THREE.Mesh(tipGeo, lowerMat.clone());
      tip.position.set(0, -0.42, 0);
      fingerGroup.add(tip);

      // Set initial rotation to spread fingers outward
      fingerGroup.rotation.x = MACHINE.clawOpenAngle;
      // Rotate to face outward from center
      fingerGroup.rotation.y = angle;

      clawGroup.add(fingerGroup);
      clawFingers.push(fingerGroup);
    }

    // Position claw under the carriage
    updateClawPosition();
    scene.add(clawGroup);
  }

  function updateClawPosition() {
    if (!clawGroup || !carriageGroup) return;

    carriageGroup.position.x = clawX;
    carriageGroup.position.z = clawZ;

    const clawBottom = MACHINE.railY - cableLength;
    clawGroup.position.set(clawX, clawBottom, clawZ);

    // Update cable
    if (cableMesh) {
      cableMesh.scale.y = cableLength;
      cableMesh.position.y = cableLength / 2;
      cableGroup.position.set(0, 0, 0);
    }

    clawY = clawBottom;
  }

  function updateFingerAngle(dt) {
    const diff = targetFingerAngle - fingerAngle;
    if (Math.abs(diff) > 0.001) {
      fingerAngle += diff * Math.min(1, dt * 8);
      clawFingers.forEach((fg, i) => {
        const outwardAngle = (i / 3) * Math.PI * 2;
        // Rotate finger around X axis to open/close, keeping Y rotation for direction
        fg.rotation.set(fingerAngle, outwardAngle, 0);
        // Splay outward from center
        const splay = fingerAngle * 0.4;
        fg.position.set(
          Math.cos(outwardAngle) * (0.08 + splay * 0.15),
          -0.1,
          Math.sin(outwardAngle) * (0.08 + splay * 0.15)
        );
      });
    }
  }

  // ‚îÄ‚îÄ‚îÄ PRIZES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function spawnPrizes(tier) {
    const count = 8 + Math.floor(Math.random() * 8); // 8-15
    const prizeMat = new CANNON.Material('prize');

    for (let i = 0; i < count; i++) {
      const colorHex = PRIZE_COLORS[i % PRIZE_COLORS.length];
      const col = new THREE.Color(colorHex);

      // Random shape: capsule-like (cylinder + spheres) or box
      const isBox = Math.random() > 0.5;
      let mesh, body;

      const x = (Math.random() - 0.5) * (MACHINE.width - 0.8);
      const y = 0.5 + Math.random() * 1.2;
      const z = (Math.random() - 0.5) * (MACHINE.depth - 0.8);

      if (isBox) {
        // Gift box prize
        const size = 0.18 + Math.random() * 0.12;
        const geo = new THREE.BoxGeometry(size, size, size);
        const mat = new THREE.MeshStandardMaterial({
          color: col,
          emissive: col,
          emissiveIntensity: 0.15,
          metalness: 0.3,
          roughness: 0.6
        });
        mesh = new THREE.Mesh(geo, mat);
        mesh.castShadow = true;

        // Ribbon on box
        const ribbonGeo = new THREE.BoxGeometry(size + 0.02, 0.03, size + 0.02);
        const ribbonMat = new THREE.MeshStandardMaterial({
          color: 0xffffff,
          emissive: 0xffffff,
          emissiveIntensity: 0.2,
          metalness: 0.5,
          roughness: 0.3
        });
        const ribbon = new THREE.Mesh(ribbonGeo, ribbonMat);
        ribbon.position.y = size * 0.1;
        mesh.add(ribbon);

        const ribbonV = new THREE.Mesh(
          new THREE.BoxGeometry(0.03, size + 0.02, size + 0.02),
          ribbonMat
        );
        mesh.add(ribbonV);

        body = new CANNON.Body({
          mass: 0.3,
          shape: new CANNON.Box(new CANNON.Vec3(size / 2, size / 2, size / 2)),
          material: prizeMat
        });
      } else {
        // Capsule prize (cylinder + half-spheres)
        const radius = 0.1 + Math.random() * 0.06;
        const height = 0.2 + Math.random() * 0.1;
        const capsuleGroup = new THREE.Group();

        const cylGeo = new THREE.CylinderGeometry(radius, radius, height, 12);
        const capsuleMat = new THREE.MeshStandardMaterial({
          color: col,
          emissive: col,
          emissiveIntensity: 0.15,
          metalness: 0.4,
          roughness: 0.5
        });
        const cyl = new THREE.Mesh(cylGeo, capsuleMat);
        cyl.castShadow = true;
        capsuleGroup.add(cyl);

        const sphereGeo = new THREE.SphereGeometry(radius, 12, 8);
        const topSphere = new THREE.Mesh(sphereGeo, capsuleMat);
        topSphere.position.y = height / 2;
        capsuleGroup.add(topSphere);

        const botSphere = new THREE.Mesh(sphereGeo, capsuleMat);
        botSphere.position.y = -height / 2;
        capsuleGroup.add(botSphere);

        // Star decoration
        const starGeo = new THREE.OctahedronGeometry(radius * 0.4, 0);
        const starMat = new THREE.MeshStandardMaterial({
          color: 0xffffff,
          emissive: 0xffffff,
          emissiveIntensity: 0.5
        });
        const star = new THREE.Mesh(starGeo, starMat);
        star.position.set(0, 0, radius + 0.01);
        star.scale.set(1, 1, 0.3);
        capsuleGroup.add(star);

        mesh = capsuleGroup;

        body = new CANNON.Body({
          mass: 0.25,
          material: prizeMat
        });
        body.addShape(new CANNON.Cylinder(radius, radius, height, 8));
        body.addShape(new CANNON.Sphere(radius), new CANNON.Vec3(0, height / 2, 0));
        body.addShape(new CANNON.Sphere(radius), new CANNON.Vec3(0, -height / 2, 0));
      }

      mesh.position.set(x, y, z);
      mesh.rotation.set(
        Math.random() * Math.PI,
        Math.random() * Math.PI,
        Math.random() * Math.PI
      );

      body.position.set(x, y, z);
      body.quaternion.set(
        mesh.quaternion.x,
        mesh.quaternion.y,
        mesh.quaternion.z,
        mesh.quaternion.w
      );

      // Small random angular velocity for tumbling
      body.angularVelocity.set(
        (Math.random() - 0.5) * 2,
        (Math.random() - 0.5) * 2,
        (Math.random() - 0.5) * 2
      );

      scene.add(mesh);
      world.addBody(body);
      prizeMeshes.push(mesh);
      prizeBodies.push(body);
      prizeData.push({
        name: PRIZE_NAMES[i % PRIZE_NAMES.length],
        color: colorHex,
        index: i
      });
    }
  }

  function syncPrizePhysics() {
    for (let i = 0; i < prizeBodies.length; i++) {
      const body = prizeBodies[i];
      const mesh = prizeMeshes[i];
      if (mesh && body) {
        mesh.position.copy(body.position);
        mesh.quaternion.copy(body.quaternion);
      }
    }
  }

  function findNearestPrize() {
    let nearest = -1;
    let minDist = Infinity;
    const clawPos = new THREE.Vector3(clawX, clawY - 0.4, clawZ);

    for (let i = 0; i < prizeBodies.length; i++) {
      const bpos = prizeBodies[i].position;
      const dist = clawPos.distanceTo(new THREE.Vector3(bpos.x, bpos.y, bpos.z));
      if (dist < minDist && dist < 0.5) {
        minDist = dist;
        nearest = i;
      }
    }
    return nearest;
  }

  // ‚îÄ‚îÄ‚îÄ CONFETTI PARTICLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function createConfetti() {
    if (confettiGroup) {
      scene.remove(confettiGroup);
    }
    confettiGroup = new THREE.Group();
    confettiParticles = [];

    const colors = [0xFF6B6B, 0x4ECDC4, 0xFFE66D, 0xFF8E72, 0xA8E6CF, 0xFFD700, 0xFF69B4, 0x00CED1];

    for (let i = 0; i < 120; i++) {
      const geo = new THREE.BoxGeometry(0.04, 0.04, 0.01);
      const mat = new THREE.MeshStandardMaterial({
        color: colors[i % colors.length],
        emissive: colors[i % colors.length],
        emissiveIntensity: 0.5
      });
      const particle = new THREE.Mesh(geo, mat);

      // Start at the claw position
      particle.position.set(
        clawX + (Math.random() - 0.5) * 0.5,
        clawY + (Math.random() - 0.5) * 0.5,
        clawZ + (Math.random() - 0.5) * 0.5
      );

      particle.userData.velocity = new THREE.Vector3(
        (Math.random() - 0.5) * 6,
        Math.random() * 5 + 2,
        (Math.random() - 0.5) * 6
      );
      particle.userData.rotSpeed = new THREE.Vector3(
        Math.random() * 10,
        Math.random() * 10,
        Math.random() * 10
      );
      particle.userData.life = 1.0;

      confettiGroup.add(particle);
      confettiParticles.push(particle);
    }

    scene.add(confettiGroup);
  }

  function updateConfetti(dt) {
    if (!confettiGroup || confettiParticles.length === 0) return;

    let allDead = true;
    for (let i = 0; i < confettiParticles.length; i++) {
      const p = confettiParticles[i];
      if (p.userData.life <= 0) continue;

      allDead = false;
      p.userData.velocity.y -= 6 * dt;
      p.position.addScaledVector(p.userData.velocity, dt);
      p.rotation.x += p.userData.rotSpeed.x * dt;
      p.rotation.y += p.userData.rotSpeed.y * dt;
      p.rotation.z += p.userData.rotSpeed.z * dt;
      p.userData.life -= dt * 0.5;
      p.material.opacity = Math.max(0, p.userData.life);
      p.material.transparent = true;

      if (p.userData.life <= 0) {
        p.visible = false;
      }
    }

    if (allDead) {
      scene.remove(confettiGroup);
      confettiGroup = null;
      confettiParticles = [];
    }
  }

  // ‚îÄ‚îÄ‚îÄ CAMERA SHAKE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function triggerCameraShake(intensity) {
    cameraShake.active = true;
    cameraShake.intensity = intensity;
  }

  function updateCameraShake(dt) {
    if (!cameraShake.active) return;

    if (cameraShake.intensity < 0.001) {
      cameraShake.active = false;
      camera.position.copy(cameraBasePos);
      return;
    }

    camera.position.set(
      cameraBasePos.x + (Math.random() - 0.5) * cameraShake.intensity,
      cameraBasePos.y + (Math.random() - 0.5) * cameraShake.intensity * 0.5,
      cameraBasePos.z + (Math.random() - 0.5) * cameraShake.intensity * 0.3
    );
    camera.lookAt(0, 2, 0);

    cameraShake.intensity *= cameraShake.decay;
  }

  // ‚îÄ‚îÄ‚îÄ GLOW EFFECT ON WON PRIZE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function applyGlowToPrize(index) {
    const mesh = prizeMeshes[index];
    if (!mesh) return;

    const applyGlow = (obj) => {
      if (obj.material) {
        obj.material.emissiveIntensity = 1.5;
      }
      if (obj.children) {
        obj.children.forEach(applyGlow);
      }
    };
    applyGlow(mesh);
  }

  // ‚îÄ‚îÄ‚îÄ LED ANIMATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function updateLEDs(dt) {
    ledTime += dt;
    ledStrips.forEach((strip, i) => {
      const pulse = 0.5 + 0.5 * Math.sin(ledTime * 3 + i * 1.2);
      if (strip.material) {
        strip.material.emissiveIntensity = 0.4 + pulse * 0.8;
      }
    });
  }

  // ‚îÄ‚îÄ‚îÄ INPUT HANDLING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  const keysDown = {};

  function onKeyDown(e) {
    keysDown[e.key.toLowerCase()] = true;
    keysDown[e.code] = true;

    if (e.code === 'Space' || e.key === ' ') {
      e.preventDefault();
      if (state === STATES.MOVING) {
        dropClaw();
      }
    }

    // R key: reset claw to center position
    if (e.key.toLowerCase() === 'r' && state === STATES.MOVING) {
      e.preventDefault();
      targetClawX = MACHINE.homeX;
      targetClawZ = MACHINE.homeZ;
    }

    // Q key: toggle Quick Play mode
    if (e.key.toLowerCase() === 'q') {
      e.preventDefault();
      toggleQuickPlay();
    }
  }

  function onKeyUp(e) {
    keysDown[e.key.toLowerCase()] = false;
    keysDown[e.code] = false;
  }

  function processKeyboardInput(dt) {
    if (state !== STATES.MOVING) {
      moveInput.x = 0;
      moveInput.z = 0;
      keyAccel.x = 0;
      keyAccel.z = 0;
      return;
    }

    let mx = 0, mz = 0;
    if (keysDown['a'] || keysDown['arrowleft']) mx -= 1;
    if (keysDown['d'] || keysDown['arrowright']) mx += 1;
    if (keysDown['w'] || keysDown['arrowup']) mz -= 1;
    if (keysDown['s'] || keysDown['arrowdown']) mz += 1;

    // Smooth acceleration: ramp up while key held, decelerate when released
    if (mx !== 0) {
      keyAccel.x = Math.min(KEY_ACCEL_MAX, Math.abs(keyAccel.x) + KEY_ACCEL_RATE * (dt || 0.016));
      moveInput.x = mx * keyAccel.x;
    } else {
      keyAccel.x = Math.max(0, keyAccel.x - KEY_DECEL_RATE * (dt || 0.016));
      moveInput.x = moveInput.x > 0 ? keyAccel.x : -keyAccel.x;
      if (keyAccel.x < 0.01) moveInput.x = 0;
    }

    if (mz !== 0) {
      keyAccel.z = Math.min(KEY_ACCEL_MAX, Math.abs(keyAccel.z) + KEY_ACCEL_RATE * (dt || 0.016));
      moveInput.z = mz * keyAccel.z;
    } else {
      keyAccel.z = Math.max(0, keyAccel.z - KEY_DECEL_RATE * (dt || 0.016));
      moveInput.z = moveInput.z > 0 ? keyAccel.z : -keyAccel.z;
      if (keyAccel.z < 0.01) moveInput.z = 0;
    }

    // Cancel click-to-position if keyboard is being used
    if (mx !== 0 || mz !== 0) {
      targetClawX = null;
      targetClawZ = null;
    }
  }

  // ‚îÄ‚îÄ‚îÄ CLICK-TO-POSITION & CONTROLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function screenToMachineCoords(clientX, clientY) {
    // Convert screen click to machine X/Z coordinates using raycasting
    if (!camera || !renderer || !container) return null;
    const rect = renderer.domElement.getBoundingClientRect();
    const ndcX = ((clientX - rect.left) / rect.width) * 2 - 1;
    const ndcY = -((clientY - rect.top) / rect.height) * 2 + 1;

    if (!raycaster) raycaster = new THREE.Raycaster();
    if (!raycastPlane) {
      // Invisible plane at rail height for projection
      const planeGeo = new THREE.PlaneGeometry(MACHINE.width * 2, MACHINE.depth * 2);
      const planeMat = new THREE.MeshBasicMaterial({ visible: false });
      raycastPlane = new THREE.Mesh(planeGeo, planeMat);
      raycastPlane.rotation.x = -Math.PI / 2;
      raycastPlane.position.y = MACHINE.railY;
      scene.add(raycastPlane);
    }

    raycaster.setFromCamera(new THREE.Vector2(ndcX, ndcY), camera);
    const hits = raycaster.intersectObject(raycastPlane);
    if (hits.length > 0) {
      const p = hits[0].point;
      const halfW = MACHINE.width / 2 - 0.3;
      const halfD = MACHINE.depth / 2 - 0.3;
      return {
        x: Math.max(-halfW, Math.min(halfW, p.x)),
        z: Math.max(-halfD, Math.min(halfD, p.z))
      };
    }
    return null;
  }

  function machineToScreenCoords(mx, mz) {
    // Project machine coords to screen position for crosshair overlay
    if (!camera || !renderer) return null;
    const vec = new THREE.Vector3(mx, MACHINE.railY, mz);
    vec.project(camera);
    const rect = renderer.domElement.getBoundingClientRect();
    return {
      x: ((vec.x + 1) / 2) * rect.width + rect.left,
      y: ((-vec.y + 1) / 2) * rect.height + rect.top
    };
  }

  function machineToScreenLocal(mx, mz) {
    // Same as machineToScreenCoords but relative to container
    if (!camera || !renderer) return null;
    const vec = new THREE.Vector3(mx, MACHINE.railY, mz);
    vec.project(camera);
    const w = container.clientWidth;
    const h = container.clientHeight;
    return {
      x: ((vec.x + 1) / 2) * w,
      y: ((-vec.y + 1) / 2) * h
    };
  }

  function dropShadowScreenPos(mx, mz) {
    // Project to the pit floor for the shadow
    if (!camera || !renderer) return null;
    const vec = new THREE.Vector3(mx, 0.1, mz);
    vec.project(camera);
    const w = container.clientWidth;
    const h = container.clientHeight;
    return {
      x: ((vec.x + 1) / 2) * w,
      y: ((-vec.y + 1) / 2) * h
    };
  }

  function updateCrosshairPosition() {
    if (!crosshairEl || !dropShadowEl || !positionLineEl) return;
    if (state !== STATES.MOVING) {
      crosshairEl.classList.remove('visible');
      dropShadowEl.classList.remove('visible');
      positionLineEl.classList.remove('visible');
      return;
    }
    const screenPos = machineToScreenLocal(clawX, clawZ);
    if (screenPos) {
      crosshairEl.style.left = screenPos.x + 'px';
      crosshairEl.style.top = screenPos.y + 'px';
      crosshairEl.classList.add('visible');

      positionLineEl.style.left = screenPos.x + 'px';
      positionLineEl.classList.add('visible');
    }
    const shadowPos = dropShadowScreenPos(clawX, clawZ);
    if (shadowPos) {
      dropShadowEl.style.left = shadowPos.x + 'px';
      dropShadowEl.style.top = shadowPos.y + 'px';
      dropShadowEl.classList.add('visible');
    }
  }

  function hapticFeedback(pattern) {
    // Trigger haptic on supported mobile devices
    if (navigator.vibrate) {
      try { navigator.vibrate(pattern || 15); } catch (e) { /* ignore */ }
    }
  }

  function showTutorialIfNeeded() {
    if (tutorialShown) return;
    try {
      if (localStorage.getItem('claw_tutorial_seen')) { tutorialShown = true; return; }
    } catch (e) {}
    const tut = document.getElementById('claw-tutorial');
    if (!tut) return;
    tut.style.display = 'flex';
    const dismiss = document.getElementById('claw-tutorial-dismiss');
    if (dismiss) {
      dismiss.addEventListener('click', () => {
        tut.style.display = 'none';
        tutorialShown = true;
        try { localStorage.setItem('claw_tutorial_seen', '1'); } catch (e) {}
        hapticFeedback(20);
      });
      dismiss.addEventListener('touchstart', (e) => {
        e.preventDefault();
        tut.style.display = 'none';
        tutorialShown = true;
        try { localStorage.setItem('claw_tutorial_seen', '1'); } catch (e) {}
        hapticFeedback(20);
      }, { passive: false });
    }
  }

  // ‚îÄ‚îÄ‚îÄ QUICK PLAY TOGGLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function toggleQuickPlay() {
    quickPlayEnabled = !quickPlayEnabled;
    const btn = document.getElementById('quick-play-toggle');
    if (btn) {
      btn.classList.toggle('active', quickPlayEnabled);
      btn.textContent = quickPlayEnabled ? 'Quick Play: ON' : 'Quick Play: OFF';
    }
    // Update keyboard overlay
    updateKeyboardOverlay();
  }

  // ‚îÄ‚îÄ‚îÄ MOUSE HOVER PREVIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function handleMouseMove(e) {
    if (state !== STATES.MOVING) {
      if (mouseHoverPreviewEl) mouseHoverPreviewEl.classList.remove('visible');
      return;
    }
    const coords = screenToMachineCoords(e.clientX, e.clientY);
    if (!coords || !mouseHoverPreviewEl) return;

    // Show a preview marker at the mouse hover position on the pit floor
    const shadowPos = dropShadowScreenPos(coords.x, coords.z);
    if (shadowPos) {
      mouseHoverPreviewEl.style.left = shadowPos.x + 'px';
      mouseHoverPreviewEl.style.top = shadowPos.y + 'px';
      mouseHoverPreviewEl.classList.add('visible');
    }
  }

  function handleMouseLeave() {
    if (mouseHoverPreviewEl) mouseHoverPreviewEl.classList.remove('visible');
  }

  // ‚îÄ‚îÄ‚îÄ MOUSE WHEEL ZOOM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function handleMouseWheel(e) {
    e.preventDefault();
    if (!camera) return;
    const delta = e.deltaY > 0 ? CAMERA_ZOOM_STEP : -CAMERA_ZOOM_STEP;
    cameraZoom = Math.max(CAMERA_ZOOM_MIN, Math.min(CAMERA_ZOOM_MAX, cameraZoom + delta));
    // Adjust camera FOV for zoom effect
    camera.fov = 50 * cameraZoom;
    camera.updateProjectionMatrix();
  }

  // ‚îÄ‚îÄ‚îÄ CURSOR MANAGEMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function updateCursorStyle() {
    if (!renderer || !renderer.domElement) return;
    if (state === STATES.DROPPING || state === STATES.GRABBING) {
      renderer.domElement.style.cursor = 'grabbing';
    } else if (state === STATES.MOVING) {
      renderer.domElement.style.cursor = 'crosshair';
    } else {
      renderer.domElement.style.cursor = 'default';
    }
  }

  // ‚îÄ‚îÄ‚îÄ KEYBOARD SHORTCUTS OVERLAY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function createKeyboardOverlay() {
    if (keyboardOverlayEl) return;
    const isMobile = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    if (isMobile) return; // Don't show on mobile

    keyboardOverlayEl = document.createElement('div');
    keyboardOverlayEl.id = 'keyboard-shortcuts-overlay';
    keyboardOverlayEl.innerHTML = `
      <div class="kb-shortcut"><kbd>WASD</kbd> / <kbd>Arrows</kbd> Move claw</div>
      <div class="kb-shortcut"><kbd>Space</kbd> Drop claw</div>
      <div class="kb-shortcut"><kbd>Q</kbd> Quick play toggle</div>
      <div class="kb-shortcut"><kbd>R</kbd> Reset position</div>
      <div class="kb-shortcut"><kbd>Scroll</kbd> Zoom in/out</div>
      <button class="kb-dismiss" onclick="this.parentElement.style.display='none'">&times;</button>
    `;
    if (container) container.appendChild(keyboardOverlayEl);
  }

  function showKeyboardOverlay(show) {
    if (!keyboardOverlayEl) return;
    keyboardOverlayEl.style.display = show ? 'block' : 'none';
  }

  function updateKeyboardOverlay() {
    if (!keyboardOverlayEl) return;
    const qLine = keyboardOverlayEl.querySelector('.kb-shortcut:nth-child(3)');
    if (qLine) {
      qLine.innerHTML = '<kbd>Q</kbd> Quick play: ' + (quickPlayEnabled ? 'ON' : 'OFF');
    }
  }

  // ‚îÄ‚îÄ‚îÄ VISUAL GRID LINES ON PIT FLOOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function createGridLines() {
    if (gridLinesGroup) return;
    gridLinesGroup = new THREE.Group();
    gridLinesGroup.position.y = 0.13; // Just above pit floor

    const gridMat = new THREE.LineBasicMaterial({
      color: 0x3a3a5e,
      transparent: true,
      opacity: 0.3
    });

    const halfW = MACHINE.width / 2 - 0.15;
    const halfD = MACHINE.depth / 2 - 0.15;
    const step = 0.5; // Grid spacing

    // X-direction lines
    for (let z = -halfD; z <= halfD; z += step) {
      const geo = new THREE.BufferGeometry().setFromPoints([
        new THREE.Vector3(-halfW, 0, z),
        new THREE.Vector3(halfW, 0, z)
      ]);
      gridLinesGroup.add(new THREE.Line(geo, gridMat));
    }
    // Z-direction lines
    for (let x = -halfW; x <= halfW; x += step) {
      const geo = new THREE.BufferGeometry().setFromPoints([
        new THREE.Vector3(x, 0, -halfD),
        new THREE.Vector3(x, 0, halfD)
      ]);
      gridLinesGroup.add(new THREE.Line(geo, gridMat));
    }

    scene.add(gridLinesGroup);
  }

  let autoDropPending = false;

  function handleCanvasClick(clientX, clientY) {
    if (state !== STATES.MOVING) return;
    const coords = screenToMachineCoords(clientX, clientY);
    if (!coords) return;

    // Cancel any in-progress auto-drop countdown (player re-aimed)
    cancelAutoDropCountdown();

    // Set target for smooth movement
    targetClawX = coords.x;
    targetClawZ = coords.z;
    hapticFeedback(10);

    // Mark that we want auto-drop after claw arrives
    autoDropPending = true;
  }

  let autoDropCountdownTimer = null;

  function startAutoDropCountdown() {
    if (autoDropCountdownTimer) return; // already running
    const cdEl = document.getElementById('drop-countdown');
    let count = 3;

    function showCount() {
      if (state !== STATES.MOVING) {
        if (cdEl) { cdEl.classList.remove('visible'); cdEl.style.display = 'none'; }
        autoDropCountdownTimer = null;
        return;
      }
      if (count > 0) {
        if (cdEl) {
          cdEl.textContent = count;
          cdEl.classList.remove('visible', 'fade-out');
          cdEl.style.display = 'block';
          // Force reflow for re-animation
          void cdEl.offsetWidth;
          cdEl.classList.add('visible');
        }
        count--;
        autoDropCountdownTimer = setTimeout(showCount, 500);
      } else {
        if (cdEl) { cdEl.classList.remove('visible'); cdEl.classList.add('fade-out'); }
        autoDropCountdownTimer = null;
        autoDropPending = false;
        if (state === STATES.MOVING) {
          dropClaw();
        }
      }
    }
    showCount();
  }

  function cancelAutoDropCountdown() {
    if (autoDropCountdownTimer) {
      clearTimeout(autoDropCountdownTimer);
      autoDropCountdownTimer = null;
    }
    const cdEl = document.getElementById('drop-countdown');
    if (cdEl) { cdEl.classList.remove('visible'); cdEl.style.display = 'none'; }
  }

  function processClickToPosition(dt) {
    // Smooth glide to click target
    if (state !== STATES.MOVING) {
      targetClawX = null;
      targetClawZ = null;
      autoDropPending = false;
      cancelAutoDropCountdown();
      return;
    }
    if (targetClawX === null || targetClawZ === null) return;

    // If keyboard is active, cancel click target and auto-drop
    if ((moveInput.x !== 0 || moveInput.z !== 0) && !joystick.active && targetClawX !== null) {
      targetClawX = null;
      targetClawZ = null;
      autoDropPending = false;
      cancelAutoDropCountdown();
      return;
    }

    const dx = targetClawX - clawX;
    const dz = targetClawZ - clawZ;
    const dist = Math.sqrt(dx * dx + dz * dz);

    if (dist < 0.05) {
      clawX = targetClawX;
      clawZ = targetClawZ;
      targetClawX = null;
      targetClawZ = null;
      updateClawPosition();
      // Claw arrived ‚Äî start auto-drop countdown
      if (autoDropPending) {
        startAutoDropCountdown();
      }
      return;
    }

    const step = smoothMoveSpeed * dt;
    if (step >= dist) {
      clawX = targetClawX;
      clawZ = targetClawZ;
      targetClawX = null;
      targetClawZ = null;
      updateClawPosition();
      // Claw arrived ‚Äî start auto-drop countdown
      if (autoDropPending) {
        startAutoDropCountdown();
      }
    } else {
      clawX += (dx / dist) * step;
      clawZ += (dz / dist) * step;
    }

    // Bounds
    const halfW = MACHINE.width / 2 - 0.3;
    const halfD = MACHINE.depth / 2 - 0.3;
    clawX = Math.max(-halfW, Math.min(halfW, clawX));
    clawZ = Math.max(-halfD, Math.min(halfD, clawZ));

    cableLength = MACHINE.cableMinLen;
    updateClawPosition();
  }

  function createVirtualControls() {
    // --- Click/tap to position (PRIMARY control) ---
    crosshairEl = document.getElementById('claw-crosshair');
    dropShadowEl = document.getElementById('claw-drop-shadow');
    positionLineEl = document.getElementById('claw-position-line');
    tapHintEl = document.getElementById('claw-tap-hint');

    if (renderer && renderer.domElement) {
      // Mouse click to position
      renderer.domElement.addEventListener('click', (e) => {
        handleCanvasClick(e.clientX, e.clientY);
      });

      // Mouse hover preview (desktop only)
      renderer.domElement.addEventListener('mousemove', handleMouseMove);
      renderer.domElement.addEventListener('mouseleave', handleMouseLeave);

      // Mouse wheel zoom (desktop only)
      renderer.domElement.addEventListener('wheel', handleMouseWheel, { passive: false });

      // Create hover preview element
      mouseHoverPreviewEl = document.createElement('div');
      mouseHoverPreviewEl.id = 'claw-hover-preview';
      mouseHoverPreviewEl.className = 'claw-hover-preview';
      container.appendChild(mouseHoverPreviewEl);

      // Create Quick Play toggle button (desktop only)
      const isMobile = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
      if (!isMobile) {
        const qpBtn = document.createElement('button');
        qpBtn.id = 'quick-play-toggle';
        qpBtn.className = 'quick-play-btn';
        qpBtn.textContent = 'Quick Play: OFF';
        qpBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleQuickPlay();
        });
        container.appendChild(qpBtn);
      }

      // Initial cursor style
      renderer.domElement.style.cursor = 'crosshair';

      // Unified touch handler: distinguishes taps from swipes
      let touchStartX = 0, touchStartY = 0, touchStartTime = 0, isDragging = false, touchMoved = false;
      const TAP_THRESHOLD = 12; // pixels moved before it counts as a swipe
      const SWIPE_SENSITIVITY = 0.018; // increased from 0.008 for better responsiveness

      renderer.domElement.addEventListener('touchstart', (e) => {
        if (state !== STATES.MOVING || e.touches.length !== 1) return;
        const touch = e.touches[0];
        touchStartX = touch.clientX;
        touchStartY = touch.clientY;
        touchStartTime = Date.now();
        isDragging = true;
        touchMoved = false;
      }, { passive: true });

      renderer.domElement.addEventListener('touchmove', (e) => {
        if (!isDragging || state !== STATES.MOVING || e.touches.length !== 1) return;
        const touch = e.touches[0];
        const totalDX = touch.clientX - touchStartX;
        const totalDY = touch.clientY - touchStartY;

        // Check if this is a swipe (moved past threshold)
        if (!touchMoved && Math.sqrt(totalDX * totalDX + totalDY * totalDY) > TAP_THRESHOLD) {
          touchMoved = true;
          // Cancel any pending click-to-position when user starts swiping
          targetClawX = null;
          targetClawZ = null;
          autoDropPending = false;
          cancelAutoDropCountdown();
        }

        if (touchMoved) {
          const deltaX = (touch.clientX - touchStartX) * SWIPE_SENSITIVITY;
          const deltaZ = (touch.clientY - touchStartY) * SWIPE_SENSITIVITY;
          clawX += deltaX;
          clawZ += deltaZ;
          const halfW = MACHINE.width / 2 - 0.3;
          const halfD = MACHINE.depth / 2 - 0.3;
          clawX = Math.max(-halfW, Math.min(halfW, clawX));
          clawZ = Math.max(-halfD, Math.min(halfD, clawZ));
          updateClawPosition();
          touchStartX = touch.clientX;
          touchStartY = touch.clientY;
        }
      }, { passive: true });

      renderer.domElement.addEventListener('touchend', (e) => {
        if (!isDragging) return;
        isDragging = false;
        // If it was a quick tap (not a drag), treat as click-to-position
        if (!touchMoved && (Date.now() - touchStartTime) < 300) {
          const target = e.target;
          if (target === renderer.domElement || target.closest('.play-canvas-container') === container) {
            handleCanvasClick(touchStartX, touchStartY);
            hapticFeedback(10);
          }
        }
      }, { passive: true });

      renderer.domElement.addEventListener('touchcancel', () => { isDragging = false; }, { passive: true });
    }

    // --- Joystick (secondary, mobile) ---
    const existingJoy = document.querySelector('.joystick-area');
    const existingKnob = document.querySelector('.joystick-knob');

    if (existingJoy && existingKnob) {
      existingJoy.style.touchAction = 'none';
      joystick.el = existingJoy;
      joystick.knob = existingKnob;

      existingJoy.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const rect = existingJoy.getBoundingClientRect();
        joystick.active = true;
        joystick.startX = rect.left + rect.width / 2;
        joystick.startY = rect.top + rect.height / 2;
        targetClawX = null; targetClawZ = null;
      }, { passive: false });

      existingJoy.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (!joystick.active) return;
        const touch = e.touches[0];
        const maxDist = 55; // increased from 40 for easier control
        const deadZone = 8; // ignore tiny movements to prevent drift
        let dx = touch.clientX - joystick.startX;
        let dy = touch.clientY - joystick.startY;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist > maxDist) {
          dx = (dx / dist) * maxDist;
          dy = (dy / dist) * maxDist;
        }
        // Apply dead zone ‚Äî no movement for tiny inputs
        if (dist < deadZone) {
          joystick.dx = 0;
          joystick.dy = 0;
        } else {
          // Scale from dead zone edge to max, so full range still reaches 1.0
          const scale = (dist - deadZone) / (maxDist - deadZone);
          joystick.dx = (dx / dist) * Math.min(scale, 1.0);
          joystick.dy = (dy / dist) * Math.min(scale, 1.0);
        }
        existingKnob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
      }, { passive: false });

      const endJoy = () => {
        joystick.active = false;
        joystick.dx = 0;
        joystick.dy = 0;
        existingKnob.style.transform = 'translate(-50%, -50%)';
      };
      existingJoy.addEventListener('touchend', endJoy);
      existingJoy.addEventListener('touchcancel', endJoy);
    }

    // --- Grab button ---
    const existingGrab = document.getElementById('btn-grab');
    if (existingGrab) {
      existingGrab.addEventListener('touchstart', (e) => {
        e.preventDefault();
        if (state === STATES.MOVING) {
          hapticFeedback([20, 30, 40]);
          dropClaw();
        }
      }, { passive: false });
      existingGrab.addEventListener('click', (e) => {
        e.preventDefault();
        if (state === STATES.MOVING) {
          hapticFeedback([20, 30, 40]);
          dropClaw();
        }
      });
      grabButton = existingGrab;
    }

    // Show tutorial for first-time users
    showTutorialIfNeeded();
  }

  function showMobileControls(show) {
    const isMobile = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    if (!isMobile) return;
    if (joystick.el) joystick.el.style.display = show ? 'block' : 'none';
    // Don't hide the HTML grab button, it's always visible in the HUD
  }

  function updateGrabButtonState() {
    if (!grabButton) return;
    if (state === STATES.MOVING) {
      grabButton.classList.add('ready');
    } else {
      grabButton.classList.remove('ready');
    }
  }

  function showTapHint() {
    if (!tapHintEl) tapHintEl = document.getElementById('claw-tap-hint');
    if (tapHintEl) {
      tapHintEl.classList.add('visible');
      setTimeout(() => { if (tapHintEl) tapHintEl.classList.remove('visible'); }, 3000);
    }
  }

  function processJoystickInput() {
    if (state !== STATES.MOVING || !joystick.active) return;
    moveInput.x = joystick.dx;
    moveInput.z = joystick.dy;
    targetClawX = null;
    targetClawZ = null;
  }

  // ‚îÄ‚îÄ‚îÄ TIMER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function showTimer() {
    // Use existing HUD timer element
    timerEl = document.getElementById('hud-timer');
    if (timerEl) timerEl.style.display = 'block';
  }

  function hideTimer() {
    if (timerEl) timerEl.style.opacity = '0.3';
  }

  function updateTimerDisplay() {
    if (!timerEl) timerEl = document.getElementById('hud-timer');
    if (timerEl) {
      const secs = Math.ceil(moveTimer);
      const mins = Math.floor(secs / 60);
      const s = secs % 60;
      timerEl.textContent = mins + ':' + String(s).padStart(2, '0');
      timerEl.style.opacity = '1';
      if (secs <= 5) {
        timerEl.style.color = '#ff4444';
      } else {
        timerEl.style.color = 'var(--text)';
      }
    }
  }

  // ‚îÄ‚îÄ‚îÄ STATE MACHINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function setState(newState) {
    state = newState;
  }

  async function startGame() {
    if (state !== STATES.IDLE) return false;
    if (!currentTier) return false;

    // Use 1 credit per play (consistent with ClawApp)
    if (!spendCredits(1)) return false;

    // Prepare provably fair
    if (!serverSeed) {
      await generateServerSeedInternal();
    }
    if (!clientSeed) {
      clientSeed = generateClientSeed();
    }

    // Pre-compute roll
    lastRollResult = await computeRoll(serverSeed, clientSeed, nonce);

    // Reset claw position
    clawX = MACHINE.homeX;
    clawZ = MACHINE.homeZ;
    cableLength = MACHINE.cableMinLen;
    targetFingerAngle = MACHINE.clawOpenAngle;
    updateClawPosition();

    moveTimer = MACHINE.moveTimeLimit;
    targetClawX = null;
    targetClawZ = null;
    keyAccel.x = 0;
    keyAccel.z = 0;
    setState(STATES.MOVING);
    showTimer();
    showMobileControls(true);
    showTapHint();
    updateGrabButtonState();
    showKeyboardOverlay(true);

    return true;
  }

  function dropClaw() {
    if (state !== STATES.MOVING) return;
    hapticFeedback([20, 40, 60]);
    setState(STATES.DROPPING);
    hideTimer();
    showMobileControls(false);
    targetClawX = null;
    targetClawZ = null;
    autoDropPending = false;
    cancelAutoDropCountdown();
    updateGrabButtonState();
    if (crosshairEl) crosshairEl.classList.remove('visible');
    if (dropShadowEl) dropShadowEl.classList.remove('visible');
    if (positionLineEl) positionLineEl.classList.remove('visible');
    if (tapHintEl) tapHintEl.classList.remove('visible');
    if (mouseHoverPreviewEl) mouseHoverPreviewEl.classList.remove('visible');
    showKeyboardOverlay(false);
    // Cancel any Quick Play timer
    if (quickPlayTimer) { clearTimeout(quickPlayTimer); quickPlayTimer = null; }
  }

  function updateStateMachine(dt) {
    switch (state) {
      case STATES.IDLE:
        // Gentle idle bob on claw
        cableLength = MACHINE.cableMinLen + Math.sin(Date.now() * 0.002) * 0.03;
        updateClawPosition();
        break;

      case STATES.MOVING:
        processKeyboardInput(dt);
        processJoystickInput();

        // Click-to-position smooth glide (does nothing if no target)
        processClickToPosition(dt);

        // Apply keyboard/joystick movement (only if no click target active)
        if (targetClawX === null) {
          const moveX = moveInput.x * MACHINE.moveSpeed * dt;
          const moveZ = moveInput.z * MACHINE.moveSpeed * dt;

          clawX += moveX;
          clawZ += moveZ;

          // Bounds
          const halfW = MACHINE.width / 2 - 0.3;
          const halfD = MACHINE.depth / 2 - 0.3;
          clawX = Math.max(-halfW, Math.min(halfW, clawX));
          clawZ = Math.max(-halfD, Math.min(halfD, clawZ));

          cableLength = MACHINE.cableMinLen;
          updateClawPosition();
        }

        // Update visual indicators
        updateCrosshairPosition();
        updateGrabButtonState();

        // Timer
        moveTimer -= dt;
        updateTimerDisplay();
        if (moveTimer <= 0) {
          dropClaw();
        }
        break;

      case STATES.DROPPING:
        cableLength += MACHINE.dropSpeed * dt;
        if (cableLength >= MACHINE.cableMaxLen) {
          cableLength = MACHINE.cableMaxLen;
          setState(STATES.GRABBING);
          targetFingerAngle = MACHINE.clawClosedAngle;
          triggerCameraShake(0.08);
          // Schedule transition after fingers close
          setTimeout(() => {
            if (state === STATES.GRABBING) {
              attemptGrab();
            }
          }, 600);
        }
        updateClawPosition();
        break;

      case STATES.GRABBING:
        // Fingers are closing, handled by setTimeout above
        updateClawPosition();
        break;

      case STATES.LIFTING:
        cableLength -= MACHINE.liftSpeed * dt;

        // While lifting, apply slight swing
        if (grabbedPrizeIndex >= 0) {
          const pb = prizeBodies[grabbedPrizeIndex];
          if (pb) {
            // Keep prize attached under claw
            pb.position.set(clawX, clawY - 0.5, clawZ);
            pb.velocity.set(0, 0, 0);
            pb.angularVelocity.set(0, 0, 0);
          }
        }

        if (cableLength <= MACHINE.cableMinLen) {
          cableLength = MACHINE.cableMinLen;
          setState(STATES.RETURNING);
        }
        updateClawPosition();
        break;

      case STATES.RETURNING: {
        // Move toward drop zone
        const dx = MACHINE.dropZoneX - clawX;
        const dz = MACHINE.dropZoneZ - clawZ;
        const dist = Math.sqrt(dx * dx + dz * dz);

        if (dist > 0.1) {
          const step = MACHINE.returnSpeed * dt;
          clawX += (dx / dist) * step;
          clawZ += (dz / dist) * step;
        } else {
          clawX = MACHINE.dropZoneX;
          clawZ = MACHINE.dropZoneZ;
          setState(STATES.RELEASING);
          targetFingerAngle = MACHINE.clawOpenAngle;

          setTimeout(() => {
            if (state === STATES.RELEASING) {
              resolveResult();
            }
          }, 800);
        }

        // Keep prize following
        if (grabbedPrizeIndex >= 0) {
          const pb = prizeBodies[grabbedPrizeIndex];
          if (pb) {
            pb.position.set(clawX, clawY - 0.5, clawZ);
            pb.velocity.set(0, 0, 0);
            pb.angularVelocity.set(0, 0, 0);
          }
        }

        updateClawPosition();
        break;
      }

      case STATES.RELEASING:
        // Prize dropping into chute or back into pit
        // Handled by setTimeout above
        updateClawPosition();
        break;

      case STATES.RESULT:
        // Waiting for external acknowledgment
        break;
    }
  }

  function attemptGrab() {
    const nearest = findNearestPrize();
    const won = lastRollResult < TIERS[currentTier].grip;

    if (nearest >= 0 && won) {
      grabbedPrizeIndex = nearest;

      // Create physics constraint to hold prize
      const pb = prizeBodies[nearest];
      pb.velocity.set(0, 0, 0);
      pb.angularVelocity.set(0, 0, 0);
      pb.mass = 0.05; // Lighter for lifting
      pb.updateMassProperties();

      setState(STATES.LIFTING);
    } else if (nearest >= 0 && !won) {
      // Grab then slip during lift
      grabbedPrizeIndex = nearest;
      setState(STATES.LIFTING);

      // Schedule slip
      const slipDelay = 400 + Math.random() * 800;
      setTimeout(() => {
        if (state === STATES.LIFTING && grabbedPrizeIndex >= 0) {
          // Release prize - it falls back
          const pb = prizeBodies[grabbedPrizeIndex];
          if (pb) {
            pb.mass = 0.3;
            pb.updateMassProperties();
            pb.velocity.set(
              (Math.random() - 0.5) * 1,
              -1,
              (Math.random() - 0.5) * 1
            );
          }
          grabbedPrizeIndex = -1;
          targetFingerAngle = MACHINE.clawOpenAngle;

          // Continue lifting empty claw
          // State remains LIFTING, will transition normally
        }
      }, slipDelay);
    } else {
      // No prize nearby, empty grab
      grabbedPrizeIndex = -1;
      setState(STATES.LIFTING);
    }
  }

  function resolveResult() {
    const won = grabbedPrizeIndex >= 0;
    let prize = null;

    if (won) {
      prize = prizeData[grabbedPrizeIndex];

      // Drop prize into chute area (release physics body)
      const pb = prizeBodies[grabbedPrizeIndex];
      if (pb) {
        pb.mass = 0.3;
        pb.updateMassProperties();
        pb.velocity.set(0, -2, 0);
      }

      // Win celebrations
      createConfetti();
      triggerCameraShake(0.15);
      applyGlowToPrize(grabbedPrizeIndex);

      grabbedPrizeIndex = -1;
    }

    // Increment nonce
    nonce++;

    // Store the old server seed for verification, generate new one
    const revealedSeed = serverSeed;
    generateServerSeedInternal();

    setState(STATES.RESULT);

    // Return claw home
    setTimeout(() => {
      returnClawHome();
    }, 1500);

    // Callback
    if (onResultCallback) {
      onResultCallback({
        won: won,
        prize: prize,
        roll: lastRollResult,
        grip: TIERS[currentTier].grip,
        serverSeed: revealedSeed,
        clientSeed: clientSeed,
        nonce: nonce - 1,
        serverSeedHash: serverSeedHash
      });
    }
  }

  function returnClawHome() {
    // Animate claw back to home position (non-blocking)
    const startX = clawX;
    const startZ = clawZ;
    const startTime = Date.now();
    const duration = 1200;

    function animateHome() {
      const t = Math.min(1, (Date.now() - startTime) / duration);
      const ease = t * (2 - t); // easeOutQuad
      clawX = startX + (MACHINE.homeX - startX) * ease;
      clawZ = startZ + (MACHINE.homeZ - startZ) * ease;
      updateClawPosition();

      if (t < 1) {
        requestAnimationFrame(animateHome);
      } else {
        clawX = MACHINE.homeX;
        clawZ = MACHINE.homeZ;
        updateClawPosition();
        setState(STATES.IDLE);
      }
    }
    animateHome();
  }

  // ‚îÄ‚îÄ‚îÄ RENDER LOOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function animate() {
    animationFrameId = requestAnimationFrame(animate);

    const dt = Math.min(clock.getDelta(), 0.05); // Cap delta

    // Physics step
    if (world) {
      world.step(1 / 60, dt, 3);
      syncPrizePhysics();
    }

    // State machine
    updateStateMachine(dt);

    // Finger animation
    updateFingerAngle(dt);

    // Visual effects
    updateLEDs(dt);
    updateConfetti(dt);
    updateCameraShake(dt);

    // Desktop cursor style
    updateCursorStyle();

    // Render
    renderer.render(scene, camera);
  }

  // ‚îÄ‚îÄ‚îÄ INITIALIZATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function init(containerId, tier) {
    if (!TIERS[tier]) {
      throw new Error('Invalid tier: ' + tier + '. Valid tiers: ' + Object.keys(TIERS).join(', '));
    }

    currentTier = tier;
    const t = TIERS[tier];
    const tierColor = new THREE.Color(t.color);

    // Init systems
    initScene(containerId);
    initPhysics();

    // Build world
    buildMachine(tier);
    buildClaw(tierColor);
    spawnPrizes(tier);

    // Input
    window.addEventListener('keydown', onKeyDown);
    window.addEventListener('keyup', onKeyUp);
    createVirtualControls();

    // Desktop enhancements
    createKeyboardOverlay();
    createGridLines();

    // Init provably fair
    clientSeed = generateClientSeed();
    generateServerSeedInternal();

    // Update credit display
    updateCreditDisplay();

    // Start render loop
    animate();
  }

  function destroy() {
    // Stop loop
    if (animationFrameId) {
      cancelAnimationFrame(animationFrameId);
      animationFrameId = null;
    }

    // Remove event listeners
    window.removeEventListener('keydown', onKeyDown);
    window.removeEventListener('keyup', onKeyUp);
    window.removeEventListener('resize', onResize);

    // Reset HUD state (don't remove HTML elements, they're part of the page)

    // Dispose Three.js
    if (renderer) {
      renderer.dispose();
      if (renderer.domElement && renderer.domElement.parentNode) {
        renderer.domElement.parentNode.removeChild(renderer.domElement);
      }
    }

    // Clear physics
    if (world) {
      prizeBodies.forEach(b => world.removeBody(b));
      wallBodies.forEach(b => world.removeBody(b));
      if (groundBody) world.removeBody(groundBody);
    }

    // Clear scene
    if (scene) {
      while (scene.children.length > 0) {
        const child = scene.children[0];
        scene.remove(child);
        if (child.geometry) child.geometry.dispose();
        if (child.material) {
          if (Array.isArray(child.material)) {
            child.material.forEach(m => m.dispose());
          } else {
            child.material.dispose();
          }
        }
      }
    }

    // Reset state
    scene = camera = renderer = world = container = null;
    clawGroup = carriageGroup = cableGroup = cableMesh = null;
    clawFingers = [];
    prizeMeshes = [];
    prizeBodies = [];
    prizeData = [];
    wallBodies = [];
    ledStrips = [];
    confettiParticles = [];
    confettiGroup = null;
    grabbedPrizeIndex = -1;
    state = STATES.IDLE;
    currentTier = null;
    timerEl = null;
    joystick = { active: false, el: null, knob: null, startX: 0, startY: 0, dx: 0, dy: 0 };
    grabButton = null;
    targetClawX = null;
    targetClawZ = null;
    crosshairEl = null;
    dropShadowEl = null;
    positionLineEl = null;
    tapHintEl = null;
    raycaster = null;
    if (raycastPlane && scene) { try { scene.remove(raycastPlane); } catch(e) {} }
    raycastPlane = null;
    mouseHoverPreviewEl = null;
    keyboardOverlayEl = null;
    gridLinesGroup = null;
    cameraZoom = 1.0;
    quickPlayEnabled = false;
    if (quickPlayTimer) { clearTimeout(quickPlayTimer); quickPlayTimer = null; }
    keyAccel.x = 0;
    keyAccel.z = 0;
  }

  // ‚îÄ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  window.ClawEngine = {
    init: init,
    startGame: startGame,
    play: startGame,
    moveClawX: function (delta) {
      if (state === STATES.MOVING) {
        clawX += delta;
        const halfW = MACHINE.width / 2 - 0.3;
        clawX = Math.max(-halfW, Math.min(halfW, clawX));
        updateClawPosition();
      }
    },
    moveClawZ: function (delta) {
      if (state === STATES.MOVING) {
        clawZ += delta;
        const halfD = MACHINE.depth / 2 - 0.3;
        clawZ = Math.max(-halfD, Math.min(halfD, clawZ));
        updateClawPosition();
      }
    },
    moveClawTo: function(x, z) {
      if (state === STATES.MOVING) {
        targetClawX = x;
        targetClawZ = z;
      }
    },
    dropClaw: dropClaw,
    destroy: destroy,
    setOnResult: function (callback) {
      onResultCallback = callback;
    },
    getCurrentState: function () {
      return state;
    },
    // Provably fair
    generateServerSeed: async function () {
      return await generateServerSeedInternal();
    },
    setClientSeed: function (seed) {
      clientSeed = seed;
    },
    verifyResult: async function (sSeed, cSeed, n) {
      const roll = await computeRoll(sSeed, cSeed, n);
      return {
        roll: roll,
        hex: (await hmacSha256(sSeed, cSeed + ':' + n)).substring(0, 8),
        seedHash: await sha256(sSeed)
      };
    },
    getHashedServerSeed: function () {
      return serverSeedHash;
    },
    // Credit system
    getCredits: getCredits,
    addCredits: addCredits,
    spendCredits: spendCredits,
    claimFaucet: function() {
      if (window.ClawApp && window.ClawApp.claimFaucet) return window.ClawApp.claimFaucet();
    },
    // Tier info
    getTiers: function () { return Object.assign({}, TIERS); },
    getCurrentTier: function () { return currentTier; },
    // Constants
    STATES: STATES,
    TIERS: TIERS
  };

})();

</script>
<script>
/* ============================================================
   claw.pizza ‚Äî _features.js
   All application JavaScript EXCEPT the 3D engine.
   Global namespace: window.ClawApp
   ============================================================ */

(function () {
  'use strict';

  // ‚îÄ‚îÄ Firebase Config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const FIREBASE_CONFIG = {
    projectId: 'predict-network-ec767',
    databaseURL: 'https://predict-network-ec767-default-rtdb.firebaseio.com'
  };

  const FB = (path) => `${FIREBASE_CONFIG.databaseURL}/claw-pizza/${path}.json`;

  async function fbGet(path) {
    try {
      const r = await fetch(FB(path));
      return r.ok ? await r.json() : null;
    } catch { return null; }
  }

  async function fbSet(path, data) {
    try {
      await fetch(FB(path), { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
    } catch (e) { console.warn('Firebase write failed:', e); }
  }

  async function fbPush(path, data) {
    try {
      const r = await fetch(FB(path), { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
      return r.ok ? await r.json() : null;
    } catch { return null; }
  }

  async function fbPatch(path, data) {
    try {
      await fetch(FB(path), { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
    } catch (e) { console.warn('Firebase patch failed:', e); }
  }

  async function fbDelete(path) {
    try {
      await fetch(FB(path), { method: 'DELETE' });
    } catch (e) { console.warn('Firebase delete failed:', e); }
  }

  // ‚îÄ‚îÄ Constants ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  const REF_TIERS = {
    bronze:   { min: 0,   plays: 1,  bonus: 0,    label: 'Bronze',   color: '#CD7F32' },
    silver:   { min: 5,   plays: 2,  bonus: 0.10, label: 'Silver',   color: '#C0C0C0' },
    gold:     { min: 15,  plays: 3,  bonus: 0.15, label: 'Gold',     color: '#FFD700' },
    platinum: { min: 50,  plays: 5,  bonus: 0.20, label: 'Platinum', color: '#E5E4E2' },
    diamond:  { min: 100, plays: 10, bonus: 0.25, label: 'Diamond',  color: '#B9F2FF' }
  };

  const CREDIT_PACKS = [
    { id: 'starter',  credits: 10,  price: 4.99,  bonus: 0,   label: 'Starter' },
    { id: 'popular',  credits: 25,  price: 9.99,  bonus: 20,  label: 'Popular', featured: true },
    { id: 'value',    credits: 75,  price: 24.99, bonus: 50,  label: 'Value' },
    { id: 'whale',    credits: 400, price: 99.99, bonus: 100, label: 'Whale' }
  ];

  const BTC_ADDRESS = 'bc1pkepg42ctsvsxk499qu02qqyyz88gwjchnjpsu22wmng9rhpfv3jqw2t2hm';
  const AMAZON_TAG = 'spunk01-20';
  const ADMIN_PASSWORD = 'claw2026admin';

  const MACHINES = [
    {
      id: 'claw-1', name: 'Pizza Party', tier: 'breadstick', tierLabel: 'Breadstick', tierColor: '#d4a574',
      description: 'Easy wins for beginners! Grab tasty starter prizes.',
      prizes: [
        { name: 'Pizza Keychain', value: 2, description: 'Cute pepperoni pizza keychain' },
        { name: 'Sticker Pack', value: 3, description: '10-pack of pizza-themed stickers' },
        { name: 'Pizza Socks', value: 5, description: 'Novelty pizza slice socks' },
        { name: 'Mini Plush', value: 7, description: 'Tiny pizza slice plushie' },
        { name: 'Phone Grip', value: 4, description: 'Pizza-shaped PopSocket grip' },
        { name: 'Fridge Magnet Set', value: 3, description: '4 pizza topping magnets' }
      ]
    },
    {
      id: 'claw-2', name: 'Cheese Pull', tier: 'slice', tierLabel: 'Slice', tierColor: '#f4a460',
      description: 'Mid-range prizes with cheesy goodness.',
      prizes: [
        { name: 'Pizza Blanket', value: 15, description: 'Round pizza blanket 60 inch' },
        { name: 'Pizza Cutter Set', value: 12, description: 'Premium pizza wheel + server' },
        { name: 'LED Pizza Sign', value: 18, description: 'Neon-style LED pizza sign' },
        { name: 'Pizza Oven Mitt', value: 8, description: 'Silicone pizza slice oven mitt' },
        { name: 'Pizza Board Game', value: 20, description: 'Pizza-themed party game' },
        { name: 'Pizza Hat', value: 10, description: 'Embroidered pizza dad hat' }
      ]
    },
    {
      id: 'claw-3', name: 'Deep Dish', tier: 'halfpie', tierLabel: 'Half Pie', tierColor: '#ff8c00',
      description: 'Deeper prizes, bigger thrills. Worth the dig.',
      prizes: [
        { name: 'Pizza Stone', value: 35, description: 'Ceramic baking stone 14 inch' },
        { name: 'Pizza Hoodie', value: 40, description: 'All-over print pizza hoodie' },
        { name: 'Pizza Lamp', value: 30, description: '3D printed pizza slice lamp' },
        { name: 'Portable Oven', value: 50, description: 'Mini countertop pizza oven' },
        { name: 'Pizza Pillow Set', value: 25, description: 'Set of 4 pizza slice pillows' },
        { name: 'Custom Pizza Peel', value: 45, description: 'Engraved wooden pizza peel' },
        { name: 'Pizza Making Kit', value: 35, description: 'Complete dough + sauce kit' }
      ]
    },
    {
      id: 'claw-4', name: 'Wood Fired', tier: 'fullpie', tierLabel: 'Full Pie', tierColor: '#ff4500',
      description: 'Premium prizes. The full pie experience.',
      prizes: [
        { name: 'Ooni Pizza Oven', value: 150, description: 'Ooni Koda 12 gas oven' },
        { name: 'Pizza of the Month', value: 120, description: '6-month pizza subscription' },
        { name: 'Pro Pizza Kit', value: 100, description: 'Professional pizza-making set' },
        { name: 'Pizza Party Pack', value: 80, description: '10-person party supplies set' },
        { name: 'Designer Pizza Tee', value: 65, description: 'Limited edition artist collab tee' },
        { name: 'Cast Iron Pan', value: 90, description: 'Lodge 14-inch deep dish pan' }
      ]
    },
    {
      id: 'claw-5', name: 'Supreme Dream', tier: 'supreme', tierLabel: 'Supreme', tierColor: '#ff0040',
      description: 'The ultimate claw. Supreme prizes only.',
      prizes: [
        { name: 'Breville Pizzaiolo', value: 500, description: 'Countertop pizza oven pro' },
        { name: 'Italy Pizza Trip', value: 1000, description: 'Naples pizza tour voucher' },
        { name: 'Year of Pizza', value: 600, description: '12-month premium pizza sub' },
        { name: 'PS5 Bundle', value: 550, description: 'PS5 + pizza-themed accessories' },
        { name: 'Gold Pizza Chain', value: 300, description: '14k gold pizza pendant necklace' },
        { name: 'KitchenAid Mixer', value: 400, description: 'Artisan mixer + pasta set' },
        { name: 'Custom Neon Sign', value: 250, description: 'Personalized pizza neon sign' },
        { name: 'Bitcoin Pizza', value: 750, description: '0.01 BTC loaded on hardware wallet' }
      ]
    },
    {
      id: 'claw-6', name: 'Margherita Madness', tier: 'slice', tierLabel: 'Slice', tierColor: '#f4a460',
      description: 'Classic flavors, classic prizes.',
      prizes: [
        { name: 'Pizza Puzzle 1000pc', value: 12, description: '1000 piece pizza jigsaw' },
        { name: 'Apron Set', value: 15, description: 'Pizza chef apron + hat' },
        { name: 'Cookbook', value: 18, description: 'Artisan pizza cookbook' },
        { name: 'Pizza Earrings', value: 10, description: 'Handmade polymer clay earrings' },
        { name: 'Dough Docker', value: 8, description: 'Professional dough docker tool' }
      ]
    },
    {
      id: 'claw-7', name: 'Calzone Crusher', tier: 'halfpie', tierLabel: 'Half Pie', tierColor: '#ff8c00',
      description: 'Folded prizes packed with value.',
      prizes: [
        { name: 'Ember Mug', value: 45, description: 'Temperature-controlled smart mug' },
        { name: 'Pizza Sneakers', value: 55, description: 'Custom pizza print sneakers' },
        { name: 'Vinyl Record', value: 30, description: 'Pizza-shaped novelty vinyl' },
        { name: 'Smart Scale', value: 40, description: 'Kitchen scale for perfect dough' },
        { name: 'Pizza Backpack', value: 35, description: 'Insulated pizza delivery backpack' },
        { name: 'Herb Garden Kit', value: 25, description: 'Indoor basil + oregano garden' }
      ]
    },
    {
      id: 'claw-8', name: 'Golden Crust', tier: 'fullpie', tierLabel: 'Full Pie', tierColor: '#ff4500',
      description: 'Crispy, golden, premium picks.',
      prizes: [
        { name: 'AirPods Pro', value: 180, description: 'Apple AirPods Pro 2nd gen' },
        { name: 'Pizza Steel', value: 80, description: 'Baking steel + infrared thermo' },
        { name: 'Gift Card Bundle', value: 150, description: '$150 in pizza chain gift cards' },
        { name: 'Vitamix Blender', value: 200, description: 'For the ultimate pizza sauce' },
        { name: 'Pizza Art Print', value: 100, description: 'Signed limited edition print' }
      ]
    }
  ];

  // ‚îÄ‚îÄ Streak Rewards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const STREAK_REWARDS = {
    1: 2, 2: 3, 3: 4, 4: 5, 5: 6, 6: 7, 7: 10, 8: 8, 9: 9, 10: 10,
    11: 10, 12: 10, 13: 10, 14: 20, 15: 12, 16: 12, 17: 12, 18: 12,
    19: 12, 20: 15, 21: 15, 22: 15, 23: 15, 24: 15, 25: 18, 26: 18,
    27: 18, 28: 18, 29: 18, 30: 50
  };

  function getStreakReward(day) {
    if (day >= 30) return 50;
    return STREAK_REWARDS[day] || Math.min(2 + day, 15);
  }

  // ‚îÄ‚îÄ Daily Challenges ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const DAILY_CHALLENGES_POOL = [
    { id: 'win3',  label: 'Win 3 times',             target: 3,  reward: 10, stat: 'wins' },
    { id: 'play10', label: 'Play 10 times',           target: 10, reward: 5,  stat: 'plays' },
    { id: 'play5',  label: 'Play 5 times',            target: 5,  reward: 3,  stat: 'plays' },
    { id: 'win1',   label: 'Win at least once',       target: 1,  reward: 3,  stat: 'wins' },
    { id: 'share1', label: 'Share a win on X',        target: 1,  reward: 5,  stat: 'shares' },
    { id: 'play20', label: 'Play 20 times',           target: 20, reward: 12, stat: 'plays' },
    { id: 'win5',   label: 'Win 5 times',             target: 5,  reward: 15, stat: 'wins' },
    { id: 'ref1',   label: 'Get 1 referral signup',   target: 1,  reward: 10, stat: 'referrals' }
  ];

  // ‚îÄ‚îÄ Utility Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function ls(key, fallback = null) {
    try {
      const v = localStorage.getItem(key);
      return v !== null ? JSON.parse(v) : fallback;
    } catch { return fallback; }
  }

  function lsSet(key, value) {
    try { localStorage.setItem(key, JSON.stringify(value)); } catch {}
  }

  function generateId(len = 8) {
    const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
    let id = '';
    for (let i = 0; i < len; i++) id += chars[Math.floor(Math.random() * chars.length)];
    return id;
  }

  function getUserId() {
    let id = ls('claw_user_id');
    if (!id) { id = 'player_' + generateId(8); lsSet('claw_user_id', id); }
    return id;
  }

  function getPlayerName() {
    return ls('claw_player_name') || getUserId().replace('player_', 'Player_').toUpperCase().slice(0, 14);
  }

  function dayKey() {
    return new Date().toISOString().slice(0, 10);
  }

  function timeAgo(ts) {
    const diff = Date.now() - ts;
    if (diff < 60000) return 'just now';
    if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
    if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
    return Math.floor(diff / 86400000) + 'd ago';
  }

  function $(sel) { return document.querySelector(sel); }
  function $$(sel) { return document.querySelectorAll(sel); }

  // ‚îÄ‚îÄ Toast Notifications ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  const toastQueue = [];
  let toastActive = false;

  function showToast(message, type = 'info') {
    toastQueue.push({ message, type });
    if (!toastActive) processToastQueue();
  }

  function processToastQueue() {
    if (toastQueue.length === 0) { toastActive = false; return; }
    toastActive = true;
    const { message, type } = toastQueue.shift();

    let container = $('#toast-container');
    if (!container) {
      container = document.createElement('div');
      container.id = 'toast-container';
      Object.assign(container.style, {
        position: 'fixed', bottom: '80px', left: '50%', transform: 'translateX(-50%)',
        zIndex: '10000', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '8px',
        pointerEvents: 'none'
      });
      document.body.appendChild(container);
    }

    const colors = { success: '#22c55e', error: '#ef4444', info: '#3b82f6', warning: '#f59e0b' };
    const icons = { success: '\u2713', error: '\u2717', info: '\u2139', warning: '\u26A0' };

    const toast = document.createElement('div');
    Object.assign(toast.style, {
      background: 'rgba(10,10,15,0.95)', color: '#fff', padding: '12px 20px',
      borderRadius: '12px', fontSize: '14px', fontWeight: '500',
      border: `1px solid ${colors[type] || colors.info}`, boxShadow: '0 8px 32px rgba(0,0,0,0.4)',
      transform: 'translateY(40px)', opacity: '0', transition: 'all 0.3s ease',
      pointerEvents: 'auto', maxWidth: '340px', textAlign: 'center'
    });
    toast.innerHTML = `<span style="color:${colors[type]};margin-right:8px">${icons[type] || ''}</span>${message}`;
    container.appendChild(toast);

    requestAnimationFrame(() => {
      toast.style.transform = 'translateY(0)';
      toast.style.opacity = '1';
    });

    setTimeout(() => {
      toast.style.transform = 'translateY(40px)';
      toast.style.opacity = '0';
      setTimeout(() => {
        toast.remove();
        processToastQueue();
      }, 300);
    }, 3000);
  }

  // ‚îÄ‚îÄ Sound Effects (Web Audio API) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  let audioCtx = null;
  let soundsEnabled = true;
  const soundCache = {};

  function getAudioCtx() {
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioCtx.state === 'suspended') audioCtx.resume();
    return audioCtx;
  }

  function playTone(freq, duration, type = 'sine', gainVal = 0.3, detune = 0) {
    if (!soundsEnabled) return;
    const ctx = getAudioCtx();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = type;
    osc.frequency.value = freq;
    osc.detune.value = detune;
    gain.gain.setValueAtTime(gainVal, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.start();
    osc.stop(ctx.currentTime + duration);
  }

  const SoundFX = {
    clawMove() {
      if (!soundsEnabled) return;
      const ctx = getAudioCtx();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'sawtooth';
      osc.frequency.setValueAtTime(100, ctx.currentTime);
      osc.frequency.linearRampToValueAtTime(200, ctx.currentTime + 0.15);
      gain.gain.setValueAtTime(0.1, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.2);
      osc.connect(gain); gain.connect(ctx.destination);
      osc.start(); osc.stop(ctx.currentTime + 0.2);
    },

    clawDrop() {
      if (!soundsEnabled) return;
      const ctx = getAudioCtx();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(600, ctx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(100, ctx.currentTime + 0.4);
      gain.gain.setValueAtTime(0.25, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
      osc.connect(gain); gain.connect(ctx.destination);
      osc.start(); osc.stop(ctx.currentTime + 0.5);
    },

    clawGrab() {
      if (!soundsEnabled) return;
      playTone(1200, 0.08, 'square', 0.15);
      setTimeout(() => playTone(800, 0.06, 'square', 0.1), 50);
    },

    clawLift() {
      if (!soundsEnabled) return;
      const ctx = getAudioCtx();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(200, ctx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(800, ctx.currentTime + 0.5);
      gain.gain.setValueAtTime(0.2, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.6);
      osc.connect(gain); gain.connect(ctx.destination);
      osc.start(); osc.stop(ctx.currentTime + 0.6);
    },

    win() {
      if (!soundsEnabled) return;
      const notes = [523.25, 659.25, 783.99, 1046.50, 783.99, 1046.50];
      notes.forEach((freq, i) => {
        setTimeout(() => playTone(freq, 0.25, 'sine', 0.2), i * 120);
      });
    },

    lose() {
      if (!soundsEnabled) return;
      const notes = [392, 349.23, 311.13, 261.63];
      notes.forEach((freq, i) => {
        setTimeout(() => playTone(freq, 0.35, 'sine', 0.2), i * 200);
      });
    },

    buttonClick() {
      if (!soundsEnabled) return;
      playTone(800, 0.05, 'sine', 0.1);
    },

    coinInsert() {
      if (!soundsEnabled) return;
      playTone(1800, 0.06, 'sine', 0.15);
      setTimeout(() => playTone(2400, 0.08, 'sine', 0.12), 70);
      setTimeout(() => playTone(3000, 0.1, 'sine', 0.1), 150);
    },

    notification() {
      if (!soundsEnabled) return;
      playTone(880, 0.15, 'sine', 0.15);
      setTimeout(() => playTone(1108.73, 0.2, 'sine', 0.12), 150);
    }
  };

  // ‚îÄ‚îÄ Credit System ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function getCredits() {
    const c = ls('claw_credits', null);
    if (c === null) {
      lsSet('claw_credits', 3);
      return 3;
    }
    return c;
  }

  function addCredits(n) {
    const c = getCredits() + n;
    lsSet('claw_credits', c);
    updateCreditDisplays();
    return c;
  }

  function spendCredits(n) {
    const c = getCredits();
    if (c < n) return false;
    lsSet('claw_credits', c - n);
    updateCreditDisplays();
    return true;
  }

  function updateCreditDisplays() {
    const c = getCredits();
    $$('[data-credits]').forEach(el => { el.textContent = c; });
    $$('.credit-count').forEach(el => { el.textContent = c; });
    const navCredits = $('#nav-credits');
    if (navCredits) navCredits.textContent = c;
    const hudCredits = $('#hud-credit-count');
    if (hudCredits) hudCredits.textContent = c;
    const profileCredits = $('#profile-credits');
    if (profileCredits) profileCredits.textContent = c;
  }

  // ‚îÄ‚îÄ Faucet ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function getFaucetTimeLeft() {
    const last = ls('claw_faucet_last', 0);
    const next = last + 86400000;
    return Math.max(0, next - Date.now());
  }

  function canClaimFaucet() {
    return getFaucetTimeLeft() <= 0;
  }

  function claimFaucet() {
    if (!canClaimFaucet()) {
      showToast('Faucet recharging! Come back later.', 'warning');
      return false;
    }
    addCredits(5);
    lsSet('claw_faucet_last', Date.now());
    SoundFX.coinInsert();
    showToast('Claimed 5 free credits!', 'success');
    updateFaucetDisplay();
    return true;
  }

  function updateFaucetDisplay() {
    const el = $('#faucet-timer');
    if (!el) return;
    const timeLeft = getFaucetTimeLeft();
    if (timeLeft <= 0) {
      el.innerHTML = '<button class="btn btn-glow" onclick="ClawApp.claimFaucet()">Claim 5 Free Credits</button>';
    } else {
      const h = Math.floor(timeLeft / 3600000);
      const m = Math.floor((timeLeft % 3600000) / 60000);
      const s = Math.floor((timeLeft % 60000) / 1000);
      el.innerHTML = `<span class="faucet-countdown">Next claim in ${h}h ${m}m ${s}s</span>`;
    }
  }

  // ‚îÄ‚îÄ Navigation System ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  let currentPage = 'home';

  function navigate(page) {
    const validPages = ['home', 'machines', 'play', 'prizes', 'leaderboard', 'profile', 'how', 'blog', 'admin'];
    if (!validPages.includes(page)) page = 'home';

    $$('.page').forEach(p => {
      p.style.display = 'none';
      p.classList.remove('active');
    });

    const target = $(`#page-${page}`) || $(`.page[data-page="${page}"]`);
    if (target) {
      target.style.display = 'block';
      target.classList.add('active');
    }

    $$('.nav-links a[data-page], .tab-item[data-page]').forEach(link => {
      link.classList.toggle('active', link.dataset.page === page);
    });

    window.scrollTo({ top: 0, behavior: 'smooth' });

    if (window.location.hash !== `#${page}`) {
      history.pushState({ page }, '', `#${page}`);
    }

    currentPage = page;
    SoundFX.buttonClick();

    if (page === 'machines') renderMachines();
    if (page === 'play') {
      const machineId = selectedMachineId || ls('claw_selected_machine') || 'claw-1';
      selectedMachineId = machineId;
      renderPlayPage();
      if (!engineInitialized) initClawEngine(machineId);
    }
    if (page === 'leaderboard') renderLeaderboard();
    if (page === 'profile') renderProfile();
    if (page === 'prizes') renderPrizesPage();
    if (page === 'admin') renderAdmin();
  }

  function initNavigation() {
    document.addEventListener('click', (e) => {
      const link = e.target.closest('[data-page]');
      if (link) {
        e.preventDefault();
        navigate(link.dataset.page);
      }
    });

    window.addEventListener('popstate', (e) => {
      const page = e.state?.page || window.location.hash.slice(1) || 'home';
      navigate(page);
    });

    const hash = window.location.hash.slice(1);
    if (hash) navigate(hash);
  }

  // ‚îÄ‚îÄ Referral System ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function getReferralCode() {
    let code = ls('claw_ref_code');
    if (!code) { code = generateId(8); lsSet('claw_ref_code', code); }
    return code;
  }

  function getReferralLink() {
    return `https://claw.pizza/?ref=${getReferralCode()}`;
  }

  function getReferralTier(count) {
    if (count >= 100) return REF_TIERS.diamond;
    if (count >= 50) return REF_TIERS.platinum;
    if (count >= 15) return REF_TIERS.gold;
    if (count >= 5) return REF_TIERS.silver;
    return REF_TIERS.bronze;
  }

  function getNextTier(count) {
    if (count >= 100) return null;
    if (count >= 50) return { ...REF_TIERS.diamond, tierKey: 'diamond' };
    if (count >= 15) return { ...REF_TIERS.platinum, tierKey: 'platinum' };
    if (count >= 5) return { ...REF_TIERS.gold, tierKey: 'gold' };
    return { ...REF_TIERS.silver, tierKey: 'silver' };
  }

  // ‚îÄ‚îÄ Promo Code System ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const PROMO_CODES = {
    'FREEPIZZA': { credits: 25, maxUses: 1000, label: 'Free Pizza Promo' },
    'PIZZA100': { credits: 100, maxUses: 500, label: 'Pizza 100 Launch' },
    'GRABSLICE': { credits: 50, maxUses: 500, label: 'Grab a Slice' },
    'CLAWKING': { credits: 200, maxUses: 100, label: 'Claw King VIP' },
    'SUPREME': { credits: 500, maxUses: 50, label: 'Supreme Tester' },
    'SPUNKART': { credits: 1000, maxUses: 10, label: 'SpunkArt Admin' },
    'BETAPLAY': { credits: 75, maxUses: 200, label: 'Beta Tester' },
    'LAUNCH2026': { credits: 150, maxUses: 100, label: 'Launch Day 2026' },
  };

  const VANITY_REFS = {
    'spunk': 'owner',
    'pizza': 'owner',
    'claw': 'owner',
  };

  async function checkPromoCode() {
    const params = new URLSearchParams(window.location.search);
    const code = params.get('promo');
    if (!code) return;

    const upperCode = code.toUpperCase();
    const promo = PROMO_CODES[upperCode];
    if (!promo) {
      showToast('Invalid promo code', 'error');
      return;
    }

    // Check if already redeemed
    const redeemed = ls('claw_promos_used', []);
    if (redeemed.includes(upperCode)) {
      showToast('Promo code already used!', 'warning');
      window.history.replaceState({}, '', window.location.pathname + window.location.hash);
      return;
    }

    // Check Firebase for global usage count
    const usageData = await fbGet('promos/' + upperCode);
    const useCount = usageData?.count || 0;
    if (useCount >= promo.maxUses) {
      showToast('Promo code expired - all claimed!', 'error');
      window.history.replaceState({}, '', window.location.pathname + window.location.hash);
      return;
    }

    // Redeem
    addCredits(promo.credits);
    redeemed.push(upperCode);
    lsSet('claw_promos_used', redeemed);
    await fbPatch('promos/' + upperCode, { count: useCount + 1 });

    SoundFX.win();
    showToast('\u{1F389} ' + promo.label + '! +' + promo.credits + ' credits!', 'success');
    window.history.replaceState({}, '', window.location.pathname + window.location.hash);
  }

  // Handle vanity referral codes
  async function checkVanityRef() {
    const params = new URLSearchParams(window.location.search);
    const refCode = params.get('ref');
    if (!refCode) return;

    // Check if it's a vanity code
    const vanity = VANITY_REFS[refCode.toLowerCase()];
    if (vanity === 'owner') {
      const alreadyReferred = ls('claw_referred_by');
      if (alreadyReferred) return;

      lsSet('claw_referred_by', 'spunk-owner');
      addCredits(5); // Bonus for coming from owner's link
      SoundFX.win();
      showToast('Welcome from SpunkArt! +5 bonus credits!', 'success');

      // Track in Firebase
      const userId = getUserId();
      await fbSet('referrals/spunk-owner/' + userId, { joined: Date.now(), userId, source: refCode });

      window.history.replaceState({}, '', window.location.pathname + window.location.hash);
    }
  }

  function redeemPromo(code) {
    if (!code) return;
    const upperCode = code.toUpperCase().trim();
    const promo = PROMO_CODES[upperCode];
    if (!promo) {
      showToast('Invalid promo code!', 'error');
      return;
    }

    const redeemed = ls('claw_promos_used', []);
    if (redeemed.includes(upperCode)) {
      showToast('Already redeemed!', 'warning');
      return;
    }

    addCredits(promo.credits);
    redeemed.push(upperCode);
    lsSet('claw_promos_used', redeemed);
    fbPatch('promos/' + upperCode, { count: (ls('promo_' + upperCode + '_count', 0)) + 1 });

    SoundFX.win();
    showToast(promo.label + '! +' + promo.credits + ' credits!', 'success');
    updateCreditDisplays();
  }

  function promptPromoCode() {
    const code = prompt('Enter promo code:');
    if (code) redeemPromo(code);
  }

  async function checkReferralParam() {
    const params = new URLSearchParams(window.location.search);
    const refCode = params.get('ref');
    if (!refCode || refCode === getReferralCode()) return;

    const alreadyReferred = ls('claw_referred_by');
    if (alreadyReferred) return;

    lsSet('claw_referred_by', refCode);
    const userId = getUserId();
    await fbSet(`referrals/${refCode}/${userId}`, { joined: Date.now(), userId });

    addCredits(2);
    showToast('Welcome! You got 2 bonus credits from a friend!', 'success');

    window.history.replaceState({}, '', window.location.pathname + window.location.hash);
  }

  async function getReferralCount() {
    const code = getReferralCode();
    const data = await fbGet(`referrals/${code}`);
    return data ? Object.keys(data).length : 0;
  }

  function copyReferralLink() {
    const link = getReferralLink();
    navigator.clipboard.writeText(link).then(() => {
      showToast('Referral link copied!', 'success');
      SoundFX.notification();
    }).catch(() => {
      showToast(link, 'info');
    });
  }

  async function renderReferralStats(container) {
    if (!container) return;
    const count = await getReferralCount();
    const tier = getReferralTier(count);
    const nextTier = getNextTier(count);

    let progressHTML = '';
    if (nextTier) {
      const prevMin = tier.min;
      const pct = Math.min(100, ((count - prevMin) / (nextTier.min - prevMin)) * 100);
      progressHTML = `
        <div class="ref-progress">
          <div class="ref-progress-bar" style="width:${pct}%;background:${nextTier.color}"></div>
        </div>
        <p class="ref-progress-text">${count}/${nextTier.min} to ${nextTier.label}</p>
      `;
    } else {
      progressHTML = '<p class="ref-max-tier">Max tier reached!</p>';
    }

    container.innerHTML = `
      <div class="referral-card">
        <h3>Your Referral Link</h3>
        <div class="ref-link-box">
          <input type="text" readonly value="${getReferralLink()}" class="ref-link-input" />
          <button class="btn btn-sm" onclick="ClawApp.copyReferralLink()">Copy</button>
        </div>
        <div class="ref-tier" style="color:${tier.color}">
          <span class="ref-tier-icon">${tier.label === 'Diamond' ? '\u2666' : tier.label === 'Gold' ? '\u2605' : '\u25CF'}</span>
          <span>${tier.label} Tier</span>
        </div>
        <p class="ref-count">${count} referral${count !== 1 ? 's' : ''}</p>
        ${progressHTML}
        <div class="ref-perks">
          <span>Free plays/day: ${tier.plays}</span>
          ${tier.bonus > 0 ? `<span>Win bonus: +${(tier.bonus * 100).toFixed(0)}%</span>` : ''}
        </div>
      </div>
    `;
  }

  // ‚îÄ‚îÄ Daily Streak System ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function getStreakData() {
    return ls('claw_streak', { count: 0, lastDate: null, claimed: false, history: [] });
  }

  function updateStreak() {
    const data = getStreakData();
    const today = dayKey();

    if (data.lastDate === today) return data;

    const yesterday = new Date(Date.now() - 86400000).toISOString().slice(0, 10);

    if (data.lastDate === yesterday) {
      data.count += 1;
    } else if (data.lastDate !== today) {
      data.count = 1;
    }

    data.lastDate = today;
    data.claimed = false;
    if (!data.history.includes(today)) data.history.push(today);
    if (data.history.length > 30) data.history = data.history.slice(-30);

    lsSet('claw_streak', data);
    return data;
  }

  function claimStreak() {
    const data = getStreakData();
    if (data.claimed) {
      showToast('Already claimed today!', 'warning');
      return;
    }

    updateStreak();
    const updated = getStreakData();
    const reward = getStreakReward(updated.count);
    addCredits(reward);
    updated.claimed = true;
    lsSet('claw_streak', updated);
    SoundFX.win();
    showToast(`Day ${updated.count} streak! +${reward} credits!`, 'success');
    renderStreakDisplay();
  }

  function renderStreakDisplay() {
    const container = $('#streak-display');
    if (!container) return;
    const data = getStreakData();
    const today = dayKey();

    let calendarHTML = '<div class="streak-calendar">';
    for (let i = 29; i >= 0; i--) {
      const d = new Date(Date.now() - i * 86400000).toISOString().slice(0, 10);
      const active = data.history?.includes(d);
      const isToday = d === today;
      calendarHTML += `<div class="streak-dot ${active ? 'active' : ''} ${isToday ? 'today' : ''}" title="${d}"></div>`;
    }
    calendarHTML += '</div>';

    const reward = getStreakReward(data.count + (data.claimed ? 0 : 1));

    container.innerHTML = `
      <div class="streak-card">
        <h3>Daily Streak</h3>
        <div class="streak-count">${data.count} day${data.count !== 1 ? 's' : ''}</div>
        ${calendarHTML}
        ${data.claimed
          ? `<div class="streak-claimed">Claimed today! +${getStreakReward(data.count)} credits</div>`
          : `<button class="btn btn-glow" onclick="ClawApp.claimStreak()">Claim ${reward} Credits</button>`
        }
      </div>
    `;
  }

  // ‚îÄ‚îÄ Challenges System ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function getDailyChallenges() {
    const saved = ls('claw_challenges');
    const today = dayKey();
    if (saved && saved.date === today) return saved;

    const shuffled = [...DAILY_CHALLENGES_POOL].sort(() => Math.random() - 0.5);
    const selected = shuffled.slice(0, 3);
    const challenges = {
      date: today,
      items: selected.map(c => ({ ...c, progress: 0, claimed: false }))
    };
    lsSet('claw_challenges', challenges);
    return challenges;
  }

  function updateChallengeProgress(stat, amount = 1) {
    const challenges = getDailyChallenges();
    let updated = false;
    challenges.items.forEach(c => {
      if (c.stat === stat && !c.claimed) {
        c.progress = Math.min(c.target, c.progress + amount);
        updated = true;
      }
    });
    if (updated) lsSet('claw_challenges', challenges);
  }

  function claimChallenge(index) {
    const challenges = getDailyChallenges();
    const c = challenges.items[index];
    if (!c || c.claimed || c.progress < c.target) return;
    c.claimed = true;
    lsSet('claw_challenges', challenges);
    addCredits(c.reward);
    SoundFX.win();
    showToast(`Challenge complete! +${c.reward} credits`, 'success');
    renderChallenges();
  }

  function renderChallenges() {
    const container = $('#challenges-display');
    if (!container) return;
    const challenges = getDailyChallenges();

    container.innerHTML = `
      <div class="challenges-card">
        <h3>Daily Challenges</h3>
        ${challenges.items.map((c, i) => {
          const pct = Math.min(100, (c.progress / c.target) * 100);
          const done = c.progress >= c.target;
          return `
            <div class="challenge-item ${c.claimed ? 'claimed' : ''}">
              <div class="challenge-info">
                <span class="challenge-label">${c.label}</span>
                <span class="challenge-reward">+${c.reward} credits</span>
              </div>
              <div class="challenge-progress-bar">
                <div class="challenge-fill" style="width:${pct}%"></div>
              </div>
              <div class="challenge-status">
                ${c.claimed ? '<span class="text-success">Claimed!</span>'
                  : done ? `<button class="btn btn-sm btn-glow" onclick="ClawApp.claimChallenge(${i})">Claim</button>`
                  : `<span>${c.progress}/${c.target}</span>`}
              </div>
            </div>
          `;
        }).join('')}
      </div>
    `;
  }

  // ‚îÄ‚îÄ Share-to-Earn (Win Card Generator) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function generateWinCard(prizeName, prizeValue, machineTier) {
    const canvas = document.createElement('canvas');
    canvas.width = 1200;
    canvas.height = 628;
    const ctx = canvas.getContext('2d');

    // Background gradient
    const grad = ctx.createLinearGradient(0, 0, 0, 628);
    grad.addColorStop(0, '#0a0a0f');
    grad.addColorStop(1, '#1a1a2e');
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, 1200, 628);

    // Decorative circles (pizza/claw themed)
    ctx.globalAlpha = 0.05;
    for (let i = 0; i < 8; i++) {
      ctx.beginPath();
      ctx.arc(Math.random() * 1200, Math.random() * 628, 50 + Math.random() * 100, 0, Math.PI * 2);
      ctx.fillStyle = i % 2 === 0 ? '#FFD700' : '#ff4500';
      ctx.fill();
    }
    ctx.globalAlpha = 1;

    // Top border glow
    const topGrad = ctx.createLinearGradient(0, 0, 1200, 0);
    topGrad.addColorStop(0, '#ff4500');
    topGrad.addColorStop(0.5, '#FFD700');
    topGrad.addColorStop(1, '#ff4500');
    ctx.fillStyle = topGrad;
    ctx.fillRect(0, 0, 1200, 4);

    // Logo text
    ctx.font = 'bold 36px system-ui, -apple-system, sans-serif';
    ctx.fillStyle = '#FFD700';
    ctx.textAlign = 'left';
    ctx.fillText('claw.pizza', 40, 55);

    // Pizza emoji decoration
    ctx.font = '48px serif';
    ctx.fillText('\uD83C\uDF55', 1100, 60);

    // Tier badge
    ctx.font = 'bold 18px system-ui, sans-serif';
    const tierColors = { breadstick: '#d4a574', slice: '#f4a460', halfpie: '#ff8c00', fullpie: '#ff4500', supreme: '#ff0040' };
    ctx.fillStyle = tierColors[machineTier] || '#FFD700';
    ctx.fillText((machineTier || 'classic').toUpperCase() + ' MACHINE', 40, 100);

    // "WINNER" label
    ctx.font = 'bold 28px system-ui, sans-serif';
    ctx.fillStyle = '#22c55e';
    ctx.textAlign = 'center';
    ctx.fillText('W I N N E R', 600, 180);

    // Decorative line
    ctx.strokeStyle = 'rgba(255,215,0,0.3)';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(200, 200);
    ctx.lineTo(1000, 200);
    ctx.stroke();

    // Prize name
    ctx.font = 'bold 56px system-ui, -apple-system, sans-serif';
    ctx.fillStyle = '#FFD700';
    ctx.textAlign = 'center';
    ctx.fillText(prizeName, 600, 290);

    // Prize value
    ctx.font = 'bold 42px system-ui, sans-serif';
    ctx.fillStyle = '#22c55e';
    ctx.fillText(`$${prizeValue} Value`, 600, 360);

    // Claw decoration
    ctx.font = '80px serif';
    ctx.fillText('\uD83E\uDEA4', 600, 450);

    // Decorative line
    ctx.strokeStyle = 'rgba(255,215,0,0.3)';
    ctx.beginPath();
    ctx.moveTo(200, 480);
    ctx.lineTo(1000, 480);
    ctx.stroke();

    // Tagline
    ctx.font = 'bold 32px system-ui, sans-serif';
    ctx.fillStyle = '#fff';
    ctx.fillText('Grab Your Slice!', 600, 530);

    // Referral link
    ctx.font = '20px system-ui, sans-serif';
    ctx.fillStyle = 'rgba(255,255,255,0.6)';
    ctx.fillText(getReferralLink(), 600, 575);

    // Bottom border
    ctx.fillStyle = topGrad;
    ctx.fillRect(0, 624, 1200, 4);

    return canvas;
  }

  function shareWin(prizeName, prizeValue, machineTier) {
    const canvas = generateWinCard(prizeName, prizeValue || 0, machineTier || 'classic');

    canvas.toBlob((blob) => {
      if (blob) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `claw-pizza-win-${Date.now()}.png`;
        a.click();
        setTimeout(() => URL.revokeObjectURL(url), 5000);
      }
    }, 'image/png');

    const refCode = getReferralCode();
    const siteURL = 'https://spunkeroo.github.io/claw-pizza/?ref=' + refCode;
    const tweetText = encodeURIComponent(
      `Just grabbed ${prizeName} from the ${machineTier || 'classic'} machine on CLAW.PIZZA! \uD83C\uDF55\uD83C\uDFAF\n\nFree online claw machine with virtual prizes. Play free \u2192\n\n@SpunkArt13 #ClawPizza #GrabYourSlice #WinPrizes #FreePrizes`
    );
    const tweetURL = `https://twitter.com/intent/tweet?text=${tweetText}&url=${encodeURIComponent(siteURL)}`;
    window.open(tweetURL, '_blank', 'width=600,height=400');

    const shared = ls('claw_shares_today', { date: dayKey(), count: 0 });
    if (shared.date !== dayKey()) { shared.date = dayKey(); shared.count = 0; }
    if (shared.count < 3) {
      addCredits(2);
      showToast('+2 credits for sharing!', 'success');
      shared.count++;
    }
    lsSet('claw_shares_today', shared);

    updateChallengeProgress('shares', 1);
    SoundFX.notification();
  }

  // ‚îÄ‚îÄ Live Activity Feed ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  const DEMO_PRIZES = [
    'Pizza Keychain', 'Sticker Pack', 'Pizza Socks', 'Pizza Blanket', 'LED Pizza Sign',
    'Pizza Stone', 'Pizza Hoodie', 'Ooni Pizza Oven', 'Pizza Cutter Set', 'Mini Plush',
    'Phone Grip', 'Pizza Board Game', 'Portable Oven', 'AirPods Pro', 'Breville Pizzaiolo'
  ];

  const DEMO_TIERS = ['breadstick', 'slice', 'halfpie', 'fullpie', 'supreme'];

  async function seedDemoFeed() {
    const existing = await fbGet('wins');
    if (existing && Object.keys(existing).length > 0) return;

    const entries = [];
    for (let i = 0; i < 20; i++) {
      entries.push({
        player: 'Player_' + generateId(4).toUpperCase(),
        prize: DEMO_PRIZES[Math.floor(Math.random() * DEMO_PRIZES.length)],
        value: Math.floor(Math.random() * 200) + 2,
        tier: DEMO_TIERS[Math.floor(Math.random() * DEMO_TIERS.length)],
        time: Date.now() - Math.floor(Math.random() * 3600000)
      });
    }
    for (const entry of entries) {
      await fbPush('wins', entry);
    }
  }

  async function fetchLiveFeed() {
    const data = await fbGet('wins');
    if (!data) return [];
    return Object.values(data)
      .sort((a, b) => b.time - a.time)
      .slice(0, 30);
  }

  function renderLiveFeed(entries) {
    const container = $('#live-feed-list');
    if (!container) return;

    if (!entries || entries.length === 0) {
      container.innerHTML = '<div class="feed-empty">No wins yet... be the first!</div>';
      return;
    }

    const html = entries.slice(0, 10).map(e => `
      <div class="feed-item">
        <span class="feed-player">${e.player}</span>
        <span class="feed-action">grabbed</span>
        <span class="feed-prize">${e.prize}</span>
        <span class="feed-value">$${e.value}</span>
        <span class="feed-time">${timeAgo(e.time)}</span>
      </div>
    `).join('');

    container.innerHTML = html;
  }

  let feedInterval = null;
  async function startLiveFeed() {
    await seedDemoFeed();
    const entries = await fetchLiveFeed();
    renderLiveFeed(entries);

    feedInterval = setInterval(async () => {
      const entries = await fetchLiveFeed();
      renderLiveFeed(entries);
    }, 10000);
  }

  // ‚îÄ‚îÄ Record a Win ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  async function recordWin(prizeName, prizeValue, machineTier) {
    const entry = {
      player: getPlayerName(),
      prize: prizeName,
      value: prizeValue,
      tier: machineTier,
      time: Date.now()
    };
    await fbPush('wins', entry);

    // Update play history
    const history = ls('claw_play_history', []);
    history.unshift({ ...entry, result: 'win' });
    if (history.length > 50) history.length = 50;
    lsSet('claw_play_history', history);

    // Update leaderboard
    await updateLeaderboard('win', prizeValue);

    updateChallengeProgress('wins', 1);
  }

  async function recordPlay(machineTier) {
    const history = ls('claw_play_history', []);
    history.unshift({ player: getPlayerName(), result: 'miss', tier: machineTier, time: Date.now() });
    if (history.length > 50) history.length = 50;
    lsSet('claw_play_history', history);

    // Track plays count
    const stats = ls('claw_stats', { plays: 0, wins: 0, biggestWin: 0 });
    stats.plays++;
    lsSet('claw_stats', stats);

    await updateLeaderboard('play', 0);
    updateChallengeProgress('plays', 1);
    checkInterstitial();
  }

  // ‚îÄ‚îÄ Waitlist / Email Capture ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  async function submitWaitlist(email) {
    if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      showToast('Please enter a valid email.', 'error');
      return;
    }
    const safeKey = email.replace(/[.#$\[\]]/g, '_');
    await fbSet(`waitlist/${safeKey}`, { email, joined: Date.now() });
    showToast('You\'re on the list!', 'success');
    SoundFX.notification();
    updateWaitlistCount();
  }

  async function updateWaitlistCount() {
    const data = await fbGet('waitlist');
    const count = data ? Object.keys(data).length : 0;
    $$('[data-waitlist-count]').forEach(el => {
      el.textContent = count.toLocaleString();
    });
  }

  // ‚îÄ‚îÄ Credit Pack UI / Revenue ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function openBuyCreditsModal() {
    let modal = $('#buy-credits-modal');
    if (modal) { modal.style.display = 'flex'; return; }

    modal = document.createElement('div');
    modal.id = 'buy-credits-modal';
    Object.assign(modal.style, {
      position: 'fixed', top: '0', left: '0', width: '100%', height: '100%',
      background: 'rgba(0,0,0,0.85)', display: 'flex', alignItems: 'center',
      justifyContent: 'center', zIndex: '9999', padding: '20px', boxSizing: 'border-box'
    });

    const packsHTML = CREDIT_PACKS.map(p => `
      <div class="credit-pack ${p.featured ? 'featured' : ''}" onclick="ClawApp._selectPack('${p.id}')">
        ${p.featured ? '<div class="pack-badge">Most Popular</div>' : ''}
        <div class="pack-label">${p.label}</div>
        <div class="pack-credits">${p.credits} Credits</div>
        ${p.bonus > 0 ? `<div class="pack-bonus">+${p.bonus}% bonus</div>` : ''}
        <div class="pack-price">$${p.price.toFixed(2)}</div>
      </div>
    `).join('');

    modal.innerHTML = `
      <div class="modal-content" style="background:#12121a;border-radius:16px;padding:30px;max-width:600px;width:100%;max-height:90vh;overflow-y:auto;position:relative;border:1px solid rgba(255,215,0,0.2)">
        <button onclick="document.getElementById('buy-credits-modal').style.display='none'" style="position:absolute;top:12px;right:16px;background:none;border:none;color:#fff;font-size:24px;cursor:pointer">&times;</button>
        <h2 style="color:#FFD700;margin:0 0 20px;text-align:center">Buy Credits</h2>
        <div class="credit-packs-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:12px;margin-bottom:20px">
          ${packsHTML}
        </div>
        <div id="pack-checkout" style="display:none">
          <h3 style="color:#fff;margin-bottom:12px">Payment</h3>
          <div style="display:flex;gap:10px;margin-bottom:15px">
            <button class="btn" onclick="ClawApp._showCardForm()" style="flex:1">Card</button>
            <button class="btn" onclick="ClawApp._showBTCPay()" style="flex:1">Bitcoin</button>
          </div>
          <div id="payment-form-area"></div>
        </div>
        <div style="margin-top:20px;padding-top:15px;border-top:1px solid rgba(255,255,255,0.1)">
          <h3 style="color:#E5E4E2;margin-bottom:8px">VIP Membership</h3>
          <div style="background:rgba(255,215,0,0.05);border:1px solid rgba(255,215,0,0.2);border-radius:12px;padding:16px;text-align:center">
            <div style="color:#FFD700;font-size:20px;font-weight:bold">$9.99/mo</div>
            <div style="color:rgba(255,255,255,0.7);font-size:13px;margin:8px 0">50 credits/mo + VIP badge + priority support</div>
            <button class="btn btn-glow" onclick="ClawApp._mockSubscribe()" style="width:100%">Subscribe VIP</button>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }

  let selectedPack = null;

  function _selectPack(packId) {
    selectedPack = CREDIT_PACKS.find(p => p.id === packId);
    const checkout = $('#pack-checkout');
    if (checkout) checkout.style.display = 'block';
    $('#payment-form-area').innerHTML = '';
    SoundFX.buttonClick();
  }

  function _showCardForm() {
    if (!selectedPack) return;
    $('#payment-form-area').innerHTML = `
      <div style="background:rgba(255,255,255,0.05);padding:16px;border-radius:12px">
        <input type="text" placeholder="Card Number" maxlength="19" style="width:100%;padding:10px;margin-bottom:8px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:#fff;box-sizing:border-box" />
        <div style="display:flex;gap:8px">
          <input type="text" placeholder="MM/YY" maxlength="5" style="flex:1;padding:10px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:#fff" />
          <input type="text" placeholder="CVC" maxlength="4" style="flex:1;padding:10px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:#fff" />
        </div>
        <button class="btn btn-glow" onclick="ClawApp._processCardPayment()" style="width:100%;margin-top:12px">Pay $${selectedPack.price.toFixed(2)}</button>
      </div>
    `;
  }

  function _showBTCPay() {
    if (!selectedPack) return;
    const satoshi = Math.round(selectedPack.price * 1500);
    $('#payment-form-area').innerHTML = `
      <div style="background:rgba(255,255,255,0.05);padding:16px;border-radius:12px;text-align:center">
        <p style="color:rgba(255,255,255,0.7);font-size:13px;margin:0 0 8px">Send BTC to:</p>
        <div style="word-break:break-all;font-family:monospace;font-size:12px;color:#f7931a;background:rgba(0,0,0,0.3);padding:12px;border-radius:8px;margin-bottom:10px;user-select:all">${BTC_ADDRESS}</div>
        <p style="color:rgba(255,255,255,0.5);font-size:12px;margin:0 0 10px">~${satoshi.toLocaleString()} sats ($${selectedPack.price.toFixed(2)})</p>
        <button class="btn" onclick="navigator.clipboard.writeText('${BTC_ADDRESS}');ClawApp._toast('Address copied!','success')" style="width:100%">Copy Address</button>
        <p style="color:rgba(255,255,255,0.4);font-size:11px;margin-top:10px">Credits will be added after 1 confirmation</p>
      </div>
    `;
  }

  function _processCardPayment() {
    if (!selectedPack) return;
    const area = $('#payment-form-area');
    area.innerHTML = '<div style="text-align:center;padding:20px;color:#FFD700">Processing payment...</div>';

    setTimeout(() => {
      const totalCredits = selectedPack.credits + Math.round(selectedPack.credits * (selectedPack.bonus / 100));
      addCredits(totalCredits);

      const purchases = ls('claw_purchases', []);
      purchases.unshift({
        pack: selectedPack.label,
        credits: totalCredits,
        price: selectedPack.price,
        time: Date.now()
      });
      lsSet('claw_purchases', purchases);

      area.innerHTML = `<div style="text-align:center;padding:20px;color:#22c55e;font-size:18px">Payment successful! +${totalCredits} credits added!</div>`;
      SoundFX.win();
      showToast(`+${totalCredits} credits added!`, 'success');
      selectedPack = null;
    }, 2000);
  }

  function _mockSubscribe() {
    showToast('VIP subscription coming soon!', 'info');
  }

  // ‚îÄ‚îÄ Ad Integration ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  let playsSinceAd = ls('claw_plays_since_ad', 0);

  function checkInterstitial() {
    playsSinceAd++;
    lsSet('claw_plays_since_ad', playsSinceAd);
    if (playsSinceAd >= 5) {
      playsSinceAd = 0;
      lsSet('claw_plays_since_ad', 0);
      showInterstitial();
    }
  }

  function showInterstitial() {
    let overlay = document.getElementById('interstitial-overlay');
    if (overlay) overlay.remove();

    const products = [
      {name: 'Mini Claw Machine', url: 'https://www.amazon.com/s?k=mini+claw+machine&tag=spunkart-20', price: '$25-40'},
      {name: 'Squishmallows Plush', url: 'https://www.amazon.com/s?k=squishmallows&tag=spunkart-20', price: '$15-30'},
      {name: 'Jellycat Stuffed Animals', url: 'https://www.amazon.com/s?k=jellycat+plush&tag=spunkart-20', price: '$20-35'},
      {name: 'Arcade Prize Bundle', url: 'https://www.amazon.com/s?k=arcade+prizes+bulk&tag=spunkart-20', price: '$15-25'},
      {name: 'Claw Machine for Kids', url: 'https://www.amazon.com/s?k=claw+machine+kids&tag=spunkart-20', price: '$30-50'}
    ];
    const p = products[Math.floor(Math.random() * products.length)];

    overlay = document.createElement('div');
    overlay.id = 'interstitial-overlay';
    Object.assign(overlay.style, {
      position:'fixed',top:'0',left:'0',width:'100%',height:'100%',
      background:'rgba(0,0,0,0.9)',display:'flex',flexDirection:'column',
      alignItems:'center',justifyContent:'center',zIndex:'10001'
    });
    overlay.innerHTML = `<div style="text-align:center;max-width:320px">
      <div style="color:rgba(255,255,255,0.5);font-size:11px;margin-bottom:12px">RECOMMENDED</div>
      <div style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:16px;padding:24px;margin-bottom:16px">
        <div style="font-size:40px;margin-bottom:12px">&#127919;</div>
        <div style="color:#FFD700;font-size:18px;font-weight:bold;margin-bottom:8px">${p.name}</div>
        <div style="color:rgba(255,255,255,0.7);font-size:14px;margin-bottom:16px">Starting at ${p.price}</div>
        <a href="${p.url}" target="_blank" rel="noopener" style="display:inline-block;background:#f59e0b;color:#000;padding:10px 24px;border-radius:8px;font-weight:bold;text-decoration:none">Shop on Amazon</a>
      </div>
      <button onclick="document.getElementById('interstitial-overlay').remove()" style="background:transparent;border:1px solid rgba(255,255,255,0.3);color:rgba(255,255,255,0.6);padding:8px 20px;border-radius:8px;cursor:pointer;font-size:13px">Continue Playing</button>
    </div>`;
    document.body.appendChild(overlay);
  }

  function showRewardedAd() {
    let overlay = document.getElementById('rewarded-ad-overlay');
    if (overlay) overlay.remove();

    const products = [
      {name: 'Mini Claw Machine', url: 'https://www.amazon.com/s?k=mini+claw+machine&tag=spunkart-20', price: '$25-40', emoji: '&#127919;'},
      {name: 'Squishmallows Plush', url: 'https://www.amazon.com/s?k=squishmallows&tag=spunkart-20', price: '$15-30', emoji: '&#129528;'},
      {name: 'Jellycat Stuffed Animals', url: 'https://www.amazon.com/s?k=jellycat+plush&tag=spunkart-20', price: '$20-35', emoji: '&#128049;'},
      {name: 'Arcade Prize Bundle', url: 'https://www.amazon.com/s?k=arcade+prizes+bulk&tag=spunkart-20', price: '$15-25', emoji: '&#127881;'},
      {name: 'Claw Machine for Kids', url: 'https://www.amazon.com/s?k=claw+machine+kids&tag=spunkart-20', price: '$30-50', emoji: '&#127922;'}
    ];
    const p = products[Math.floor(Math.random() * products.length)];

    overlay = document.createElement('div');
    overlay.id = 'rewarded-ad-overlay';
    Object.assign(overlay.style, {
      position:'fixed',top:'0',left:'0',width:'100%',height:'100%',
      background:'rgba(0,0,0,0.9)',display:'flex',flexDirection:'column',
      alignItems:'center',justifyContent:'center',zIndex:'10001'
    });

    let remaining = 5;
    overlay.innerHTML = `<div style="text-align:center;max-width:320px">
      <div style="color:#FFD700;font-size:18px;font-weight:bold;margin-bottom:16px">&#127775; Free Credit in ${remaining}s</div>
      <div style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:16px;padding:24px;margin-bottom:16px">
        <div style="font-size:40px;margin-bottom:12px">${p.emoji}</div>
        <div style="color:#FFD700;font-size:18px;font-weight:bold;margin-bottom:8px">${p.name}</div>
        <div style="color:rgba(255,255,255,0.7);font-size:14px;margin-bottom:16px">Starting at ${p.price}</div>
        <a href="${p.url}" target="_blank" rel="noopener" style="display:inline-block;background:#f59e0b;color:#000;padding:10px 24px;border-radius:8px;font-weight:bold;text-decoration:none">Shop on Amazon</a>
      </div>
      <div id="rewarded-timer" style="color:rgba(255,255,255,0.6);font-size:14px;margin-bottom:8px">${remaining}s remaining</div>
      <div style="width:200px;height:4px;background:rgba(255,255,255,0.1);border-radius:2px;margin:0 auto">
        <div id="rewarded-progress" style="height:100%;background:#FFD700;border-radius:2px;width:0%;transition:width 1s linear"></div>
      </div>
    </div>`;
    document.body.appendChild(overlay);

    const timer = setInterval(() => {
      remaining--;
      const timerEl = document.getElementById('rewarded-timer');
      const prog = document.getElementById('rewarded-progress');
      if (timerEl) timerEl.textContent = remaining > 0 ? `${remaining}s remaining` : '';
      if (prog) prog.style.width = `${((5 - remaining) / 5) * 100}%`;

      if (remaining <= 0) {
        clearInterval(timer);
        addCredits(1);
        SoundFX.coinInsert();
        showToast('+1 free credit earned!', 'success');
        overlay.remove();
      }
    }, 1000);
  }

  function renderAdBanner(container) {
    if (!container) return;
    container.innerHTML = `
      <div class="ad-banner" style="background:rgba(255,255,255,0.03);border:1px dashed rgba(255,255,255,0.15);border-radius:8px;padding:20px;text-align:center;margin:15px 0">
        <div style="color:rgba(255,255,255,0.3);font-size:11px;text-transform:uppercase;letter-spacing:1px">Advertisement</div>
      </div>
    `;
  }

  // ‚îÄ‚îÄ Amazon Affiliate ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function amazonLink(asin, title) {
    return `https://www.amazon.com/dp/${asin}?tag=${AMAZON_TAG}&linkCode=ogi&th=1`;
  }

  const AMAZON_PRODUCTS = [
    { asin: 'B0BLJWMHQS', title: 'Pizza Stone for Oven', price: 29.99, img: '' },
    { asin: 'B07ZH5B5HK', title: 'Ooni Koda 12 Pizza Oven', price: 399.00, img: '' },
    { asin: 'B08ZN3864F', title: 'Pizza Peel Set', price: 24.99, img: '' },
    { asin: 'B09XKZG7H4', title: 'Pizza Dough Proofing Box', price: 19.99, img: '' },
    { asin: 'B07P6BSHGF', title: 'Pizza Cutter Rocker', price: 14.99, img: '' },
    { asin: 'B0184CEZ0G', title: 'Infrared Thermometer', price: 22.99, img: '' }
  ];

  function renderAmazonSidebar(container) {
    if (!container) return;
    container.innerHTML = `
      <div class="amazon-sidebar">
        <h4 style="color:#FFD700;margin:0 0 12px">Can't Wait? Buy It Now</h4>
        <div class="amazon-grid">
          ${AMAZON_PRODUCTS.map(p => `
            <a href="${amazonLink(p.asin, p.title)}" target="_blank" rel="noopener" class="amazon-item">
              <div class="amazon-item-img" style="background:rgba(255,255,255,0.05);height:80px;border-radius:8px;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,0.2);font-size:24px">\uD83C\uDF55</div>
              <div class="amazon-item-title">${p.title}</div>
              <div class="amazon-item-price">$${p.price.toFixed(2)}</div>
            </a>
          `).join('')}
        </div>
      </div>
    `;
  }

  function getPrizeAmazonLink(prizeName) {
    const search = encodeURIComponent(prizeName);
    return `https://www.amazon.com/s?k=${search}&tag=${AMAZON_TAG}`;
  }

  // ‚îÄ‚îÄ Machine Selection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  let selectedMachineId = null;

  function renderMachines(filterTier = null) {
    const container = $('#machine-grid');
    if (!container) return;

    const machines = filterTier ? MACHINES.filter(m => m.tier === filterTier) : MACHINES;

    container.innerHTML = machines.map(m => `
      <div class="machine-card" onclick="ClawApp.selectMachine('${m.id}')" data-tier="${m.tier}">
        <div class="machine-tier-badge" style="background:${m.tierColor}">${m.tierLabel}</div>
        <div class="machine-icon" style="font-size:48px;text-align:center;margin:12px 0">\uD83E\uDEA4</div>
        <h3 class="machine-name">${m.name}</h3>
        <p class="machine-desc">${m.description}</p>
        <div class="machine-prizes-count">${m.prizes.length} prizes</div>
        <div class="machine-prize-range">$${Math.min(...m.prizes.map(p => p.value))} - $${Math.max(...m.prizes.map(p => p.value))}</div>
        <button class="btn btn-glow" style="width:100%;margin-top:10px">Play Now</button>
      </div>
    `).join('');

    // Tier filter buttons
    const filterContainer = $('#machine-filters');
    if (filterContainer) {
      const tiers = ['all', 'breadstick', 'slice', 'halfpie', 'fullpie', 'supreme'];
      const tierLabels = { all: 'All', breadstick: 'Breadstick', slice: 'Slice', halfpie: 'Half Pie', fullpie: 'Full Pie', supreme: 'Supreme' };
      filterContainer.innerHTML = tiers.map(t => `
        <button class="filter-btn ${(!filterTier && t === 'all') || filterTier === t ? 'active' : ''}"
                onclick="ClawApp.filterMachines('${t === 'all' ? '' : t}')">${tierLabels[t]}</button>
      `).join('');
    }
  }

  function filterMachines(tier) {
    renderMachines(tier || null);
  }

  function selectMachine(id) {
    selectedMachineId = id;
    lsSet('claw_selected_machine', id);
    SoundFX.buttonClick();
    navigate('play');
    renderPlayPage();
    initClawEngine(id);
  }

  function initClawEngine(machineId) {
    const machine = MACHINES.find(m => m.id === machineId) || MACHINES[0];

    if (engineInitialized && window.ClawEngine) {
      window.ClawEngine.destroy();
      engineInitialized = false;
    }

    // Wait for container to have actual dimensions before initializing
    function tryInit() {
      const container = document.getElementById('play-canvas');
      if (!container || container.clientWidth === 0 || container.clientHeight === 0) {
        requestAnimationFrame(tryInit);
        return;
      }

      try {
        if (!window.ClawEngine) {
          console.warn('[claw.pizza] ClawEngine not available');
          return;
        }

        window.ClawEngine.init('play-canvas', machine.tier);

        window.ClawEngine.setOnResult((result) => {
          if (result.won && result.prize) {
            SoundFX.win();
            const prize = machine.prizes[Math.floor(Math.random() * machine.prizes.length)];
            recordWin(prize.name, prize.value, machine.tier);
            showWinModal(prize, machine);
          } else {
            SoundFX.lose();
            showToast('So close! The claw slipped! Try again!', 'info');
          }
          updateCreditDisplays();
        });

        engineInitialized = true;
        updateCreditDisplays();
        console.log('[claw.pizza] 3D engine initialized for', machine.name, '(', machine.tier, ')');
      } catch (e) {
        console.error('[claw.pizza] Failed to init 3D engine:', e);
        engineInitialized = false;
      }
    }

    requestAnimationFrame(tryInit);
  }

  function renderPlayPage() {
    // Update HUD elements on the play page
    const hudName = $('#hud-machine-name');
    const hudCredits = $('#hud-credit-count');

    const id = selectedMachineId || ls('claw_selected_machine') || 'claw-1';
    const machine = MACHINES.find(m => m.id === id) || MACHINES[0];
    selectedMachineId = machine.id;

    if (hudName) hudName.textContent = machine.name;
    if (hudCredits) hudCredits.textContent = getCredits();

    // Update the grab button to also start the game if in IDLE state
    const grabBtn = $('#btn-grab');
    if (grabBtn) {
      grabBtn.textContent = 'TAP TO AIM';
      grabBtn.onclick = function() {
        if (window.ClawEngine && engineInitialized) {
          const state = window.ClawEngine.getCurrentState();
          if (state === 'IDLE') {
            playMachine(machine.id);
          } else if (state === 'MOVING') {
            // Instant drop shortcut from button
            window.ClawEngine.dropClaw();
          }
        } else {
          playMachine(machine.id);
        }
      };
    }
  }

  let engineInitialized = false;

  function playMachine(id) {
    const machine = MACHINES.find(m => m.id === id) || MACHINES[0];

    // Check if 3D engine is initialized and ready
    if (window.ClawEngine && engineInitialized) {
      // Use the 3D engine's startGame which handles credits via its own spendCredits
      const started = window.ClawEngine.startGame();
      if (!started) {
        const state = window.ClawEngine.getCurrentState();
        if (state !== 'IDLE') {
          showToast('Game already in progress!', 'info');
          return;
        }
        showToast('Not enough credits!', 'error');
        SoundFX.lose();
        openBuyCreditsModal();
        return;
      }
      SoundFX.coinInsert();
      updateStreak();
      recordPlay(machine.tier);
      updateCreditDisplays();
      showToast('Tap where you want the claw to drop!', 'info');
      return;
    }

    // Fallback: no 3D engine, use instant play
    if (!spendCredits(1)) {
      showToast('Not enough credits!', 'error');
      SoundFX.lose();
      openBuyCreditsModal();
      return;
    }

    SoundFX.coinInsert();
    updateStreak();

    const tierChances = { breadstick: 0.40, slice: 0.30, halfpie: 0.22, fullpie: 0.15, supreme: 0.08 };
    const winChance = tierChances[machine.tier] || 0.25;

    const refCount = ls('claw_ref_count_cache', 0);
    const refTier = getReferralTier(refCount);
    const bonusMult = 1 + refTier.bonus;

    const isWin = Math.random() < (winChance * bonusMult);

    recordPlay(machine.tier);

    if (isWin) {
      const prize = machine.prizes[Math.floor(Math.random() * machine.prizes.length)];
      setTimeout(() => {
        SoundFX.win();
        recordWin(prize.name, prize.value, machine.tier);
        showWinModal(prize, machine);
      }, 500);
    } else {
      setTimeout(() => {
        SoundFX.lose();
        showToast('So close! Try again!', 'info');
      }, 500);
    }

    updateCreditDisplays();
  }

  function showWinModal(prize, machine) {
    let modal = $('#win-modal');
    if (modal) modal.remove();

    modal = document.createElement('div');
    modal.id = 'win-modal';
    Object.assign(modal.style, {
      position: 'fixed', top: '0', left: '0', width: '100%', height: '100%',
      background: 'rgba(0,0,0,0.9)', display: 'flex', alignItems: 'center',
      justifyContent: 'center', zIndex: '9999', padding: '20px', boxSizing: 'border-box'
    });

    modal.innerHTML = `
      <div style="background:linear-gradient(135deg,#1a1a2e,#12121a);border:2px solid #FFD700;border-radius:20px;padding:30px;max-width:400px;width:100%;text-align:center">
        <div style="font-size:64px;margin-bottom:10px">\uD83C\uDF89</div>
        <h2 style="color:#FFD700;margin:0 0 8px">YOU WON!</h2>
        <div style="font-size:28px;font-weight:bold;color:#fff;margin-bottom:4px">${prize.name}</div>
        <div style="color:#22c55e;font-size:22px;font-weight:bold;margin-bottom:4px">$${prize.value} Value</div>
        <div style="color:rgba(255,255,255,0.5);font-size:13px;margin-bottom:16px">${prize.description}</div>
        <div style="color:${machine.tierColor};font-weight:bold;font-size:14px;margin-bottom:20px">${machine.tierLabel} Machine: ${machine.name}</div>
        <a href="${getPrizeAmazonLink(prize.name)}" target="_blank" rel="noopener" style="display:block;background:#f59e0b;color:#000;padding:10px;border-radius:8px;font-weight:bold;text-decoration:none;margin-bottom:10px">
          Can't Wait? Buy It Now on Amazon
        </a>
        <button class="btn btn-glow" onclick="ClawApp.shareWin('${prize.name.replace(/'/g, "\\'")}',${prize.value},'${machine.tier}')" style="width:100%;margin-bottom:8px">
          Share on X (+2 Credits)
        </button>
        <button class="btn" onclick="document.getElementById('win-modal').remove()" style="width:100%">Close</button>
      </div>
    `;
    document.body.appendChild(modal);
  }

  // ‚îÄ‚îÄ Prizes Page ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function renderPrizesPage() {
    const container = $('#prizes-list');
    if (!container) return;

    let html = '';
    const tiers = ['breadstick', 'slice', 'halfpie', 'fullpie', 'supreme'];
    const tierLabels = { breadstick: 'Breadstick', slice: 'Slice', halfpie: 'Half Pie', fullpie: 'Full Pie', supreme: 'Supreme' };

    tiers.forEach(tier => {
      const machines = MACHINES.filter(m => m.tier === tier);
      const allPrizes = machines.flatMap(m => m.prizes.map(p => ({ ...p, machine: m.name })));
      if (allPrizes.length === 0) return;

      html += `<h3 style="color:${machines[0].tierColor};margin-top:20px">${tierLabels[tier]} Tier</h3>`;
      html += '<div class="prizes-grid">';
      allPrizes.forEach(p => {
        html += `
          <div class="prize-card">
            <div class="prize-icon">\uD83C\uDF81</div>
            <div class="prize-name">${p.name}</div>
            <div class="prize-value">$${p.value}</div>
            <div class="prize-desc">${p.description}</div>
            <div class="prize-machine">From: ${p.machine}</div>
            <a href="${getPrizeAmazonLink(p.name)}" target="_blank" rel="noopener" class="btn btn-sm" style="margin-top:8px">Buy on Amazon</a>
          </div>
        `;
      });
      html += '</div>';
    });

    container.innerHTML = html;
  }

  // ‚îÄ‚îÄ Leaderboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  async function seedLeaderboard() {
    const existing = await fbGet('leaderboard');
    if (existing && Object.keys(existing).length > 3) return;

    const names = ['PizzaKing99', 'ClawMaster', 'SliceQueen', 'DoughBoy420', 'CrustPunk',
      'PepperoniPro', 'MozzarellaMax', 'BasilBoss', 'OvenHero', 'ToppingTitan',
      'SauceGod', 'CheesyChamp', 'PieMaster', 'NapoliNinja', 'WoodFiredWill'];

    const entries = {};
    names.forEach(name => {
      const id = 'player_' + generateId(8);
      entries[id] = {
        name,
        wins: Math.floor(Math.random() * 50) + 1,
        biggestWin: Math.floor(Math.random() * 500) + 5,
        plays: Math.floor(Math.random() * 200) + 10,
        lastActive: Date.now() - Math.floor(Math.random() * 604800000)
      };
    });

    await fbSet('leaderboard', entries);
  }

  async function updateLeaderboard(type, value) {
    const userId = getUserId();
    const existing = await fbGet(`leaderboard/${userId}`);
    const data = existing || { name: getPlayerName(), wins: 0, biggestWin: 0, plays: 0, lastActive: 0 };

    data.lastActive = Date.now();
    data.name = getPlayerName();

    if (type === 'win') {
      data.wins = (data.wins || 0) + 1;
      if (value > (data.biggestWin || 0)) data.biggestWin = value;
    }
    data.plays = (data.plays || 0) + 1;

    await fbSet(`leaderboard/${userId}`, data);
  }

  async function renderLeaderboard(category = 'wins', timeFilter = 'all') {
    const container = $('#leaderboard-table');
    if (!container) return;

    await seedLeaderboard();
    const data = await fbGet('leaderboard');
    if (!data) { container.innerHTML = '<div style="text-align:center;color:rgba(255,255,255,0.5)">Loading...</div>'; return; }

    let entries = Object.entries(data).map(([id, d]) => ({ id, ...d }));

    // Time filter
    const now = Date.now();
    if (timeFilter === 'today') entries = entries.filter(e => now - e.lastActive < 86400000);
    if (timeFilter === 'week') entries = entries.filter(e => now - e.lastActive < 604800000);

    // Sort by category
    if (category === 'wins') entries.sort((a, b) => (b.wins || 0) - (a.wins || 0));
    if (category === 'biggestWin') entries.sort((a, b) => (b.biggestWin || 0) - (a.biggestWin || 0));
    if (category === 'plays') entries.sort((a, b) => (b.plays || 0) - (a.plays || 0));

    entries = entries.slice(0, 50);
    const userId = getUserId();
    const medals = ['\uD83E\uDD47', '\uD83E\uDD48', '\uD83E\uDD49'];

    // Render filters
    const filtersEl = $('#leaderboard-filters');
    if (filtersEl) {
      filtersEl.innerHTML = `
        <div class="lb-categories" style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap">
          <button class="filter-btn ${category === 'wins' ? 'active' : ''}" onclick="ClawApp.renderLeaderboard('wins','${timeFilter}')">Most Wins</button>
          <button class="filter-btn ${category === 'biggestWin' ? 'active' : ''}" onclick="ClawApp.renderLeaderboard('biggestWin','${timeFilter}')">Biggest Win</button>
          <button class="filter-btn ${category === 'plays' ? 'active' : ''}" onclick="ClawApp.renderLeaderboard('plays','${timeFilter}')">Most Plays</button>
        </div>
        <div class="lb-time" style="display:flex;gap:8px;margin-bottom:15px">
          <button class="filter-btn ${timeFilter === 'today' ? 'active' : ''}" onclick="ClawApp.renderLeaderboard('${category}','today')">Today</button>
          <button class="filter-btn ${timeFilter === 'week' ? 'active' : ''}" onclick="ClawApp.renderLeaderboard('${category}','week')">This Week</button>
          <button class="filter-btn ${timeFilter === 'all' ? 'active' : ''}" onclick="ClawApp.renderLeaderboard('${category}','all')">All Time</button>
        </div>
      `;
    }

    const catLabel = { wins: 'Wins', biggestWin: 'Biggest Win', plays: 'Plays' };

    container.innerHTML = `
      <table class="lb-table" style="width:100%;border-collapse:collapse">
        <thead>
          <tr style="color:rgba(255,255,255,0.5);font-size:12px;text-transform:uppercase">
            <th style="padding:8px;text-align:left">#</th>
            <th style="padding:8px;text-align:left">Player</th>
            <th style="padding:8px;text-align:right">${catLabel[category]}</th>
          </tr>
        </thead>
        <tbody>
          ${entries.map((e, i) => {
            const isMe = e.id === userId;
            const rank = i < 3 ? medals[i] : (i + 1);
            const val = category === 'biggestWin' ? `$${e.biggestWin || 0}` : (e[category] || 0);
            return `
              <tr style="border-bottom:1px solid rgba(255,255,255,0.05);${isMe ? 'background:rgba(255,215,0,0.1)' : ''}${i < 3 ? ';font-weight:bold' : ''}">
                <td style="padding:10px 8px;font-size:${i < 3 ? '20px' : '14px'}">${rank}</td>
                <td style="padding:10px 8px;color:${isMe ? '#FFD700' : '#fff'}">${e.name}${isMe ? ' (You)' : ''}</td>
                <td style="padding:10px 8px;text-align:right;color:${i < 3 ? '#FFD700' : 'rgba(255,255,255,0.7)'}">${val}</td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    `;
  }

  // ‚îÄ‚îÄ Profile Page ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function renderProfile() {
    const container = $('#profile-content');
    if (!container) return;

    const stats = ls('claw_stats', { plays: 0, wins: 0, biggestWin: 0 });
    const history = ls('claw_play_history', []);
    const purchases = ls('claw_purchases', []);
    const streak = getStreakData();

    const soundEnabled = ls('claw_sound_enabled', true);
    const notifications = ls('claw_notifications', true);
    const clientSeed = ls('claw_client_seed', '');

    container.innerHTML = `
      <div class="profile-section">
        <h2 style="color:#FFD700">${getPlayerName()}</h2>
        <p style="color:rgba(255,255,255,0.5);font-size:12px">ID: ${getUserId()}</p>
      </div>

      <div class="profile-stats" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:12px;margin:20px 0">
        <div class="stat-card"><div class="stat-value">${stats.plays}</div><div class="stat-label">Total Plays</div></div>
        <div class="stat-card"><div class="stat-value">${stats.wins}</div><div class="stat-label">Total Wins</div></div>
        <div class="stat-card"><div class="stat-value">${getCredits()}</div><div class="stat-label">Credits</div></div>
        <div class="stat-card"><div class="stat-value">${streak.count}</div><div class="stat-label">Day Streak</div></div>
      </div>

      <div id="profile-referral-stats" style="margin:20px 0"></div>

      <div style="margin:20px 0;padding:16px;background:rgba(255,215,0,0.08);border:1px solid rgba(255,215,0,0.2);border-radius:12px;text-align:center">
        <p style="color:#FFD700;margin:0 0 10px;font-weight:600">Have a promo code?</p>
        <button class="btn btn-glow" onclick="ClawApp.promptPromoCode()" style="width:100%;max-width:260px">\u{1F3AB} Redeem Promo Code</button>
      </div>

      <div class="profile-settings" style="margin:20px 0">
        <h3 style="color:#FFD700;margin-bottom:12px">Settings</h3>
        <div class="setting-row" style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.1)">
          <span>Display Name</span>
          <input type="text" value="${getPlayerName()}" id="profile-name-input"
            style="background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);border-radius:6px;padding:6px 10px;color:#fff;width:150px"
            onchange="ClawApp._setPlayerName(this.value)" />
        </div>
        <div class="setting-row" style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.1)">
          <span>Sound Effects</span>
          <button class="btn btn-sm" onclick="ClawApp._toggleSound()" id="sound-toggle-btn">${soundEnabled ? 'ON' : 'OFF'}</button>
        </div>
        <div class="setting-row" style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.1)">
          <span>Notifications</span>
          <button class="btn btn-sm" onclick="ClawApp._toggleNotifications()" id="notif-toggle-btn">${notifications ? 'ON' : 'OFF'}</button>
        </div>
        <div class="setting-row" style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.1)">
          <span>Client Seed</span>
          <input type="text" value="${clientSeed}" placeholder="Enter custom seed"
            style="background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);border-radius:6px;padding:6px 10px;color:#fff;width:150px"
            onchange="localStorage.setItem('claw_client_seed',JSON.stringify(this.value))" />
        </div>
      </div>

      <div class="profile-history" style="margin:20px 0">
        <h3 style="color:#FFD700;margin-bottom:12px">Play History</h3>
        <div class="history-list" style="max-height:400px;overflow-y:auto">
          ${history.length === 0 ? '<p style="color:rgba(255,255,255,0.4)">No plays yet. Go grab a prize!</p>' : ''}
          ${history.slice(0, 50).map(h => `
            <div class="history-item" style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.05);font-size:13px">
              <span style="color:${h.result === 'win' ? '#22c55e' : 'rgba(255,255,255,0.4)'}">
                ${h.result === 'win' ? `Won: ${h.prize}` : 'Miss'}
              </span>
              <span style="color:rgba(255,255,255,0.3)">${timeAgo(h.time)}</span>
            </div>
          `).join('')}
        </div>
      </div>

      ${purchases.length > 0 ? `
        <div class="profile-purchases" style="margin:20px 0">
          <h3 style="color:#FFD700;margin-bottom:12px">Purchase History</h3>
          ${purchases.map(p => `
            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.05);font-size:13px">
              <span>${p.pack} - ${p.credits} credits</span>
              <span style="color:rgba(255,255,255,0.3)">$${p.price.toFixed(2)} - ${timeAgo(p.time)}</span>
            </div>
          `).join('')}
        </div>
      ` : ''}

      <div id="challenges-display" style="margin:20px 0"></div>
    `;

    renderReferralStats($('#profile-referral-stats'));
    renderChallenges();
  }

  function _setPlayerName(name) {
    if (name && name.trim().length > 0) {
      lsSet('claw_player_name', name.trim().slice(0, 20));
      showToast('Name updated!', 'success');
    }
  }

  function _toggleSound() {
    soundsEnabled = !soundsEnabled;
    lsSet('claw_sound_enabled', soundsEnabled);
    const btn = $('#sound-toggle-btn');
    if (btn) btn.textContent = soundsEnabled ? 'ON' : 'OFF';
    showToast(`Sound ${soundsEnabled ? 'enabled' : 'disabled'}`, 'info');
  }

  function _toggleNotifications() {
    const current = ls('claw_notifications', true);
    lsSet('claw_notifications', !current);
    const btn = $('#notif-toggle-btn');
    if (btn) btn.textContent = !current ? 'ON' : 'OFF';
    showToast(`Notifications ${!current ? 'enabled' : 'disabled'}`, 'info');
  }

  // ‚îÄ‚îÄ Admin Panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  let adminAuthed = false;

  function renderAdmin() {
    const container = $('#admin-content');
    if (!container) return;

    if (!adminAuthed && ls('claw_admin_auth') !== true) {
      container.innerHTML = `
        <div style="max-width:300px;margin:40px auto;text-align:center">
          <h2 style="color:#FFD700;margin-bottom:16px">Admin Login</h2>
          <input type="password" id="admin-password" placeholder="Password"
            style="width:100%;padding:10px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:#fff;margin-bottom:12px;box-sizing:border-box" />
          <button class="btn btn-glow" onclick="ClawApp._adminLogin()" style="width:100%">Login</button>
        </div>
      `;
      return;
    }

    renderAdminDashboard(container);
  }

  function _adminLogin() {
    const input = $('#admin-password');
    if (input && input.value === ADMIN_PASSWORD) {
      adminAuthed = true;
      lsSet('claw_admin_auth', true);
      renderAdmin();
    } else {
      showToast('Wrong password', 'error');
    }
  }

  async function renderAdminDashboard(container) {
    const waitlist = await fbGet('waitlist');
    const leaderboard = await fbGet('leaderboard');
    const wins = await fbGet('wins');
    const visitors = await fbGet('visitors');

    const waitlistCount = waitlist ? Object.keys(waitlist).length : 0;
    const playerCount = leaderboard ? Object.keys(leaderboard).length : 0;
    const winCount = wins ? Object.keys(wins).length : 0;
    const visitorCount = visitors?.count || 0;

    container.innerHTML = `
      <div style="max-width:800px;margin:0 auto">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <h2 style="color:#FFD700">Admin Dashboard</h2>
          <button class="btn btn-sm" onclick="localStorage.removeItem('claw_admin_auth');location.reload()">Logout</button>
        </div>

        <div class="admin-stats" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:24px">
          <div class="stat-card"><div class="stat-value">${visitorCount}</div><div class="stat-label">Total Visitors</div></div>
          <div class="stat-card"><div class="stat-value">${playerCount}</div><div class="stat-label">Players</div></div>
          <div class="stat-card"><div class="stat-value">${winCount}</div><div class="stat-label">Total Wins</div></div>
          <div class="stat-card"><div class="stat-value">${waitlistCount}</div><div class="stat-label">Waitlist</div></div>
        </div>

        <div style="margin-bottom:24px">
          <h3 style="color:#FFD700;margin-bottom:12px">Machine Controls</h3>
          <div style="display:grid;gap:8px">
            ${MACHINES.map(m => {
              const disabled = ls(`claw_machine_disabled_${m.id}`, false);
              return `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:rgba(255,255,255,0.03);border-radius:8px">
                  <span>${m.name} (${m.tierLabel})</span>
                  <button class="btn btn-sm" onclick="ClawApp._toggleMachine('${m.id}')" style="background:${disabled ? '#ef4444' : '#22c55e'}">
                    ${disabled ? 'Disabled' : 'Enabled'}
                  </button>
                </div>
              `;
            }).join('')}
          </div>
        </div>

        <div style="margin-bottom:24px">
          <h3 style="color:#FFD700;margin-bottom:12px">Prize Management</h3>
          <div style="display:flex;gap:8px;margin-bottom:12px">
            <input type="text" id="admin-prize-name" placeholder="Prize name" style="flex:2;padding:8px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:#fff" />
            <input type="number" id="admin-prize-value" placeholder="Value" style="flex:1;padding:8px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:#fff" />
            <select id="admin-prize-machine" style="flex:1;padding:8px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:#fff">
              ${MACHINES.map(m => `<option value="${m.id}">${m.name}</option>`).join('')}
            </select>
            <button class="btn btn-sm btn-glow" onclick="ClawApp._addAdminPrize()">Add</button>
          </div>
          <div id="admin-prizes-list">Loading...</div>
        </div>

        <div style="margin-bottom:24px">
          <h3 style="color:#FFD700;margin-bottom:12px">Recent Players</h3>
          <div id="admin-players-list" style="max-height:300px;overflow-y:auto">
            ${leaderboard ? Object.entries(leaderboard).slice(0, 20).map(([id, p]) => `
              <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.05);font-size:13px">
                <span>${p.name || id}</span>
                <span style="color:rgba(255,255,255,0.4)">${p.plays || 0} plays, ${p.wins || 0} wins</span>
              </div>
            `).join('') : '<p>No players yet</p>'}
          </div>
        </div>

        <div>
          <h3 style="color:#FFD700;margin-bottom:12px">Revenue Tracking</h3>
          <div style="background:rgba(255,255,255,0.03);padding:16px;border-radius:12px">
            <div style="display:flex;justify-content:space-between;margin-bottom:8px">
              <span>Credit Pack Sales</span><span style="color:#22c55e">Coming Soon</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:8px">
              <span>VIP Subscriptions</span><span style="color:#22c55e">Coming Soon</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:8px">
              <span>Ad Revenue</span><span style="color:#22c55e">Coming Soon</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:8px">
              <span>Amazon Affiliate</span><span style="color:#22c55e">Coming Soon</span>
            </div>
          </div>
        </div>
      </div>
    `;

    loadAdminPrizes();
  }

  async function loadAdminPrizes() {
    const container = $('#admin-prizes-list');
    if (!container) return;
    const prizes = await fbGet('admin/prizes');
    if (!prizes || Object.keys(prizes).length === 0) {
      container.innerHTML = '<p style="color:rgba(255,255,255,0.4)">No custom prizes added yet.</p>';
      return;
    }
    container.innerHTML = Object.entries(prizes).map(([id, p]) => `
      <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.05);font-size:13px">
        <span>${p.name} - $${p.value} (${p.machine})</span>
        <button class="btn btn-sm" style="background:#ef4444" onclick="ClawApp._deleteAdminPrize('${id}')">Delete</button>
      </div>
    `).join('');
  }

  async function _addAdminPrize() {
    const name = $('#admin-prize-name')?.value?.trim();
    const value = parseFloat($('#admin-prize-value')?.value);
    const machine = $('#admin-prize-machine')?.value;
    if (!name || !value) { showToast('Fill in all fields', 'error'); return; }
    await fbPush('admin/prizes', { name, value, machine, added: Date.now() });
    showToast('Prize added!', 'success');
    loadAdminPrizes();
    if ($('#admin-prize-name')) $('#admin-prize-name').value = '';
    if ($('#admin-prize-value')) $('#admin-prize-value').value = '';
  }

  async function _deleteAdminPrize(id) {
    await fbDelete(`admin/prizes/${id}`);
    showToast('Prize deleted', 'info');
    loadAdminPrizes();
  }

  function _toggleMachine(id) {
    const key = `claw_machine_disabled_${id}`;
    const current = ls(key, false);
    lsSet(key, !current);
    renderAdmin();
  }

  // ‚îÄ‚îÄ Visitor Counter ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  async function trackVisitor() {
    const visited = ls('claw_visited');
    if (visited) {
      const data = await fbGet('visitors');
      const count = data?.count || 0;
      $$('[data-visitor-count]').forEach(el => { el.textContent = count.toLocaleString(); });
      return;
    }

    lsSet('claw_visited', true);
    const data = await fbGet('visitors');
    const newCount = (data?.count || 0) + 1;
    await fbSet('visitors', { count: newCount });
    $$('[data-visitor-count]').forEach(el => { el.textContent = newCount.toLocaleString(); });
  }

  // ‚îÄ‚îÄ Loading Screen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function hideLoadingScreen() {
    const loader = $('#loading-screen');
    if (!loader) return;

    const minTime = 1500;
    const startTime = window._clawLoadStart || Date.now();
    const elapsed = Date.now() - startTime;
    const remaining = Math.max(0, minTime - elapsed);

    setTimeout(() => {
      loader.style.opacity = '0';
      loader.style.transition = 'opacity 0.5s ease';
      setTimeout(() => {
        loader.style.display = 'none';
      }, 500);
    }, remaining);
  }

  // ‚îÄ‚îÄ Faucet Timer Loop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  let faucetTimerInterval = null;

  function startFaucetTimer() {
    updateFaucetDisplay();
    faucetTimerInterval = setInterval(updateFaucetDisplay, 1000);
  }

  // ‚îÄ‚îÄ Referral count cache ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  async function cacheReferralCount() {
    const count = await getReferralCount();
    lsSet('claw_ref_count_cache', count);
  }

  // ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  async function init() {
    window._clawLoadStart = window._clawLoadStart || Date.now();

    // Restore sound preference
    soundsEnabled = ls('claw_sound_enabled', true);

    // Init credits on first visit
    getCredits();

    // Navigation
    initNavigation();

    // Check referral param
    await checkReferralParam();
    await checkPromoCode();
    await checkVanityRef();

    // Update credit displays
    updateCreditDisplays();

    // Start faucet timer
    startFaucetTimer();

    // Update streak on visit
    updateStreak();

    // Render streak
    renderStreakDisplay();

    // Render challenges
    renderChallenges();

    // Start live feed
    startLiveFeed();

    // Track visitor
    trackVisitor();

    // Waitlist count
    updateWaitlistCount();

    // Cache referral count
    cacheReferralCount();

    // Render ad banners
    $$('[data-ad-banner]').forEach(el => renderAdBanner(el));
    $$('[data-amazon-sidebar]').forEach(el => renderAmazonSidebar(el));

    // Render referral stats if on home page
    renderReferralStats($('#home-referral-stats'));

    // Bind waitlist form
    const waitlistForm = $('#waitlist-form');
    if (waitlistForm) {
      waitlistForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const input = waitlistForm.querySelector('input[type="email"]');
        if (input) submitWaitlist(input.value);
      });
    }

    // Hide loading screen
    hideLoadingScreen();

    // Navigate to initial page
    const hash = window.location.hash.slice(1);
    if (hash) navigate(hash);

    console.log('[claw.pizza] App initialized');
  }

  // ‚îÄ‚îÄ Daily Spin Wheel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const SPIN_SEGMENTS = [10, 25, 50, 75, 100, 150, 250, 500];
  const SEGMENT_ANGLE = 360 / SPIN_SEGMENTS.length; // 45 deg each

  function canSpin() {
    const lastSpin = ls('claw_last_spin', 0);
    return Date.now() - lastSpin >= 24 * 60 * 60 * 1000;
  }

  function showSpinWheel() {
    const modal = document.getElementById('spin-modal');
    const btn = document.getElementById('spin-btn');
    const resultEl = document.getElementById('spin-result');
    const cooldownEl = document.getElementById('spin-cooldown');
    const wheel = document.getElementById('spin-wheel');

    // Reset wheel visual (no transition)
    wheel.style.transition = 'none';
    wheel.style.transform = 'rotate(0deg)';

    resultEl.textContent = '';
    cooldownEl.textContent = '';

    if (canSpin()) {
      btn.disabled = false;
      btn.textContent = 'SPIN!';
    } else {
      btn.disabled = true;
      btn.textContent = 'WAIT';
      const lastSpin = ls('claw_last_spin', 0);
      const remaining = 24 * 60 * 60 * 1000 - (Date.now() - lastSpin);
      const h = Math.floor(remaining / 3600000);
      const m = Math.floor((remaining % 3600000) / 60000);
      cooldownEl.textContent = `Next spin in ${h}h ${m}m`;
    }

    modal.classList.add('active');
  }

  function spinWheel() {
    if (!canSpin()) {
      showToast('You already spun today! Come back in 24 hours.', 'warning');
      return;
    }

    const btn = document.getElementById('spin-btn');
    const wheel = document.getElementById('spin-wheel');
    const resultEl = document.getElementById('spin-result');
    const cooldownEl = document.getElementById('spin-cooldown');

    btn.disabled = true;
    btn.textContent = '...';
    resultEl.textContent = '';

    // Pick random segment
    const segmentIndex = Math.floor(Math.random() * SPIN_SEGMENTS.length);
    const prize = SPIN_SEGMENTS[segmentIndex];

    // Calculate target rotation:
    // Wheel spins clockwise. The pointer is at top (0deg / 360deg).
    // Segment 0 covers 0-45deg from top. We want the winning segment center under the pointer.
    // Center of segment i is at i * 45 + 22.5 degrees from start.
    // We rotate CW, so target = fullSpins + (360 - segmentCenter) to land that segment at top.
    const fullSpins = 5 + Math.floor(Math.random() * 3); // 5-7 full rotations
    const segmentCenter = segmentIndex * SEGMENT_ANGLE + SEGMENT_ANGLE / 2;
    const targetDeg = fullSpins * 360 + (360 - segmentCenter);

    // Reset first, then spin
    wheel.style.transition = 'none';
    wheel.style.transform = 'rotate(0deg)';

    // Force reflow
    void wheel.offsetHeight;

    wheel.style.transition = 'transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99)';
    wheel.style.transform = `rotate(${targetDeg}deg)`;

    // After spin completes
    setTimeout(() => {
      // Award credits
      addCredits(prize);
      lsSet('claw_last_spin', Date.now());

      resultEl.textContent = `You won ${prize} credits!`;
      cooldownEl.textContent = 'Come back tomorrow for another spin!';
      btn.textContent = 'DONE';
      showToast(`Daily Spin: +${prize} credits!`, 'success');

      // Log to Firebase
      const userId = getUserId();
      fbPush('spins', {
        userId: userId,
        prize: prize,
        timestamp: Date.now(),
        date: new Date().toISOString()
      });

    }, 4200);
  }

  // ‚îÄ‚îÄ Public API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  window.ClawApp = {
    init,
    navigate,
    playMachine,
    selectMachine,
    filterMachines,
    buyCredits: openBuyCreditsModal,
    claimFaucet,
    claimStreak,
    claimChallenge,
    shareWin,
    copyReferralLink,
    redeemPromo,
    checkPromoCode,
    promptPromoCode,
    showRewardedAd,
    submitWaitlist,
    spinWheel,
    canSpin,
    showSpinWheel,
    renderLeaderboard,
    renderMachines,

    // Internal but needed by inline onclick handlers
    _selectPack,
    _showCardForm,
    _showBTCPay,
    _processCardPayment,
    _mockSubscribe,
    _adminLogin,
    _addAdminPrize,
    _deleteAdminPrize,
    _toggleMachine,
    _setPlayerName,
    _toggleSound,
    _toggleNotifications,
    _toast: showToast,

    // Expose for 3D engine integration
    getCredits,
    addCredits,
    spendCredits,
    updateCreditDisplays,
    recordWin,
    recordPlay,
    showToast,
    SoundFX,
    MACHINES,
    getUserId,
    getPlayerName,
    initClawEngine,

    // Expose constants
    REF_TIERS,
    CREDIT_PACKS,
    AMAZON_TAG,
    BTC_ADDRESS,
    PROMO_CODES,
    VANITY_REFS
  };

  // Auto-init on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

})();

</script>
<!-- Daily Spin Wheel Modal -->
<div class="spin-modal-overlay" id="spin-modal">
  <div class="spin-modal">
    <button class="spin-close" onclick="document.getElementById('spin-modal').classList.remove('active')">&times;</button>
    <h2>&#x1F3B0; Daily Spin</h2>
    <p class="spin-subtitle">Spin once per day for free credits!</p>
    <div class="spin-wheel-container">
      <div class="spin-pointer"></div>
      <div class="spin-wheel" id="spin-wheel">
        <div class="spin-wheel-label" style="transform: rotate(-67.5deg) translateY(-50%);">10</div>
        <div class="spin-wheel-label" style="transform: rotate(-22.5deg) translateY(-50%);">25</div>
        <div class="spin-wheel-label" style="transform: rotate(22.5deg) translateY(-50%);">50</div>
        <div class="spin-wheel-label" style="transform: rotate(67.5deg) translateY(-50%);">75</div>
        <div class="spin-wheel-label" style="transform: rotate(112.5deg) translateY(-50%);">100</div>
        <div class="spin-wheel-label" style="transform: rotate(157.5deg) translateY(-50%);">150</div>
        <div class="spin-wheel-label" style="transform: rotate(202.5deg) translateY(-50%);">250</div>
        <div class="spin-wheel-label" style="transform: rotate(247.5deg) translateY(-50%);">500</div>
      </div>
      <button class="spin-center-btn" id="spin-btn" onclick="ClawApp.spinWheel()">SPIN!</button>
    </div>
    <div class="spin-result" id="spin-result"></div>
    <div class="spin-cooldown" id="spin-cooldown"></div>
  </div>
</div>

<script>
// Service worker registration (ClawApp.init() is auto-called in its IIFE)
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/service-worker.js').catch(function(){});
}
</script>
</body>
</html>
